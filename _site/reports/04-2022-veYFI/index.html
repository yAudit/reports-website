

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">


  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  

  
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script>
  

  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>
  <script defer data-domain="reports.yAudit.dev" src="https://plausible.io/js/script.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>04-2022-veYFI | yAudit Reports</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="04-2022-veYFI" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="veYFI yAcademy Report" />
<meta property="og:description" content="veYFI yAcademy Report" />
<link rel="canonical" href="http://localhost:4000/reports/04-2022-veYFI/" />
<meta property="og:url" content="http://localhost:4000/reports/04-2022-veYFI/" />
<meta property="og:site_name" content="yAudit Reports" />
<meta property="og:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="twitter:title" content="04-2022-veYFI" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"veYFI yAcademy Report","headline":"04-2022-veYFI","image":"http://localhost:4000/assets/images/logo.png","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/yaudit-logo.jpg"}},"url":"http://localhost:4000/reports/04-2022-veYFI/"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <a class="skip-to-main" href="#main-content">Skip to main content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
    <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE -->
<symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link">
  <title id="svg-external-link-title">(external link)</title>
  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line>
</symbol>

  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="/" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
      
        <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">yAudit Reports</a></li><li class="nav-list-item"><a href="/reports/03-2022-Ohm/" class="nav-list-link">03-2022-Ohm</a></li><li class="nav-list-item"><a href="/reports/04-2022-Ohm-Bond/" class="nav-list-link">04-2022-Ohm-Bond</a></li><li class="nav-list-item active"><a href="/reports/04-2022-veYFI/" class="nav-list-link active">04-2022-veYFI</a></li><li class="nav-list-item"><a href="/reports/05-2022-OpenMEVRouter/" class="nav-list-link">05-2022-OpenMEV</a></li><li class="nav-list-item"><a href="/reports/08-2022-Bunni/" class="nav-list-link">08-2022-Bunni</a></li><li class="nav-list-item"><a href="/reports/08-2022-Timeless-Yield-Daddy/" class="nav-list-link">08-2022-Timeless-Yield-Daddy</a></li><li class="nav-list-item"><a href="/reports/09-2022-yFu-NFT/" class="nav-list-link">09-2022-yFu-NFT</a></li><li class="nav-list-item"><a href="/reports/10-2022-NounsDAO-Token-Buyer/" class="nav-list-link">10-2022-NounsDAO-Token-Buyer</a></li><li class="nav-list-item"><a href="/reports/12-2022-Gro-Protocol/" class="nav-list-link">12-2022-Gro-Protocol</a></li><li class="nav-list-item external">
      <a href="https://yaudit.dev/" class="nav-list-link external">
        yAudit Website
        <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg>
      </a>
    </li></ul>
      
      
    </nav>

    
    
      <footer class="site-footer">
        <!-- This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. -->
      </footer>
    
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      

        

        <div class="search">
          <div class="search-input-wrap">
            <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search yAudit Reports" aria-label="Search yAudit Reports" autocomplete="off">
            <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      
      
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <h1 class="no_toc" id="yacademy-veyfi-review">
        
        
          <a href="#yacademy-veyfi-review" class="anchor-heading" aria-labelledby="yacademy-veyfi-review"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> yAcademy veYFI review
        
        
      </h1>
    

<p><strong>Review Resources:</strong>
None provided beyond the code repository</p>

<p><strong>Residents:</strong></p>
<ul>
  <li>NibblerExpress</li>
  <li>Engn33r</li>
</ul>
      <h2 class="no_toc" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#review-summary" id="markdown-toc-review-summary">Review Summary</a></li>
  <li><a href="#scope" id="markdown-toc-scope">Scope</a></li>
  <li><a href="#code-evaluation-matrix" id="markdown-toc-code-evaluation-matrix">Code Evaluation Matrix</a></li>
  <li><a href="#findings-explanation" id="markdown-toc-findings-explanation">Findings Explanation</a></li>
  <li><a href="#high-findings" id="markdown-toc-high-findings">High Findings</a>    <ol>
      <li><a href="#1-high---incompatible-vote-delegation-engn33r" id="markdown-toc-1-high---incompatible-vote-delegation-engn33r">1. High - Incompatible Vote Delegation (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept" id="markdown-toc-proof-of-concept">Proof of concept</a></li>
          <li><a href="#impact" id="markdown-toc-impact">Impact</a></li>
          <li><a href="#recommendation" id="markdown-toc-recommendation">Recommendation</a></li>
          <li><a href="#developer-response" id="markdown-toc-developer-response">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#2-high---lock-1e-18-yfi-to-get-rewards-nibblerexpress" id="markdown-toc-2-high---lock-1e-18-yfi-to-get-rewards-nibblerexpress">2. High - Lock 1e-18 YFI to Get Rewards (NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-1" id="markdown-toc-proof-of-concept-1">Proof of concept</a></li>
          <li><a href="#impact-1" id="markdown-toc-impact-1">Impact</a></li>
          <li><a href="#recommendation-1" id="markdown-toc-recommendation-1">Recommendation</a></li>
          <li><a href="#developer-response-1" id="markdown-toc-developer-response-1">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#3-high---flash-loan-sybil-attack-to-boost-rewards-nibblerexpress" id="markdown-toc-3-high---flash-loan-sybil-attack-to-boost-rewards-nibblerexpress">3. High - Flash Loan Sybil Attack to Boost Rewards (NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-2" id="markdown-toc-proof-of-concept-2">Proof of concept</a></li>
          <li><a href="#impact-2" id="markdown-toc-impact-2">Impact</a></li>
          <li><a href="#recommendation-2" id="markdown-toc-recommendation-2">Recommendation</a></li>
          <li><a href="#developer-response-2" id="markdown-toc-developer-response-2">Developer Response</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#medium-findings" id="markdown-toc-medium-findings">Medium Findings</a>    <ol>
      <li><a href="#1-medium---incorrect-variables-in-getrewardfor-call-engn33r" id="markdown-toc-1-medium---incorrect-variables-in-getrewardfor-call-engn33r">1. Medium - Incorrect variables in getRewardFor call (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-3" id="markdown-toc-proof-of-concept-3">Proof of concept</a></li>
          <li><a href="#impact-3" id="markdown-toc-impact-3">Impact</a></li>
          <li><a href="#recommendation-3" id="markdown-toc-recommendation-3">Recommendation</a></li>
          <li><a href="#developer-response-3" id="markdown-toc-developer-response-3">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#2-medium---unclear-integration-of-vote-delegation-until-value-engn33r" id="markdown-toc-2-medium---unclear-integration-of-vote-delegation-until-value-engn33r">2. Medium - Unclear Integration of Vote Delegation Until Value (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-4" id="markdown-toc-proof-of-concept-4">Proof of concept</a></li>
          <li><a href="#impact-4" id="markdown-toc-impact-4">Impact</a></li>
          <li><a href="#recommendation-4" id="markdown-toc-recommendation-4">Recommendation</a></li>
          <li><a href="#developer-response-4" id="markdown-toc-developer-response-4">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#3-medium---force_withdraw-penalty-may-inadequately-deter-gamification-and-attacks-on-voting-engn33r-nibblerexpress" id="markdown-toc-3-medium---force_withdraw-penalty-may-inadequately-deter-gamification-and-attacks-on-voting-engn33r-nibblerexpress">3. Medium - <code class="language-plaintext highlighter-rouge">force_withdraw()</code> penalty may inadequately deter gamification and attacks on voting (engn33r, NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-5" id="markdown-toc-proof-of-concept-5">Proof of concept</a></li>
          <li><a href="#impact-5" id="markdown-toc-impact-5">Impact</a></li>
          <li><a href="#recommendation-5" id="markdown-toc-recommendation-5">Recommendation</a></li>
          <li><a href="#developer-response-5" id="markdown-toc-developer-response-5">Developer Response</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#low-findings" id="markdown-toc-low-findings">Low Findings</a>    <ol>
      <li><a href="#1-low---voting-delegation-is-missing-edge-case-checks-engn33r" id="markdown-toc-1-low---voting-delegation-is-missing-edge-case-checks-engn33r">1. Low - Voting delegation is missing edge case checks (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-6" id="markdown-toc-proof-of-concept-6">Proof of concept</a></li>
          <li><a href="#impact-6" id="markdown-toc-impact-6">Impact</a></li>
          <li><a href="#recommendation-6" id="markdown-toc-recommendation-6">Recommendation</a></li>
          <li><a href="#developer-response-6" id="markdown-toc-developer-response-6">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#2-low---sawtooth-wave-effect-from-computing-veyfi-balance-and-supply-using-different-time-scales-nibblerexpress" id="markdown-toc-2-low---sawtooth-wave-effect-from-computing-veyfi-balance-and-supply-using-different-time-scales-nibblerexpress">2. Low - Sawtooth Wave Effect from Computing veYFI Balance and Supply Using Different Time Scales (NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-7" id="markdown-toc-proof-of-concept-7">Proof of concept</a></li>
          <li><a href="#impact-7" id="markdown-toc-impact-7">Impact</a></li>
          <li><a href="#recommendation-7" id="markdown-toc-recommendation-7">Recommendation</a></li>
          <li><a href="#developer-response-7" id="markdown-toc-developer-response-7">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#3-low---equal-penalty-reward-distribution-not-incentive-aligned-engn33r-nibblerexpress" id="markdown-toc-3-low---equal-penalty-reward-distribution-not-incentive-aligned-engn33r-nibblerexpress">3. Low - Equal penalty reward distribution not incentive aligned (engn33r, NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-8" id="markdown-toc-proof-of-concept-8">Proof of concept</a></li>
          <li><a href="#impact-8" id="markdown-toc-impact-8">Impact</a></li>
          <li><a href="#recommendation-8" id="markdown-toc-recommendation-8">Recommendation</a></li>
          <li><a href="#developer-response-8" id="markdown-toc-developer-response-8">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#4-low---no-penalty-during-migration-engn33r" id="markdown-toc-4-low---no-penalty-during-migration-engn33r">4. Low - No penalty during migration (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-9" id="markdown-toc-proof-of-concept-9">Proof of concept</a></li>
          <li><a href="#impact-9" id="markdown-toc-impact-9">Impact</a></li>
          <li><a href="#recommendation-9" id="markdown-toc-recommendation-9">Recommendation</a></li>
          <li><a href="#developer-response-9" id="markdown-toc-developer-response-9">Developer Response</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#gas-savings-findings" id="markdown-toc-gas-savings-findings">Gas Savings Findings</a>    <ol>
      <li><a href="#1-gas---using-unchecked-engn33r" id="markdown-toc-1-gas---using-unchecked-engn33r">1. Gas - Using “unchecked” (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-10" id="markdown-toc-proof-of-concept-10">Proof of concept</a></li>
          <li><a href="#impact-10" id="markdown-toc-impact-10">Impact</a></li>
          <li><a href="#recommendation-10" id="markdown-toc-recommendation-10">Recommendation</a></li>
          <li><a href="#developer-response-10" id="markdown-toc-developer-response-10">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#2-gas---using-simple-comparison-engn33r" id="markdown-toc-2-gas---using-simple-comparison-engn33r">2. Gas - Using simple comparison (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-11" id="markdown-toc-proof-of-concept-11">Proof of concept</a></li>
          <li><a href="#impact-11" id="markdown-toc-impact-11">Impact</a></li>
          <li><a href="#recommendation-11" id="markdown-toc-recommendation-11">Recommendation</a></li>
          <li><a href="#developer-response-11" id="markdown-toc-developer-response-11">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#3-gas---use-prefix-in-loops-engn33r" id="markdown-toc-3-gas---use-prefix-in-loops-engn33r">3. Gas - Use prefix in loops (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-12" id="markdown-toc-proof-of-concept-12">Proof of concept</a></li>
          <li><a href="#impact-12" id="markdown-toc-impact-12">Impact</a></li>
          <li><a href="#recommendation-12" id="markdown-toc-recommendation-12">Recommendation</a></li>
          <li><a href="#developer-response-12" id="markdown-toc-developer-response-12">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#4-gas---payable-functions-can-save-gas-engn33r" id="markdown-toc-4-gas---payable-functions-can-save-gas-engn33r">4. Gas - Payable functions can save gas (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-13" id="markdown-toc-proof-of-concept-13">Proof of concept</a></li>
          <li><a href="#impact-13" id="markdown-toc-impact-13">Impact</a></li>
          <li><a href="#recommendation-13" id="markdown-toc-recommendation-13">Recommendation</a></li>
          <li><a href="#developer-response-13" id="markdown-toc-developer-response-13">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#5-gas---use--0-for-gas-savings-engn33r" id="markdown-toc-5-gas---use--0-for-gas-savings-engn33r">5. Gas - Use != 0 for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-14" id="markdown-toc-proof-of-concept-14">Proof of Concept</a></li>
          <li><a href="#impact-14" id="markdown-toc-impact-14">Impact</a></li>
          <li><a href="#recommendation-14" id="markdown-toc-recommendation-14">Recommendation</a></li>
          <li><a href="#developer-response-14" id="markdown-toc-developer-response-14">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#6-gas---use-solidity-errors-in-084-engn33r" id="markdown-toc-6-gas---use-solidity-errors-in-084-engn33r">6. Gas - Use Solidity errors in 0.8.4+ (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-15" id="markdown-toc-proof-of-concept-15">Proof of Concept</a></li>
          <li><a href="#impact-15" id="markdown-toc-impact-15">Impact</a></li>
          <li><a href="#recommendation-15" id="markdown-toc-recommendation-15">Recommendation</a></li>
          <li><a href="#developer-response-15" id="markdown-toc-developer-response-15">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#7-gas---declare-functions-external-for-gas-savings-engn33r" id="markdown-toc-7-gas---declare-functions-external-for-gas-savings-engn33r">7. Gas - Declare functions external for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-16" id="markdown-toc-proof-of-concept-16">Proof of concept</a></li>
          <li><a href="#impact-16" id="markdown-toc-impact-16">Impact</a></li>
          <li><a href="#recommendation-16" id="markdown-toc-recommendation-16">Recommendation</a></li>
          <li><a href="#developer-response-16" id="markdown-toc-developer-response-16">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#8-gas---remove-aragon-calls-for-gas-savings-engn33r" id="markdown-toc-8-gas---remove-aragon-calls-for-gas-savings-engn33r">8. Gas - Remove Aragon calls for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-17" id="markdown-toc-proof-of-concept-17">Proof of concept</a></li>
          <li><a href="#impact-17" id="markdown-toc-impact-17">Impact</a></li>
          <li><a href="#recommendation-17" id="markdown-toc-recommendation-17">Recommendation</a></li>
          <li><a href="#developer-response-17" id="markdown-toc-developer-response-17">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#9-gas---inconsistent-zero-case-in-votingescrowvy-engn33r" id="markdown-toc-9-gas---inconsistent-zero-case-in-votingescrowvy-engn33r">9. Gas - Inconsistent zero case in VotingEscrow.vy (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-18" id="markdown-toc-proof-of-concept-18">Proof of concept</a></li>
          <li><a href="#impact-18" id="markdown-toc-impact-18">Impact</a></li>
          <li><a href="#recommendation-18" id="markdown-toc-recommendation-18">Recommendation</a></li>
          <li><a href="#developer-response-18" id="markdown-toc-developer-response-18">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#10-gas---remove-duplicated-code-engn33r" id="markdown-toc-10-gas---remove-duplicated-code-engn33r">10. Gas - Remove duplicated code (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-19" id="markdown-toc-proof-of-concept-19">Proof of concept</a></li>
          <li><a href="#impact-19" id="markdown-toc-impact-19">Impact</a></li>
          <li><a href="#recommendation-19" id="markdown-toc-recommendation-19">Recommendation</a></li>
          <li><a href="#developer-response-19" id="markdown-toc-developer-response-19">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#11-gas---sload-gas-savings-engn33r" id="markdown-toc-11-gas---sload-gas-savings-engn33r">11. Gas - SLOAD gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-20" id="markdown-toc-proof-of-concept-20">Proof of concept</a></li>
          <li><a href="#impact-20" id="markdown-toc-impact-20">Impact</a></li>
          <li><a href="#recommendation-20" id="markdown-toc-recommendation-20">Recommendation</a></li>
          <li><a href="#developer-response-20" id="markdown-toc-developer-response-20">Developer Response</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#informational-findings" id="markdown-toc-informational-findings">Informational Findings</a>    <ol>
      <li><a href="#1-informational---safeerc20-functions-not-used-engn33r" id="markdown-toc-1-informational---safeerc20-functions-not-used-engn33r">1. Informational - SafeERC20 functions not used (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-21" id="markdown-toc-proof-of-concept-21">Proof of concept</a></li>
          <li><a href="#impact-21" id="markdown-toc-impact-21">Impact</a></li>
          <li><a href="#recommendation-21" id="markdown-toc-recommendation-21">Recommendation</a></li>
          <li><a href="#developer-response-21" id="markdown-toc-developer-response-21">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#2-informational---unspecified-voting-requirements-engn33r" id="markdown-toc-2-informational---unspecified-voting-requirements-engn33r">2. Informational - Unspecified Voting Requirements (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-22" id="markdown-toc-proof-of-concept-22">Proof of concept</a></li>
          <li><a href="#impact-22" id="markdown-toc-impact-22">Impact</a></li>
          <li><a href="#recommendation-22" id="markdown-toc-recommendation-22">Recommendation</a></li>
          <li><a href="#developer-response-22" id="markdown-toc-developer-response-22">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#3-informational---variable-naming-inconsistency-engn33r" id="markdown-toc-3-informational---variable-naming-inconsistency-engn33r">3. Informational - Variable naming inconsistency (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-23" id="markdown-toc-proof-of-concept-23">Proof of concept</a></li>
          <li><a href="#impact-23" id="markdown-toc-impact-23">Impact</a></li>
          <li><a href="#recommendation-23" id="markdown-toc-recommendation-23">Recommendation</a></li>
          <li><a href="#developer-response-23" id="markdown-toc-developer-response-23">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#4-informational---missing-0-check-in-setduration-engn33r" id="markdown-toc-4-informational---missing-0-check-in-setduration-engn33r">4. Informational - Missing 0 check in <code class="language-plaintext highlighter-rouge">setDuration()</code> (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-24" id="markdown-toc-proof-of-concept-24">Proof of concept</a></li>
          <li><a href="#impact-24" id="markdown-toc-impact-24">Impact</a></li>
          <li><a href="#recommendation-24" id="markdown-toc-recommendation-24">Recommendation</a></li>
          <li><a href="#developer-response-24" id="markdown-toc-developer-response-24">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#5-informational---typos-engn33r" id="markdown-toc-5-informational---typos-engn33r">5. Informational - Typos (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-25" id="markdown-toc-proof-of-concept-25">Proof of concept</a></li>
          <li><a href="#impact-25" id="markdown-toc-impact-25">Impact</a></li>
          <li><a href="#recommendation-25" id="markdown-toc-recommendation-25">Recommendation</a></li>
          <li><a href="#developer-response-25" id="markdown-toc-developer-response-25">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#6-informational---replace-magic-numbers-with-constants-engn33r" id="markdown-toc-6-informational---replace-magic-numbers-with-constants-engn33r">6. Informational - Replace magic numbers with constants (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-26" id="markdown-toc-proof-of-concept-26">Proof of concept</a></li>
          <li><a href="#impact-26" id="markdown-toc-impact-26">Impact</a></li>
          <li><a href="#recommendation-26" id="markdown-toc-recommendation-26">Recommendation</a></li>
          <li><a href="#developer-response-26" id="markdown-toc-developer-response-26">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#7-informational---code-inconsistency-engn33r" id="markdown-toc-7-informational---code-inconsistency-engn33r">7. Informational - Code inconsistency (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-27" id="markdown-toc-proof-of-concept-27">Proof of concept</a></li>
          <li><a href="#impact-27" id="markdown-toc-impact-27">Impact</a></li>
          <li><a href="#recommendation-27" id="markdown-toc-recommendation-27">Recommendation</a></li>
          <li><a href="#developer-response-27" id="markdown-toc-developer-response-27">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#8-informational---curve-safety-check-removed-engn33r" id="markdown-toc-8-informational---curve-safety-check-removed-engn33r">8. Informational - Curve safety check removed (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-28" id="markdown-toc-proof-of-concept-28">Proof of concept</a></li>
          <li><a href="#impact-28" id="markdown-toc-impact-28">Impact</a></li>
          <li><a href="#recommendation-28" id="markdown-toc-recommendation-28">Recommendation</a></li>
          <li><a href="#developer-response-28" id="markdown-toc-developer-response-28">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#9-informational---no-migratelock-sample-implementation-engn33r" id="markdown-toc-9-informational---no-migratelock-sample-implementation-engn33r">9. Informational - No migrateLock sample implementation (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-29" id="markdown-toc-proof-of-concept-29">Proof of concept</a></li>
          <li><a href="#impact-29" id="markdown-toc-impact-29">Impact</a></li>
          <li><a href="#recommendation-29" id="markdown-toc-recommendation-29">Recommendation</a></li>
          <li><a href="#developer-response-29" id="markdown-toc-developer-response-29">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#10-informational---use---to-keep-code-concise-engn33r" id="markdown-toc-10-informational---use---to-keep-code-concise-engn33r">10. Informational - Use -= to keep code concise (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-30" id="markdown-toc-proof-of-concept-30">Proof of concept</a></li>
          <li><a href="#impact-30" id="markdown-toc-impact-30">Impact</a></li>
          <li><a href="#recommendation-30" id="markdown-toc-recommendation-30">Recommendation</a></li>
          <li><a href="#developer-response-30" id="markdown-toc-developer-response-30">Developer Response</a></li>
        </ol>
      </li>
      <li><a href="#11-informational---update-rewards-for-other-users-engn33r" id="markdown-toc-11-informational---update-rewards-for-other-users-engn33r">11. Informational - Update rewards for other users (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-31" id="markdown-toc-proof-of-concept-31">Proof of concept</a></li>
          <li><a href="#impact-31" id="markdown-toc-impact-31">Impact</a></li>
          <li><a href="#recommendation-31" id="markdown-toc-recommendation-31">Recommendation</a></li>
          <li><a href="#developer-response-31" id="markdown-toc-developer-response-31">Developer Response</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#final-remarks" id="markdown-toc-final-remarks">Final remarks</a>    <ol>
      <li><a href="#engn33r" id="markdown-toc-engn33r">engn33r</a></li>
      <li><a href="#nibblerexpress" id="markdown-toc-nibblerexpress">NibblerExpress</a></li>
    </ol>
  </li>
  <li><a href="#about-yacademy" id="markdown-toc-about-yacademy">About yAcademy</a></li>
  <li><a href="#appendix-and-faq" id="markdown-toc-appendix-and-faq">Appendix and FAQ</a></li>
</ol>
      <h2 id="review-summary">
        
        
          <a href="#review-summary" class="anchor-heading" aria-labelledby="review-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Review Summary
        
        
      </h2>
    

<p><strong>veYFI</strong></p>

<p>The purpose of veYFI is to transition the YFI token to the vote escrow (ve) tokenomics model. The Yearn multisig will manage the contracts, which can upgrade and migrate as needed. The GaugeFactory contract creates new Gauge and ExtraReward contracts for each Yearn Vault. The Registry contract maintains a list of active gauges and rewards pools with their corresponding vaults, which enables upgrades to the system. The Gauge contract handles deposits of YFI while the VotingEscrow.vy contract, forked and modified from Curve’s ve tokenomics design, handles deposits of veYFI to enable governance rights. Some differences from Curve’s ve tokenomics include the ability to withdraw locked veYFI with a penalty and the ability for locked veYFI holders to delegate votes.</p>

<p>The main branch of the veYFI <a href="https://github.com/yearn/veYfi">Repo</a> was reviewed over 20 days, 3 of which were used to create an initial overview of the contract. The code review was performed between March 28 and April 16, 2022. The code was reviewed by 2 residents for a total of 58 man hours (engn33r: 34 hours, and NibblerExpress: 24 hours). The repository was under active development during the review, but the review was limited to <a href="https://github.com/yearn/veYFI/commit/7846291efec36638eae32ac8798544050ca20877">one specific commit</a>.</p>
      <h2 id="scope">
        
        
          <a href="#scope" class="anchor-heading" aria-labelledby="scope"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scope
        
        
      </h2>
    
<p><a href="https://github.com/yearn/veYfi">Code Repo</a>
<a href="https://github.com/yearn/veYFI/commit/7846291efec36638eae32ac8798544050ca20877">Commit</a></p>

<p>The commit reviewed was 7846291efec36638eae32ac8798544050ca20877. The review covered the entire repository at this specific commit but focused on the contracts directory.</p>

<p>After the findings were presented to the veYFI team, fixes were made and included in <a href="https://github.com/yearn/veYFI/commit/bbecf1e2ceaac9020658d34755ee769b57d54374">commit bbecf1e2ceaac9020658d34755ee769b57d54374</a>. Fixes were reviewed to confirm whether they remedied the original finding, but a new security review was not performed on the revised code (e.g. to determine whether new vulnerabilities were introduced by the fixes). Reviewers note that VeYFIRewards.sol was replaced by VeYFIRewards.vy between commits, and the two files appear to have significant differences in the code.</p>

<p>The review is a code review to identify potential vulnerabilities in the code. The reviewers did not investigate security practices or operational security and assumed that privileged accounts could be trusted. The reviewers did not evaluate the security of the code relative to a standard or specification. The review may not have identified all potential attack vectors or areas of vulnerability.</p>

<p>yAcademy and the residents make no warranties regarding the security of the code and do not warrant that the code is free from defects. yAcademy and the residents do not represent nor imply to third party users that the code has been audited nor that the code is free from defects. By deploying or using the code, Yearn and users agree to use the code at their own risk.</p>
      <h2 id="code-evaluation-matrix">
        
        
          <a href="#code-evaluation-matrix" class="anchor-heading" aria-labelledby="code-evaluation-matrix"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code Evaluation Matrix
        
        
      </h2>
    

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Category</th>
      <th>Mark</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Access Control</td>
      <td>Good</td>
      <td>The onlyOwner modifier was applied on functions that set key protocol state variables in Registry.sol and BaseGauge.sol. Elsewhere, msg.sender is used so that the user can only control their own deposits. Access controls are applied where needed.</td>
    </tr>
    <tr>
      <td>Mathematics</td>
      <td>Average</td>
      <td>Solidity 0.8.13 is used, which provides overflow and underflow protect. No unchecked code exists and no low-level bitwise operations are performed. There was no unusually complex math, except perhaps some of the vyper code functions borrowed from Curve which were not modified.</td>
    </tr>
    <tr>
      <td>Complexity</td>
      <td>Low</td>
      <td>The inheritance structure, duplicate function names, lack of clear comments, and inclusion of vyper code all together can make the code hard to follow at times. There is a lack of clarity around the off-chain voting process, and no comments in the code or repository issues/PRs clarify how the off-chain voting expected to integrate with on-chain voting variables.</td>
    </tr>
    <tr>
      <td>Libraries</td>
      <td>Good</td>
      <td>Only basic Open Zeppelin contracts such as SafeERC20, Ownable, and Math are imported, no other external libraries are used. Fewer and simpler external dependencies is always a plus for security.</td>
    </tr>
    <tr>
      <td>Decentralization</td>
      <td>Average</td>
      <td>The onlyOwner modifier indicates there is some centralization risk, but if the owner is a Yearn Finance multisig, the risk is reduced. Contracts such as VotingEscrow.vy support migration, so some form of ownership is required.</td>
    </tr>
    <tr>
      <td>Code stability</td>
      <td>Average</td>
      <td>Changes were reviewed at a specific commit and the scope was not expanded after the review was started. However, development was ongoing when the review was performed so the code was not fully frozen, which means deployed code may vary from what was reviewed.</td>
    </tr>
    <tr>
      <td>Documentation</td>
      <td>Low</td>
      <td>Comments existed in many places, but were lacking in key areas. As one example, identically named _updateReward functions existed in Gauge.sol, ExtraReward.sol and VeYfiRewards.sol, but no comments existed on either function and no explanation of the differences of these identically-named function existed. It would be best if more thorough comments and documentation was added throughout the code to better explain the purpose of different functions and specific math that is performed. No developer documentation like gitbooks was observed for veYFI at the time of review.</td>
    </tr>
    <tr>
      <td>Monitoring</td>
      <td>Good</td>
      <td>Events were added to all important functions that modified state variables.</td>
    </tr>
    <tr>
      <td>Testing and verification</td>
      <td>Average</td>
      <td>Brownie test coverage was passing with some warnings at the commit reviewed. Test coverage was above 80% in most contract functions but not all. There was a lack of testing integration with snapshot.org voting contracts and off-chain voting strategies.</td>
    </tr>
  </tbody>
</table></div>
      <h2 id="findings-explanation">
        
        
          <a href="#findings-explanation" class="anchor-heading" aria-labelledby="findings-explanation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Findings Explanation
        
        
      </h2>
    

<p>Findings are broken down into sections by their respective impact:</p>
<ul>
  <li>Critical, High, Medium, Low impact
    <ul>
      <li>These are findings that range from attacks that may cause loss of funds, impact control/ownership of the contracts, or cause any unintended consequences/actions that are outside the scope of the requirements</li>
    </ul>
  </li>
  <li>Gas savings
    <ul>
      <li>Findings that can improve the gas efficiency of the contracts</li>
    </ul>
  </li>
  <li>Informational
    <ul>
      <li>Findings including recommendations and best practices</li>
    </ul>
  </li>
</ul><hr />
      <h2 id="high-findings">
        
        
          <a href="#high-findings" class="anchor-heading" aria-labelledby="high-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> High Findings
        
        
      </h2>
    
      <h3 id="1-high---incompatible-vote-delegation-engn33r">
        
        
          <a href="#1-high---incompatible-vote-delegation-engn33r" class="anchor-heading" aria-labelledby="1-high---incompatible-vote-delegation-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. High - Incompatible Vote Delegation (engn33r)
        
        
      </h3>
    

<p>PR #99 moved veYFI to off-chain voting. Discussions with the veYFI team confirmed that the https://snapshot.org/ platform will be used for off-chain voting. The snapshot delegation documentation states the <a href="https://docs.snapshot.org/guides/delegation#with-a-smart-contract"><code class="language-plaintext highlighter-rouge">setDelegate()</code> function should be used</a> when a contract is delegating votes. The VoteDelegation.sol contract implements an independent vote delegation system, and there is no call in veYFI to call the <code class="language-plaintext highlighter-rouge">setDelegate()</code> or <code class="language-plaintext highlighter-rouge">clearDelegate()</code> functions in the snapshot.org delegation contract to be compatible with snapshot.org. This means the veYFI delegation code will have no impact on snapshot.org voting.</p>
      <h4 id="proof-of-concept">
        
        
          <a href="#proof-of-concept" class="anchor-heading" aria-labelledby="proof-of-concept"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <a href="https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VoteDelegation.sol">VoteDelegation.sol contract</a> has functions including <code class="language-plaintext highlighter-rouge">delegate()</code> and <code class="language-plaintext highlighter-rouge">removeDelegation()</code>, but the VoteDelegation.sol contract does not have any interaction with the snapshot <a href="https://etherscan.io/address/0x469788fE6E9E9681C6ebF3bF78e7Fd26Fc015446#code">DelegateRegistry contract</a>. Because there are no contract calls to snapshot.org contracts, snapshot.org will not register any vote delegation.</p>
      <h4 id="impact">
        
        
          <a href="#impact" class="anchor-heading" aria-labelledby="impact"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High. Vote delegation implementation is not compatible with intended offline voting approach.</p>
      <h4 id="recommendation">
        
        
          <a href="#recommendation" class="anchor-heading" aria-labelledby="recommendation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Overall the change to off-chain voting requires additional changes and integration effort. Some of the steps required to better integrate VoteDelegation.sol with snapshot.org include:</p>
<ol>
  <li>Creating a veYFI space in snapshot.org, which requires an ENS domain as documented in: https://docs.snapshot.org/spaces/create</li>
  <li>Adding calls to snapshot.org’s existing DelegateRegistry contract function calls in several places. An example implementation from Convex is provided in the documentation: https://docs.snapshot.org/guides/delegation#with-a-smart-contract. For starters, <code class="language-plaintext highlighter-rouge">DelegateRegistry.setDelegate()</code> should be called in the VoteDelegation.sol <code class="language-plaintext highlighter-rouge">_delegate()</code> function and <code class="language-plaintext highlighter-rouge">DelegateRegistry.clearDelegate()</code> should be called in the <code class="language-plaintext highlighter-rouge">_removeOldDelegation()</code> function. Additional changes may also be needed.</li>
  <li>Confirm that unit tests exists that interact with the DelegateRegistry contract on the proper testnet</li>
  <li>It is not immediately clear whether the <a href="https://snapshot.org/#/strategy/erc20-balance-of">erc20-balance-of</a> snapshot.org voting strategy works with the custom vote delegation design. This should be tested before production.</li>
</ol>

<p>I see three different approaches to handle the off-chain voting:</p>
<ol>
  <li>Remove vote delegation to keep everything like Curve (most simple)</li>
  <li>Remove the “until” value in the vote delegation and modify the voting delegation to use the DelegateRegistry from snapshot.org</li>
  <li>Implement a custom voting strategy on snapshot.org to handle the delegation and “until” values (most complex)</li>
</ol>
      <h4 id="developer-response">
        
        
          <a href="#developer-response" class="anchor-heading" aria-labelledby="developer-response"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>The VoteDelegation.sol contract has been removed in <a href="https://github.com/yearn/veYFI/pull/137">PR #137</a> and it will be replaced by the suggested contract from snapshot.org.</p>
      <h3 id="2-high---lock-1e-18-yfi-to-get-rewards-nibblerexpress">
        
        
          <a href="#2-high---lock-1e-18-yfi-to-get-rewards-nibblerexpress" class="anchor-heading" aria-labelledby="2-high---lock-1e-18-yfi-to-get-rewards-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. High - Lock 1e-18 YFI to Get Rewards (NibblerExpress)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">_updateReward()</code> computes a penalty based on the locking ratio of the account. A maximum possible lock of the smallest possible value allows a user to avoid any penalty without locking any amount of value.</p>
      <h4 id="proof-of-concept-1">
        
        
          <a href="#proof-of-concept-1" class="anchor-heading" aria-labelledby="proof-of-concept-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def test_gauge_cheat_yfi_lock(
    yfi, ve_yfi, whale, whale_amount, shark, shark_amount, fish, fish_amount, create_vault, create_gauge, gov
):

    yfi.approve(ve_yfi, shark_amount, {"from": shark})
    ve_yfi.create_lock(
        shark_amount, chain.time() + 4 * 3600 * 24 * 365, {"from": shark}
    )
    assert yfi.balanceOf(shark) == 0

    yfi.approve(ve_yfi, fish_amount, {"from": fish})
    ve_yfi.create_lock(
        fish_amount, chain.time() + 4 * 3600 * 24 * 365, {"from": fish}
    )
    assert yfi.balanceOf(fish) == 0

    yfi.approve(ve_yfi, 1, {"from": whale})
    ve_yfi.create_lock(
        1, chain.time() + 4 * 3600 * 24 * 365, {"from": whale}
    )
    assert yfi.balanceOf(whale) == whale_amount - 1

    lp_amount = 10**18
    vault = create_vault()
    tx = create_gauge(vault)
    gauge = Gauge.at(tx.events["GaugeCreated"]["gauge"])
    
    vault.mint(shark, lp_amount/100)
    vault.approve(gauge, lp_amount, {"from": shark})
    gauge.deposit({"from": shark})

    vault.mint(fish, lp_amount/100)
    vault.approve(gauge, lp_amount, {"from": fish})
    gauge.deposit({"from": fish})

    vault.mint(whale, 100*lp_amount)
    vault.approve(gauge, 100*lp_amount, {"from": whale})
    gauge.deposit({"from": whale})

    yfi_to_distribute = 10**16
    yfi.mint(gov, yfi_to_distribute)
    yfi.approve(gauge, yfi_to_distribute, {"from": gov})

    gauge.queueNewRewards(yfi_to_distribute, {"from": gov})
    assert pytest.approx(gauge.rewardRate()) == yfi_to_distribute / (7 * 24 * 3600)

    chain.sleep(3600*24*7)
    chain.mine()

    assert gauge.earned(whale) &lt; .39 * yfi_to_distribute
    gauge.getReward({"from": whale})

    assert yfi.balanceOf(whale) &lt; .39 * yfi_to_distribute + whale_amount

    gauge.withdraw({"from": whale})
    assert vault.balanceOf(whale) == 100*lp_amount
</code></pre></div></div>
      <h4 id="impact-1">
        
        
          <a href="#impact-1" class="anchor-heading" aria-labelledby="impact-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High. Users are able to get undue rewards with minimal investment. It is not ranked critical because the user cannot flash loan their deposit to drain the contract.  The user does need to keep the deposit in for seven days to reap the rewards.</p>
      <h4 id="recommendation-1">
        
        
          <a href="#recommendation-1" class="anchor-heading" aria-labelledby="recommendation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>One possible solution is to include a veYFI balance requirement when determining the penalty.</p>
      <h4 id="developer-response-1">
        
        
          <a href="#developer-response-1" class="anchor-heading" aria-labelledby="developer-response-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>The veYFI balance penalty has been removed. It’s replaced by a much bigger boost in <a href="https://github.com/yearn/veYFI/pull/141">PR #141</a>. Non-boosted rewards are distributed to veYFI.</p>
      <h3 id="3-high---flash-loan-sybil-attack-to-boost-rewards-nibblerexpress">
        
        
          <a href="#3-high---flash-loan-sybil-attack-to-boost-rewards-nibblerexpress" class="anchor-heading" aria-labelledby="3-high---flash-loan-sybil-attack-to-boost-rewards-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. High - Flash Loan Sybil Attack to Boost Rewards (NibblerExpress)
        
        
      </h3>
    

<p>The boosted balance for rewards is computed as <code class="language-plaintext highlighter-rouge">balance * 0.4 + totalSupply * veYFIBalance / veYFITotalSypply * 0.6</code>.  (Typo in <code class="language-plaintext highlighter-rouge">veYFITotalSupply</code> is copied from comment in L284 of Gauge.sol.)  Although depositing in your own account calls <code class="language-plaintext highlighter-rouge">updateReward()</code> for your account, you can use another account to flash loan a large amount of vault tokens and deposit them to boost the <code class="language-plaintext highlighter-rouge">totalSupply</code>.  Once you have boosted <code class="language-plaintext highlighter-rouge">totalSupply</code>, you trigger <code class="language-plaintext highlighter-rouge">updateReward()</code> for the target account and then withdraw the flash loan deposit.</p>

<p>(Note that the inverse is also true.  You can either sandwich attack someone else’s update by withdrawing tokens before their update to reduce total supply, or you can withdraw tokens and use <code class="language-plaintext highlighter-rouge">getRewardFor()</code> to force an update to someone else’s rewards like discussed here: https://github.com/yearn/veYFI/issues/33.)</p>
      <h4 id="proof-of-concept-2">
        
        
          <a href="#proof-of-concept-2" class="anchor-heading" aria-labelledby="proof-of-concept-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Boosted Balance equation: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/Gauge.sol#L302</p>

<p>Deposit Update Reward call: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/Gauge.sol#L351</p>

<p>Total Supply increase: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/Gauge.sol#L362</p>
      <h4 id="impact-2">
        
        
          <a href="#impact-2" class="anchor-heading" aria-labelledby="impact-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High. The magnitude of the impact depends on how much you can flash loan versus what the total supply is.  If you can flash loan 5x the total supply, you can get full rewards with 1/6 the intended veYFIBalance.  If you can only flash loan 10% of the total supply, you only get a 9% boost to your veYFIBalance.</p>
      <h4 id="recommendation-2">
        
        
          <a href="#recommendation-2" class="anchor-heading" aria-labelledby="recommendation-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>A possible solution is to compute a time weighted average of <code class="language-plaintext highlighter-rouge">totalSupply</code>. Alternatively, governance could set a <code class="language-plaintext highlighter-rouge">veYFIBalance</code> multiplier to use instead of using <code class="language-plaintext highlighter-rouge">totalSupply/veYFITotalSupply</code>. A third solution is to add <code class="language-plaintext highlighter-rouge">require(block.timestamp &gt; lastTimeRewardApplicable());</code> to the <code class="language-plaintext highlighter-rouge">_updateReward()</code> function to prevent a user from performing multiple deposits/withdrawals in the same block.</p>
      <h4 id="developer-response-2">
        
        
          <a href="#developer-response-2" class="anchor-heading" aria-labelledby="developer-response-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Deposit and withdraw on the same block isn’t possible anymore: https://github.com/yearn/veYFI/blob/bbecf1e2ceaac9020658d34755ee769b57d54374/contracts/Gauge.sol#L443-L446</p>

<p>It’s possible to game the system with a really large amount of funds but we have added a kick function that readjusts the boost in case someone misbehaves in <a href="https://github.com/yearn/veYFI/pull/142">PR #142</a>.</p>
      <h2 id="medium-findings">
        
        
          <a href="#medium-findings" class="anchor-heading" aria-labelledby="medium-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Medium Findings
        
        
      </h2>
    
      <h3 id="1-medium---incorrect-variables-in-getrewardfor-call-engn33r">
        
        
          <a href="#1-medium---incorrect-variables-in-getrewardfor-call-engn33r" class="anchor-heading" aria-labelledby="1-medium---incorrect-variables-in-getrewardfor-call-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Medium - Incorrect variables in getRewardFor call (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">_getReward()</code> function in Gauge.sol uses the wrong account address twice, which counts and distributes rewards incorrectly when <code class="language-plaintext highlighter-rouge">account != msg.sender</code>. After the review started, one of these variables was fixed, but not the other.</p>
      <h4 id="proof-of-concept-3">
        
        
          <a href="#proof-of-concept-3" class="anchor-heading" aria-labelledby="proof-of-concept-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The _account variable should be used in this line instead of msg.sender
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L512</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IExtraReward(extraRewards[i]).getRewardFor(msg.sender);
</code></pre></div></div>

<p>The _account variable should be used in this line instead of msg.sender
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L501</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IVotingEscrow(veToken).deposit_for(msg.sender, reward);
</code></pre></div></div>
      <h4 id="impact-3">
        
        
          <a href="#impact-3" class="anchor-heading" aria-labelledby="impact-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Medium. Incorrect values could be calculated when <code class="language-plaintext highlighter-rouge">account != msg.sender</code> in some edge cases.</p>
      <h4 id="recommendation-3">
        
        
          <a href="#recommendation-3" class="anchor-heading" aria-labelledby="recommendation-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use this fix from <a href="https://github.com/yearn/veYFI/pull/125">PR #125</a> for both cases, which was created after the commit at which this code review started at.</p>
      <h4 id="developer-response-3">
        
        
          <a href="#developer-response-3" class="anchor-heading" aria-labelledby="developer-response-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="2-medium---unclear-integration-of-vote-delegation-until-value-engn33r">
        
        
          <a href="#2-medium---unclear-integration-of-vote-delegation-until-value-engn33r" class="anchor-heading" aria-labelledby="2-medium---unclear-integration-of-vote-delegation-until-value-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Medium - Unclear Integration of Vote Delegation Until Value (engn33r)
        
        
      </h3>
    

<p>This issue is similar to the high risk voting issue but relates to a difference between Curve voting (where veYFI borrows some ideas from) and the current veYFI implementation. PR #99 moved veYFI to off-chain voting. Discussions with the veYFI team confirmed that the https://snapshot.org/ platform will be used for off-chain voting. Although snapshot.org does support <a href="https://docs.snapshot.org/guides/delegation#with-a-smart-contract">vote delegation</a>, the existing snapshot.org voting delegation does not support the “until” value. This means that if the existing snapshot.org vote delegation strategy is used (which involves adding calls to the <code class="language-plaintext highlighter-rouge">setDelegate()</code> and <code class="language-plaintext highlighter-rouge">clearDelegate()</code> functions), then delegation will remain in place until it is changed by the veYFI token owner, and can remain valid beyond the <code class="language-plaintext highlighter-rouge">until</code> timestamp.</p>
      <h4 id="proof-of-concept-4">
        
        
          <a href="#proof-of-concept-4" class="anchor-heading" aria-labelledby="proof-of-concept-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <a href="https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VoteDelegation.sol">VoteDelegation.sol contract</a> has functions including <code class="language-plaintext highlighter-rouge">delegate()</code> and <code class="language-plaintext highlighter-rouge">removeDelegation()</code>, but the VoteDelegation.sol contract does not have any interaction with the snapshot <a href="https://etherscan.io/address/0x469788fE6E9E9681C6ebF3bF78e7Fd26Fc015446#code">DelegateRegistry contract</a>. Because the actual act of voting is planned to happen off-chain with snapshot.org, snapshot.org needs to recognize what a valid vote or delegation is in the snapshot that it takes for each proposal. Currently there is no option in the snapshot.org delegation approach for an “until” value. Factoring in the “until” value could be implemented in a custom snapshot.org voting strategy, but because no such strategy is mentioned anywhere in the veYFI repository, it is expected that this has not been considered.</p>
      <h4 id="impact-4">
        
        
          <a href="#impact-4" class="anchor-heading" aria-labelledby="impact-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Medium. Vote delegation implementation is not compatible with intended offline voting approach. It is not considered high risk because if the snapshot.org vote delegation is integrated (which it currently is not), the basic act of vote delegation should work and a workaround with token holders calling the right function at the right time can be used.</p>
      <h4 id="recommendation-4">
        
        
          <a href="#recommendation-4" class="anchor-heading" aria-labelledby="recommendation-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>The best solution is to create a custom voting strategy, instead of using the <a href="https://snapshot.org/#/strategy/erc20-balance-of">erc20-balance-of</a> voting strategy that Curve uses. An easier solution is to remove the “until” value in the vote delegation and use the simplistic <a href="https://snapshot.org/#/strategy/erc20-balance-of">erc20-balance-of</a> voting strategy along with the built-in snapshot.org delegation strategy.</p>

<p>I see three different approaches to handle the off-chain voting:</p>
<ol>
  <li>Remove vote delegation to keep everything like Curve (most simple)</li>
  <li>Remove the “until” value in the vote delegation and modify the voting delegation to use the DelegateRegistry from snapshot.org</li>
  <li>Implement a custom voting strategy on snapshot.org to handle the delegation and “until” values (most complex)</li>
</ol>
      <h4 id="developer-response-4">
        
        
          <a href="#developer-response-4" class="anchor-heading" aria-labelledby="developer-response-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>File has been removed in <a href="https://github.com/yearn/veYFI/pull/137">PR #137</a>.</p>
      <h3 id="3-medium---force_withdraw-penalty-may-inadequately-deter-gamification-and-attacks-on-voting-engn33r-nibblerexpress">
        
        
          <a href="#3-medium---force_withdraw-penalty-may-inadequately-deter-gamification-and-attacks-on-voting-engn33r-nibblerexpress" class="anchor-heading" aria-labelledby="3-medium---force_withdraw-penalty-may-inadequately-deter-gamification-and-attacks-on-voting-engn33r-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Medium - <code class="language-plaintext highlighter-rouge">force_withdraw()</code> penalty may inadequately deter gamification and attacks on voting (engn33r, NibblerExpress)
        
        
      </h3>
    

<p>The penalty ratio equation reads</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penalty_ratio: uint256 = min(MULTIPLIER * 3 / 4, MULTIPLIER * time_left / MAXTIME)
</code></pre></div></div>

<p>Short lock periods receive low withdrawal penalties, which may not be intentional. Because the MAXTIME value is 4 years, when the time_left value is less than 3 years, the penalty ratio for withdrawal will be less than 75%. This means the worst case withdrawal penalty for any lock period under 3 years is less than 75%, even in the event that the user withdraws immediately after locking. This could lead to gamification where users planning to withdraw will lock the veYFI for shorter durations instead of 4 years.</p>

<p>The inverse scenario could also cause a problem. Users receive a 100% credit for deposits with a four year lock but only a 75% burn. If there is a scenario where the benefit of a temporary deposit is &gt; 75% of the deposit, a user should do a max lock and then take the burn. For example, if a proposal put forth for a vote could allow a user to drain a contract, it could be profitable for a user to deposit sufficient funds to have &gt; 50% of the voting power and to retrieve 25% of their deposit plus what can be drained from the contract.</p>

<p>This attack vector would most likely happen when a user has advanced knowledge that a vote is upcoming (YIP proposals and related discussion are often public). The user could stake YFI for a specific vote (either a governance or gauge vote) where they may disproportionately benefit. This vector may be unique to veYFI compared to other ve protocols because veYFI does not apply protective measures that other protocols use. Curve does not allow for early withdrawal of locked veCRV, which protects against this scenario. Convex allows for vote delegation, similar to veYFI, but adds a 16 week cooldown period before the locked tokens can be used for voting, making this attack vector less likely due to the advanced planning necessary. https://docs.convexfinance.com/convexfinance/general-information/voting-and-gauge-weights/vote-locking</p>

<p>The risk for this vector is increased when combined with finding Low #3, because Low #3 outlines an approach that could enable the user paying the penalty to receive some of their penalty back in rewards.</p>
      <h4 id="proof-of-concept-5">
        
        
          <a href="#proof-of-concept-5" class="anchor-heading" aria-labelledby="proof-of-concept-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The penalty_ratio equation
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L570</p>
      <h4 id="impact-5">
        
        
          <a href="#impact-5" class="anchor-heading" aria-labelledby="impact-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Medium. The penalty calculation could be gameable because incentives are not properly aligned towards long-term locking of veYFI with the existing penalty calculations.</p>
      <h4 id="recommendation-5">
        
        
          <a href="#recommendation-5" class="anchor-heading" aria-labelledby="recommendation-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Consider modifying the function so that the penalty ratio is a function of the time_left to locked duration, not a function of the ratio of the time_left to 4 years. This could reduce gamification by increasing the penalty cost in this type of attack. The modified code below is a draft and should be thoroughly tested, but it is intended to provide results of:</p>
<ul>
  <li>If a user hypothetically locks for 4 years and withdraws in their first year, 75% penalty (same as before)</li>
  <li>If a user hypothetically locks for 1 year and withdraws immediately, 75% penalty. With the old equation, the penalty was closer to 25%
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penalty_ratio: uint256 = min(MULTIPLIER * 3 / 4, MULTIPLIER * time_left / (block.timestamp - user_point_history__ts(msg.sender, self.user_point_epoch[msg.sender])))
</code></pre></div>    </div>
  </li>
</ul>

<p>Require tokens to be locked for a certain time before (and possibly after) allowing voting, similar to Convex. Increasing the ease of withdrawal for locked tokens, even with a penalty, can add unexpected incentives.</p>
      <h4 id="developer-response-5">
        
        
          <a href="#developer-response-5" class="anchor-heading" aria-labelledby="developer-response-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h2 id="low-findings">
        
        
          <a href="#low-findings" class="anchor-heading" aria-labelledby="low-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Low Findings
        
        
      </h2>
    
      <h3 id="1-low---voting-delegation-is-missing-edge-case-checks-engn33r">
        
        
          <a href="#1-low---voting-delegation-is-missing-edge-case-checks-engn33r" class="anchor-heading" aria-labelledby="1-low---voting-delegation-is-missing-edge-case-checks-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Low - Voting delegation is missing edge case checks (engn33r)
        
        
      </h3>
    

<p>The VoteDelegation.sol contract permits vote delegation. The delegation has an “until” value, which can be set to zero. The until value can be changed so that the new until value is greater than the old one, but the check should also confirm that the new until value is greater than block.timestamp. Otherwise the until value can be modified for a time in the past. This may cause issues in the voting logic depending how the until value is stored and used in the snapshot logic.</p>
      <h4 id="proof-of-concept-6">
        
        
          <a href="#proof-of-concept-6" class="anchor-heading" aria-labelledby="proof-of-concept-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The VoteDelegation.sol contract permits an <code class="language-plaintext highlighter-rouge">until</code> variable value of zero if the tokens are not locked. Any <code class="language-plaintext highlighter-rouge">until</code> variable value that is less than <code class="language-plaintext highlighter-rouge">block.timestamp</code> should have no impact on voting or delegation. But if the <code class="language-plaintext highlighter-rouge">until</code> value starts at zero, it is possible for the value to be increased to a value less than <code class="language-plaintext highlighter-rouge">block.timestamp</code> to reference a time in the recent past, but still have no impact. It is possible that the voting logic, which is not within the scope of these solidity contracts, may not properly consider this edge case. This edge case can be solved by adding a check in all functions that modify the <code class="language-plaintext highlighter-rouge">until</code> state variable, including <code class="language-plaintext highlighter-rouge">_delegate()</code> and <code class="language-plaintext highlighter-rouge">increaseDelegationDuration()</code>, to validate <code class="language-plaintext highlighter-rouge">require(until &gt; block.timestamp)</code>. An exception could be made for an <code class="language-plaintext highlighter-rouge">until</code> value of zero, resulting in a require statement that looks like <code class="language-plaintext highlighter-rouge">require(_until &gt; block.timestamp || _until == 0)</code>.</p>

<p>Another edge case is a situation where the until value is set to a time beyond the lock expiration of the veYFI tokens. There is no check for to confirm <code class="language-plaintext highlighter-rouge">until &lt; locked.end</code>. This edge case could also happen if a user delegated votes, then withdrew their tokens to a new account where the tokens were locked and votes delegated again. It is unclear whether the off-chain voting mechanism will handle this edge case, which could allow multiple votes from a single token. Otherwise, consider adding the check <code class="language-plaintext highlighter-rouge">require(_until &lt; locked.end)</code>.</p>
      <h4 id="impact-6">
        
        
          <a href="#impact-6" class="anchor-heading" aria-labelledby="impact-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. Risk may be greater depending on the off-chain voting logic.</p>
      <h4 id="recommendation-6">
        
        
          <a href="#recommendation-6" class="anchor-heading" aria-labelledby="recommendation-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Add logic checks into the VoteDelegation.sol contract to prevent mistakes with the off-chain voting logic that results in unexpected edge cases.</p>
      <h4 id="developer-response-6">
        
        
          <a href="#developer-response-6" class="anchor-heading" aria-labelledby="developer-response-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>The VoteDelegation.sol contract has been removed in <a href="https://github.com/yearn/veYFI/pull/137">PR #137</a>.</p>
      <h3 id="2-low---sawtooth-wave-effect-from-computing-veyfi-balance-and-supply-using-different-time-scales-nibblerexpress">
        
        
          <a href="#2-low---sawtooth-wave-effect-from-computing-veyfi-balance-and-supply-using-different-time-scales-nibblerexpress" class="anchor-heading" aria-labelledby="2-low---sawtooth-wave-effect-from-computing-veyfi-balance-and-supply-using-different-time-scales-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Low - Sawtooth Wave Effect from Computing veYFI Balance and Supply Using Different Time Scales (NibblerExpress)
        
        
      </h3>
    

<p>The boosted balance for rewards is computed as <code class="language-plaintext highlighter-rouge">balance * 0.4 + totalSupply * veYFIBalance / veYFITotalSypply * 0.6</code>.  (Typo in veYFITotalSupply is copied from comment in L284 of Gauge.)  Most voting escrow functions truncate time stamps down to the most recent week.  This includes the function used to compute total supply.  The veYFIBalance is not truncated to the nearest week.  A user with a max lock will see their balance slowly decline over the course of a week until they can increase the lock again when the next week arrives.  Because anyone can update the rewards for a user (e.g., using depositFor or getRewardsFor), an attacker can wait until the very end of a week when veYFIBalance is lowest to update the rewards for other users.</p>
      <h4 id="proof-of-concept-7">
        
        
          <a href="#proof-of-concept-7" class="anchor-heading" aria-labelledby="proof-of-concept-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Equation to compute Total Supply: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/VotingEscrow.vy#L756<br />
(<code class="language-plaintext highlighter-rouge">t_i</code> is truncated to a value in weeks at L748 and L750.)</p>

<p>Equation to compute Balance: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/VotingEscrow.vy#L677</p>

<p><code class="language-plaintext highlighter-rouge">_t</code> is set to block.timestamp for balance computation: https://github.com/YAcademy-Residents/veYFI/blob/7846291efec36638eae32ac8798544050ca20877/contracts/VotingEscrow.vy#L647</p>
      <h4 id="impact-7">
        
        
          <a href="#impact-7" class="anchor-heading" aria-labelledby="impact-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. The decline over the course of a week will be &lt; 0.5%, so users can boost their veYFI balance by 0.5% to avoid any attack.  Also, the attack likely won’t be worth the cost of gas.  This may be a small annoyance for users depositing amounts close to the cutoff for full rewards.</p>
      <h4 id="recommendation-7">
        
        
          <a href="#recommendation-7" class="anchor-heading" aria-labelledby="recommendation-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>The balance calculation could be truncated to the nearest week like the calculations in Total Supply and other functions.</p>
      <h4 id="developer-response-7">
        
        
          <a href="#developer-response-7" class="anchor-heading" aria-labelledby="developer-response-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    
<p>Won’t fix, boost is not snapshotted on deposit and won’t change until next interaction with the pool (withdraw, deposit, claim).</p>
      <h3 id="3-low---equal-penalty-reward-distribution-not-incentive-aligned-engn33r-nibblerexpress">
        
        
          <a href="#3-low---equal-penalty-reward-distribution-not-incentive-aligned-engn33r-nibblerexpress" class="anchor-heading" aria-labelledby="3-low---equal-penalty-reward-distribution-not-incentive-aligned-engn33r-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Low - Equal penalty reward distribution not incentive aligned (engn33r, NibblerExpress)
        
        
      </h3>
    

<p>When a user withdraws the locked veYFI from VotingEscrow.vy early, the penalty fee is redistributed in the rewards pool for that week. The rewards are distributed evenly to all reward recipients, and are not distributed by the veYFI weights or locking period of each veYFI holder. There is an incentive to actively deposit and withdraw after a penalty fee is received by the veYFI protocol while the rewardPerToken is increased. This can lead to backrunning opportunities when a penalty fee is paid.</p>

<p>There is another penalty fee applied in Gauge.sol when <code class="language-plaintext highlighter-rouge">_updateReward()</code> is called using the updateReward modifier. This penalty will be non-zero any time that the tokens are not locked for 4 years. If a user was going to pay the Gauge.sol penalty and was looking to extract some of their penalty payment, they can plan ahead to stay under the 120% limit imposed by <code class="language-plaintext highlighter-rouge">queueNewRewards()</code> in BaseGauge.sol.</p>

<p>This is slightly similar to this Solidly issue, but this veYFI issue only impacts penalty fee payouts, not gauge reward payouts: https://github.com/belbix/solidly/issues/1</p>
      <h4 id="proof-of-concept-8">
        
        
          <a href="#proof-of-concept-8" class="anchor-heading" aria-labelledby="proof-of-concept-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>A discussion for this issue was started by someone from Ribbon Finance (who forked the veYFI code) before the review ended in <a href="https://github.com/yearn/veYFI/issues/135">veYFI Issue 135</a> and a fix is being developed in <a href="https://github.com/yearn/veYFI/pull/136">PR #136</a>. The issue is centered around how penalty fees paid in VotingEscrow.vy and Gauge.sol are redistributed to users.</p>
      <h4 id="impact-8">
        
        
          <a href="#impact-8" class="anchor-heading" aria-labelledby="impact-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. The rewards payout from a penalty is not well distributed, but users are incentivized to lock for MAX_TIME and not to withdraw early to avoid penalties.</p>
      <h4 id="recommendation-8">
        
        
          <a href="#recommendation-8" class="anchor-heading" aria-labelledby="recommendation-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Improve the reward distribution of penalty fees, which is a difficult problem to resolve. Paying out penalty fees slowly over a longer time period instead of adding the funds to the current epoch reward pool would reduce the chances that a large amount of penalty fees could be extracted quickly.</p>
      <h4 id="developer-response-8">
        
        
          <a href="#developer-response-8" class="anchor-heading" aria-labelledby="developer-response-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>The amount of veYFI a user lock is based on the duration of the lock making really short locks close to negligeable. The contract distributing rewards to veYFI has been entirely changed in <a href="https://github.com/yearn/veYFI/pull/136">PR #136</a>.</p>
      <h3 id="4-low---no-penalty-during-migration-engn33r">
        
        
          <a href="#4-low---no-penalty-during-migration-engn33r" class="anchor-heading" aria-labelledby="4-low---no-penalty-during-migration-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Low - No penalty during migration (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">_lockingRatio()</code> function of Gauge.sol returns a ratio based on the amount of time the user has locked their ve tokens. The maximum value for this ratio is PRECISON_FACTOR, which is when a user locks their ve tokens for MAX_TIME. A user can also have a PRECISON_FACTOR locking ratio when the ve token contract is undergoing migration and the contract owner has not call <code class="language-plaintext highlighter-rouge">setVe()</code> yet to point to the new ve token contract. A user can take advantage of this edge case. For example, any function with the updateReward modifier will calculate a penalty of zero when a ve token migration is ongoing, regardless of how long a user has locked their tokens.</p>
      <h4 id="proof-of-concept-9">
        
        
          <a href="#proof-of-concept-9" class="anchor-heading" aria-labelledby="proof-of-concept-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">_lockingRatio()</code> function returns PRECISON_FACTOR, equivalent to locking for the MAX_TIME value, when the ve token is undergoing migration: 
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L221</p>

<p>Instead, it would be better to revert in this case so that the ve token can be finished without any users taking advantage of this edge case.</p>
      <h4 id="impact-9">
        
        
          <a href="#impact-9" class="anchor-heading" aria-labelledby="impact-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. This is a rare edge case but should be handled properly.</p>
      <h4 id="recommendation-9">
        
        
          <a href="#recommendation-9" class="anchor-heading" aria-labelledby="recommendation-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Change the behavior of the <code class="language-plaintext highlighter-rouge">_lockingRatio()</code> function to revert during migration to allow the owner to call <code class="language-plaintext highlighter-rouge">setVe()</code> with the new ve token address.</p>
      <h4 id="developer-response-9">
        
        
          <a href="#developer-response-9" class="anchor-heading" aria-labelledby="developer-response-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h2 id="gas-savings-findings">
        
        
          <a href="#gas-savings-findings" class="anchor-heading" aria-labelledby="gas-savings-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gas Savings Findings
        
        
      </h2>
    
      <h3 id="1-gas---using-unchecked-engn33r">
        
        
          <a href="#1-gas---using-unchecked-engn33r" class="anchor-heading" aria-labelledby="1-gas---using-unchecked-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Gas - Using “unchecked” (engn33r)
        
        
      </h3>
    

<p>In <code class="language-plaintext highlighter-rouge">setDuration()</code> of BaseGauge.sol, we know <code class="language-plaintext highlighter-rouge">periodFinish &gt; block.timestamp</code> so we can use the “unchecked” clause for gas savings.</p>

<p>The same improvement can be used in Gauge.sol.</p>
      <h4 id="proof-of-concept-10">
        
        
          <a href="#proof-of-concept-10" class="anchor-heading" aria-labelledby="proof-of-concept-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The relevant code block</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (block.timestamp &lt; periodFinish) {
    uint256 remaining = periodFinish - block.timestamp;
</code></pre></div></div>

<p>Applying unchecked for gas savings, this code would look like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (block.timestamp &lt; periodFinish) {
    unchecked { uint256 remaining = periodFinish - block.timestamp; }
</code></pre></div></div>

<p>BaseGauge.sol line that can be unchecked
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L79</p>

<p>Gauge.sol line that can be unchecked
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L229</p>
      <h4 id="impact-10">
        
        
          <a href="#impact-10" class="anchor-heading" aria-labelledby="impact-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-10">
        
        
          <a href="#recommendation-10" class="anchor-heading" aria-labelledby="recommendation-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use unchecked where there is no overflow or underflow risk</p>
      <h4 id="developer-response-10">
        
        
          <a href="#developer-response-10" class="anchor-heading" aria-labelledby="developer-response-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h3 id="2-gas---using-simple-comparison-engn33r">
        
        
          <a href="#2-gas---using-simple-comparison-engn33r" class="anchor-heading" aria-labelledby="2-gas---using-simple-comparison-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Gas - Using simple comparison (engn33r)
        
        
      </h3>
    

<p>Using a compound comparison such as <code class="language-plaintext highlighter-rouge">≥</code> or <code class="language-plaintext highlighter-rouge">≤</code> uses more gas than a simple comparison check like <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, or <code class="language-plaintext highlighter-rouge">==</code>. Compound comparison operators can be replaced with simple ones for gas savings.</p>
      <h4 id="proof-of-concept-11">
        
        
          <a href="#proof-of-concept-11" class="anchor-heading" aria-labelledby="proof-of-concept-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">_notifyRewardAmount()</code> function in BaseGauge.sol contains
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L170-L177</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (block.timestamp &gt;= periodFinish) {
    rewardRate = reward / duration;
} else {
    uint256 remaining = periodFinish - block.timestamp;
    uint256 leftover = remaining * rewardRate;
    reward = reward + leftover;
    rewardRate = reward / duration;
}
</code></pre></div></div>

<p>By switching around the if/else clauses, we can replace the compound operator with a simple one</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (block.timestamp &lt; periodFinish) {
    uint256 remaining = periodFinish - block.timestamp;
    uint256 leftover = remaining * rewardRate;
    reward = reward + leftover;
    rewardRate = reward / duration;
} else {
    rewardRate = reward / duration;
}
</code></pre></div></div>
      <h4 id="impact-11">
        
        
          <a href="#impact-11" class="anchor-heading" aria-labelledby="impact-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-11">
        
        
          <a href="#recommendation-11" class="anchor-heading" aria-labelledby="recommendation-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace compound comparison operators with simple ones for gas savings</p>
      <h4 id="developer-response-11">
        
        
          <a href="#developer-response-11" class="anchor-heading" aria-labelledby="developer-response-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h3 id="3-gas---use-prefix-in-loops-engn33r">
        
        
          <a href="#3-gas---use-prefix-in-loops-engn33r" class="anchor-heading" aria-labelledby="3-gas---use-prefix-in-loops-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Gas - Use prefix in loops (engn33r)
        
        
      </h3>
    

<p>Using a prefix increment (<code class="language-plaintext highlighter-rouge">++i</code>) instead of a postfix increment (<code class="language-plaintext highlighter-rouge">i++</code>) saves gas for each loop cycle and so can have a big gas impact when the loop executes on a large number of elements.</p>

<p>The gas savings comes from the removal of a temporary variable. The value of <code class="language-plaintext highlighter-rouge">j++</code> is 1 but the value of <code class="language-plaintext highlighter-rouge">j</code> equals 2, which means two distinct values must be stored. In comparison, both <code class="language-plaintext highlighter-rouge">j</code> and <code class="language-plaintext highlighter-rouge">++j</code> equal 2 when using <code class="language-plaintext highlighter-rouge">++j</code>.</p>
      <h4 id="proof-of-concept-12">
        
        
          <a href="#proof-of-concept-12" class="anchor-heading" aria-labelledby="proof-of-concept-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There are 4 instances of this in Gauge.sol and 1 instance in VoteDelegation.sol</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L161</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L357</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L386</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L511</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VoteDelegation.sol#L121</li>
</ul>
      <h4 id="impact-12">
        
        
          <a href="#impact-12" class="anchor-heading" aria-labelledby="impact-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-12">
        
        
          <a href="#recommendation-12" class="anchor-heading" aria-labelledby="recommendation-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Increment with prefix addition and not postfix in for loops.</p>
      <h4 id="developer-response-12">
        
        
          <a href="#developer-response-12" class="anchor-heading" aria-labelledby="developer-response-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="4-gas---payable-functions-can-save-gas-engn33r">
        
        
          <a href="#4-gas---payable-functions-can-save-gas-engn33r" class="anchor-heading" aria-labelledby="4-gas---payable-functions-can-save-gas-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Gas - Payable functions can save gas (engn33r)
        
        
      </h3>
    

<p>If there is no risk of a function accidentally receiving ether, such as a function with the onlyOwner modifier, this function can use the payable modifier to save gas.</p>
      <h4 id="proof-of-concept-13">
        
        
          <a href="#proof-of-concept-13" class="anchor-heading" aria-labelledby="proof-of-concept-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The following functions have the onlyOwner modifier and can be marked as payable</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">setVe()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Registry.sol#L49</li>
  <li><code class="language-plaintext highlighter-rouge">addVaultToRewards()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Registry.sol#L67</li>
  <li><code class="language-plaintext highlighter-rouge">removeVaultFromRewards()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Registry.sol#L94</li>
  <li><code class="language-plaintext highlighter-rouge">setVe()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VeYfiRewards.sol#L30</li>
  <li><code class="language-plaintext highlighter-rouge">setVe()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L110</li>
  <li><code class="language-plaintext highlighter-rouge">setDuration()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L73</li>
  <li><code class="language-plaintext highlighter-rouge">sweep()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L111</li>
</ul>
      <h4 id="impact-13">
        
        
          <a href="#impact-13" class="anchor-heading" aria-labelledby="impact-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-13">
        
        
          <a href="#recommendation-13" class="anchor-heading" aria-labelledby="recommendation-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Mark functions that have onlyOwner as payable for gas savings. This might not be aesthetically pleasing, but it works.</p>
      <h4 id="developer-response-13">
        
        
          <a href="#developer-response-13" class="anchor-heading" aria-labelledby="developer-response-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h3 id="5-gas---use--0-for-gas-savings-engn33r">
        
        
          <a href="#5-gas---use--0-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="5-gas---use--0-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Gas - Use != 0 for gas savings (engn33r)
        
        
      </h3>
    

<p>Using <code class="language-plaintext highlighter-rouge">&gt; 0</code> is less gas efficient than using <code class="language-plaintext highlighter-rouge">!= 0</code> when comparing a uint to zero. This improvement does not apply to int values, which can store values below zero.</p>
      <h4 id="proof-of-concept-14">
        
        
          <a href="#proof-of-concept-14" class="anchor-heading" aria-labelledby="proof-of-concept-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of Concept
        
        
      </h4>
    

<p>Four instances of this were found</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L353</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L382</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L497</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L123</li>
</ul>
      <h4 id="impact-14">
        
        
          <a href="#impact-14" class="anchor-heading" aria-labelledby="impact-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-14">
        
        
          <a href="#recommendation-14" class="anchor-heading" aria-labelledby="recommendation-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace <code class="language-plaintext highlighter-rouge">&gt; 0</code> with <code class="language-plaintext highlighter-rouge">!= 0</code> to save gas.</p>
      <h4 id="developer-response-14">
        
        
          <a href="#developer-response-14" class="anchor-heading" aria-labelledby="developer-response-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="6-gas---use-solidity-errors-in-084-engn33r">
        
        
          <a href="#6-gas---use-solidity-errors-in-084-engn33r" class="anchor-heading" aria-labelledby="6-gas---use-solidity-errors-in-084-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Gas - Use Solidity errors in 0.8.4+ (engn33r)
        
        
      </h3>
    

<p>Using solidity errors is a new and more gas efficient way to revert on failure states</p>
<ul>
  <li>https://blog.soliditylang.org/2021/04/21/custom-errors/</li>
  <li>https://twitter.com/PatrickAlphaC/status/1505197417884528640</li>
</ul>
      <h4 id="proof-of-concept-15">
        
        
          <a href="#proof-of-concept-15" class="anchor-heading" aria-labelledby="proof-of-concept-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of Concept
        
        
      </h4>
    

<p>Require statements are used throughout the contracts and error messages are not used anywhere. Using this new solidity feature can provide gas savings on revert conditions.</p>
      <h4 id="impact-15">
        
        
          <a href="#impact-15" class="anchor-heading" aria-labelledby="impact-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-15">
        
        
          <a href="#recommendation-15" class="anchor-heading" aria-labelledby="recommendation-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Add errors to replace each <code class="language-plaintext highlighter-rouge">require()</code> with <code class="language-plaintext highlighter-rouge">revert errorName()</code> for greater gas efficiency.</p>
      <h4 id="developer-response-15">
        
        
          <a href="#developer-response-15" class="anchor-heading" aria-labelledby="developer-response-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h3 id="7-gas---declare-functions-external-for-gas-savings-engn33r">
        
        
          <a href="#7-gas---declare-functions-external-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="7-gas---declare-functions-external-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Gas - Declare functions external for gas savings (engn33r)
        
        
      </h3>
    

<p>The boostedBalanceOf function and deposit function of Gauge.sol should be declared external, not public, for gas savings.</p>
      <h4 id="proof-of-concept-16">
        
        
          <a href="#proof-of-concept-16" class="anchor-heading" aria-labelledby="proof-of-concept-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There are two public functions that can be external</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L287</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L317</li>
</ul>
      <h4 id="impact-16">
        
        
          <a href="#impact-16" class="anchor-heading" aria-labelledby="impact-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-16">
        
        
          <a href="#recommendation-16" class="anchor-heading" aria-labelledby="recommendation-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Declare functions as an external functions for gas savings.</p>
      <h4 id="developer-response-16">
        
        
          <a href="#developer-response-16" class="anchor-heading" aria-labelledby="developer-response-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="8-gas---remove-aragon-calls-for-gas-savings-engn33r">
        
        
          <a href="#8-gas---remove-aragon-calls-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="8-gas---remove-aragon-calls-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Gas - Remove Aragon calls for gas savings (engn33r)
        
        
      </h3>
    

<p>The VotingEscrow.vy contract contains some functions that primarily serve as compatibility interfaces when using Aragon. If Aragon compatibility is not needed, these functions can be removed.</p>
      <h4 id="proof-of-concept-17">
        
        
          <a href="#proof-of-concept-17" class="anchor-heading" aria-labelledby="proof-of-concept-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The following functions include comments indicating they are fulling or partially used for Aragon compatibility, and may not otherwise be necessary:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">version</code> state variable and <code class="language-plaintext highlighter-rouge">_version</code> init parameter https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L155</li>
  <li><code class="language-plaintext highlighter-rouge">controller()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L129-L131</li>
  <li><code class="language-plaintext highlighter-rouge">transfersEnabled()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L129-L131</li>
  <li><code class="language-plaintext highlighter-rouge">balanceOf()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L650</li>
  <li><code class="language-plaintext highlighter-rouge">totalSupply()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L772</li>
  <li><code class="language-plaintext highlighter-rouge">changeController()</code> https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L831-L837</li>
</ol>
      <h4 id="impact-17">
        
        
          <a href="#impact-17" class="anchor-heading" aria-labelledby="impact-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-17">
        
        
          <a href="#recommendation-17" class="anchor-heading" aria-labelledby="recommendation-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove unnecessary functionality copied from the original Curve contract for gas savings. This was mentioned to veYFI devs while the review was ongoing and a fix was carried out before the review concluded in <a href="https://github.com/yearn/veYFI/pull/131">PR 131</a>, although the <code class="language-plaintext highlighter-rouge">balanceOf()</code> and <code class="language-plaintext highlighter-rouge">totalSupply()</code> functions were left unchanged.</p>
      <h4 id="developer-response-17">
        
        
          <a href="#developer-response-17" class="anchor-heading" aria-labelledby="developer-response-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="9-gas---inconsistent-zero-case-in-votingescrowvy-engn33r">
        
        
          <a href="#9-gas---inconsistent-zero-case-in-votingescrowvy-engn33r" class="anchor-heading" aria-labelledby="9-gas---inconsistent-zero-case-in-votingescrowvy-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Gas - Inconsistent zero case in VotingEscrow.vy (engn33r)
        
        
      </h3>
    

<p>The VotingEscrow.vy contract has two similar functions, <code class="language-plaintext highlighter-rouge">balanceOfAt()</code> and <code class="language-plaintext highlighter-rouge">balanceOf()</code>, which have been modified from the original Curve contract. The <code class="language-plaintext highlighter-rouge">upoint.bias</code> zero case is handled differently in the two functions. Using the lower gas solution in both would be better.</p>
      <h4 id="proof-of-concept-18">
        
        
          <a href="#proof-of-concept-18" class="anchor-heading" aria-labelledby="proof-of-concept-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">balanceOf()</code> function uses this code:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if upoint.bias &lt; 0:
    upoint.bias = 0
    return   convert(upoint.bias, uint256)
</code></pre></div></div>

<p>while the <code class="language-plaintext highlighter-rouge">balanceOfAt()</code> function uses this code:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if upoint.bias &gt;= 0:
    return convert(upoint.bias, uint256)
else:
    return 0
</code></pre></div></div>
      <h4 id="impact-18">
        
        
          <a href="#impact-18" class="anchor-heading" aria-labelledby="impact-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-18">
        
        
          <a href="#recommendation-18" class="anchor-heading" aria-labelledby="recommendation-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use the <code class="language-plaintext highlighter-rouge">balanceOfAt()</code> function’s if/else code in <code class="language-plaintext highlighter-rouge">balanceOf()</code> to avoid calling <code class="language-plaintext highlighter-rouge">convert()</code> for the zero case.</p>
      <h4 id="developer-response-18">
        
        
          <a href="#developer-response-18" class="anchor-heading" aria-labelledby="developer-response-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix, disputed. I think this is not correct and the gas usage is the same.</p>
      <h3 id="10-gas---remove-duplicated-code-engn33r">
        
        
          <a href="#10-gas---remove-duplicated-code-engn33r" class="anchor-heading" aria-labelledby="10-gas---remove-duplicated-code-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Gas - Remove duplicated code (engn33r)
        
        
      </h3>
    

<p>The BaseGauge.sol <code class="language-plaintext highlighter-rouge">queueNewRewards()</code> function contains duplicated code. This can be simplified to save on deployment and reduce code complexity. There might be slightly more gas spent on function calls where <code class="language-plaintext highlighter-rouge">block.timestamp &gt;= periodFinish</code> because unnecessary math for elapsedSinceBeginingOfPeriod and distributedSoFar will be performed in this case, but deployment gas may be important because the BaseGauge.sol contract is inherited in many places.</p>
      <h4 id="proof-of-concept-19">
        
        
          <a href="#proof-of-concept-19" class="anchor-heading" aria-labelledby="proof-of-concept-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The logic for the case <code class="language-plaintext highlighter-rouge">block.timestamp &gt;= periodFinish</code> and <code class="language-plaintext highlighter-rouge">(distributedSoFar * 12) / 10 &lt; _amount</code> is the same, so they can be placed into the same if statement.</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L146-L150</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L156-L162</li>
</ul>

<p>The revised <code class="language-plaintext highlighter-rouge">queueNewRewards()</code> function can look like this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function queueNewRewards(uint256 _amount) external override returns (bool) {
    require(_amount != 0, "==0");
    SafeERC20.safeTransferFrom(
        IERC20(rewardToken),
        msg.sender,
        address(this),
        _amount
    );
    emit RewardsQueued(msg.sender, _amount);
    _amount = _amount + queuedRewards;

    uint256 elapsedSinceBeginingOfPeriod = block.timestamp -
        (periodFinish - duration);
    uint256 distributedSoFar = elapsedSinceBeginingOfPeriod * rewardRate;
    // we only restart a new week if _amount is 120% of distributedSoFar.

    if (block.timestamp &gt;= periodFinish || (distributedSoFar * 12) / 10 &lt; _amount) {
        _notifyRewardAmount(_amount);
        queuedRewards = 0;
    } else {
        queuedRewards = _amount;
    }
    return true;
}
</code></pre></div></div>
      <h4 id="impact-19">
        
        
          <a href="#impact-19" class="anchor-heading" aria-labelledby="impact-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-19">
        
        
          <a href="#recommendation-19" class="anchor-heading" aria-labelledby="recommendation-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use simplified code from above.</p>
      <h4 id="developer-response-19">
        
        
          <a href="#developer-response-19" class="anchor-heading" aria-labelledby="developer-response-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix. This will save deployement gas but creates and computes two variables that might not be needed.</p>
      <h3 id="11-gas---sload-gas-savings-engn33r">
        
        
          <a href="#11-gas---sload-gas-savings-engn33r" class="anchor-heading" aria-labelledby="11-gas---sload-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Gas - SLOAD gas savings (engn33r)
        
        
      </h3>
    

<p>The BaseGauge.sol <code class="language-plaintext highlighter-rouge">setDuration()</code> function can use a minor gas savings.</p>
      <h4 id="proof-of-concept-20">
        
        
          <a href="#proof-of-concept-20" class="anchor-heading" aria-labelledby="proof-of-concept-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Existing code
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L80-L84</p>

<p>Modified code to use local variable instead of state variable in emit</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (block.timestamp &lt; periodFinish) {
    uint256 remaining = periodFinish - block.timestamp;
    uint256 newRate = remaining * rewardRate / newDuration;
    rewardRate = leftover;
}
duration = newDuration;
emit DurationUpdated(newDuration, newRate);
</code></pre></div></div>

<p>A similar type of improvement can be made in Registry.sol
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Registry.sol#L95-L96
The code can be modified to</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>address gauge = gauges[_vault];
require(gauge != address(0x0), "!exist");
</code></pre></div></div>
      <h4 id="impact-20">
        
        
          <a href="#impact-20" class="anchor-heading" aria-labelledby="impact-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-20">
        
        
          <a href="#recommendation-20" class="anchor-heading" aria-labelledby="recommendation-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use modified code snippets above.</p>
      <h4 id="developer-response-20">
        
        
          <a href="#developer-response-20" class="anchor-heading" aria-labelledby="developer-response-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h2 id="informational-findings">
        
        
          <a href="#informational-findings" class="anchor-heading" aria-labelledby="informational-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Informational Findings
        
        
      </h2>
    
      <h3 id="1-informational---safeerc20-functions-not-used-engn33r">
        
        
          <a href="#1-informational---safeerc20-functions-not-used-engn33r" class="anchor-heading" aria-labelledby="1-informational---safeerc20-functions-not-used-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Informational - SafeERC20 functions not used (engn33r)
        
        
      </h3>
    

<p>The ERC20 <code class="language-plaintext highlighter-rouge">approve()</code> function is used several times, but there can be security benefits to using the <code class="language-plaintext highlighter-rouge">safeIncreaseAllowance()</code> and <code class="language-plaintext highlighter-rouge">safeDecreaseAllowance()</code> functions instead to prevent double spend attacks. This improvement was noted in <a href="https://github.com/yearn/veYFI/issues/69">issue 69</a> but was not properly applied.</p>
      <h4 id="proof-of-concept-21">
        
        
          <a href="#proof-of-concept-21" class="anchor-heading" aria-labelledby="proof-of-concept-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Gauge.sol line 500 =&gt; <code class="language-plaintext highlighter-rouge">rewardToken.approve(address(veToken), reward);</code>
Gauge.sol line 527 =&gt; <code class="language-plaintext highlighter-rouge">IERC20(rewardToken).approve(veYfiRewardPool, toTransfer);</code>
VeYfiRewards.sol line 140 =&gt; <code class="language-plaintext highlighter-rouge">rewardToken.approve(address(veToken), reward);</code></p>
      <h4 id="impact-21">
        
        
          <a href="#impact-21" class="anchor-heading" aria-labelledby="impact-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational. The return value is not checked so it is possible that an error occurs and the code doesn’t revert when it should. The risk may be elevated if the rewardToken is an arbitrary ERC20 token.</p>
      <h4 id="recommendation-21">
        
        
          <a href="#recommendation-21" class="anchor-heading" aria-labelledby="recommendation-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use the <code class="language-plaintext highlighter-rouge">safeIncreaseAllowance()</code> and <code class="language-plaintext highlighter-rouge">safeDecreaseAllowance()</code> functions if there is a possibility that the ERC20 tokens getting approved may not revert when an approve call fails.</p>
      <h4 id="developer-response-21">
        
        
          <a href="#developer-response-21" class="anchor-heading" aria-labelledby="developer-response-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Won’t fix</p>
      <h3 id="2-informational---unspecified-voting-requirements-engn33r">
        
        
          <a href="#2-informational---unspecified-voting-requirements-engn33r" class="anchor-heading" aria-labelledby="2-informational---unspecified-voting-requirements-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Informational - Unspecified Voting Requirements (engn33r)
        
        
      </h3>
    

<p>Voting on snapshot.org requires a voting strategy to be selected for each proposal, and no voting strategy is chosen for veYFI yet. veYFI is borrowing significantly from Curve and may use the same erc20-balance-of voting strategy, but there are some differences between veYFI and Curve (veYFI supports vote delegation, Curve does not) and some of the veYFI contract code makes assumptions about how the off-chain voting strategy will work. If these contract assumptions do not match how the voting strategy actually works, the off-chain voting process may not align with how the on-chain code intends.</p>
      <h4 id="proof-of-concept-22">
        
        
          <a href="#proof-of-concept-22" class="anchor-heading" aria-labelledby="proof-of-concept-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There are built-in voting assumptions in the contract code, mostly borrowed from Convex:</p>
<ol>
  <li>When a proposal is created, the <code class="language-plaintext highlighter-rouge">checkpoint()</code> function in VotingEscrow.vy should be called to properly set the epoch</li>
  <li>Voting power should be calculated using the on-chain functions such as <code class="language-plaintext highlighter-rouge">get_last_user_slope()</code>, <code class="language-plaintext highlighter-rouge">balanceOf()</code>, <code class="language-plaintext highlighter-rouge">balanceOfAt()</code>, <code class="language-plaintext highlighter-rouge">supplyAt()</code>, <code class="language-plaintext highlighter-rouge">totalSupply()</code>, and <code class="language-plaintext highlighter-rouge">totalSupplyAt()</code> in VotingEscrow.vy. Note that some of the math in these calculations could be moved to an off-chain voting strategy for gas savings</li>
  <li>Voting for a proposal with veYFI is allowed as soon as the veYFI is locked. Because there is potential for gamification in increasing veYFI stake shortly before key votes, 
 protocols like Convex have implemented <a href="https://docs.convexfinance.com/convexfinance/general-information/voting-and-gauge-weights/vote-locking">a minimum locking duration of several weeks</a> before a token holder can vote, which is implemented in their <a href="https://github.com/convex-eth/platform/blob/main/contracts/contracts/VotingEligibility.sol">VotingEligibility.sol contract</a>.</li>
</ol>

<p>Some open and unanswered questions include:</p>
<ol>
  <li>Who is allowed to create proposals on snapshot.org?</li>
  <li>How are the results of each snapshot vote converted to on-chain rewards? Is this automated?</li>
  <li>Will all vaults receive a gauge that can be voted for on snapshot.org, even those holding very little value? If so, this could lead to gamification of deprecated or old vaults.</li>
  <li>Is there a maximum allocation a gauge can receive? Is there minimum quorum for governance votes? Convex specifies these values: https://docs.convexfinance.com/convexfinance/general-information/voting-and-gauge-weights</li>
</ol>
      <h4 id="impact-22">
        
        
          <a href="#impact-22" class="anchor-heading" aria-labelledby="impact-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational. Because the off-chain voting is heavily interconnected with the on-chain contracts and unresolved questions leave risk around implementation errors in the off-chain voting proposal or strategy process.</p>
      <h4 id="recommendation-22">
        
        
          <a href="#recommendation-22" class="anchor-heading" aria-labelledby="recommendation-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Several items should be considered:</p>
<ol>
  <li>Choose an off-chain voting strategy from snapshot.org and outline all the assumptions for the voting process. veYFI is borrowing heavily from Convex, but using the same <a href="https://snapshot.org/#/strategy/erc20-balance-of">erc20-balance-of</a> snapshot.org strategy should be thoroughly analyzed given the protocol and liquidity differences between Yearn Finance and Curve.</li>
  <li>Determine whether the gamification risks that Convex attempts to prevent with their voting caps and voting eligibility requirements are problematic enough to add similar modifications to veYFI.</li>
  <li>Consider automatic on-chain execution strategies to reduce centralization risk as outlined in: https://blog.aragon.org/snapshot/</li>
</ol>
      <h4 id="developer-response-22">
        
        
          <a href="#developer-response-22" class="anchor-heading" aria-labelledby="developer-response-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Will fix with snapshot.org integration</p>
      <h3 id="3-informational---variable-naming-inconsistency-engn33r">
        
        
          <a href="#3-informational---variable-naming-inconsistency-engn33r" class="anchor-heading" aria-labelledby="3-informational---variable-naming-inconsistency-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Informational - Variable naming inconsistency (engn33r)
        
        
      </h3>
    

<p>The first input to the <code class="language-plaintext highlighter-rouge">createGauge()</code> is named vault, and is passed to Gauge.sol <code class="language-plaintext highlighter-rouge">initialize()</code>. In <code class="language-plaintext highlighter-rouge">initialize()</code>, this value is named <code class="language-plaintext highlighter-rouge">_stakingToken</code>. If the goal is to allow gauges to correspond to liquidity pools that are NOT yearn vaults, the naming should be consistent through veYFI, otherwise future edits may be made assuming that only yearn vaults are involved. This was mentioned in a comment in <a href="https://github.com/yearn/veYFI/issues/46">issue 46</a>.</p>
      <h4 id="proof-of-concept-23">
        
        
          <a href="#proof-of-concept-23" class="anchor-heading" aria-labelledby="proof-of-concept-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The first input to <code class="language-plaintext highlighter-rouge">initialize()</code> has the following comment
https://github.com/yearn/veYFI/blob/d53465c5f615a04204faed55728840a1e79377fc/contracts/Gauge.sol#L67
<code class="language-plaintext highlighter-rouge">_stakingToken The vault token to stake</code></p>

<p>Elsewhere in veYFI, the naming convention assumes that each gauge corresponds to one Yearn vault. But the name <code class="language-plaintext highlighter-rouge">_stakingToken</code> and the comment in <a href="https://github.com/yearn/veYFI/issues/46">issue 46</a> indicates this might not be correct. This should be clarified in the comments and the variable names.</p>
      <h4 id="impact-23">
        
        
          <a href="#impact-23" class="anchor-heading" aria-labelledby="impact-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-23">
        
        
          <a href="#recommendation-23" class="anchor-heading" aria-labelledby="recommendation-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>If the intention is to limit the value of this input to only permit Yearn vaults, consider verifying whether the vault is in the list of addresses from the <code class="language-plaintext highlighter-rouge">assetsAddresses()</code> function of the AddressesGeneratorV2Vaults contract
https://github.com/yearn/yearn-security/blob/master/SECURITY.md#production-contracts</p>

<p>Otherwise, if this value will not be limited to Yearn vaults, consider renaming the variables that use the word “vault” or add comments in multiple places to clarify this address may not be a yearn vault.</p>
      <h4 id="developer-response-23">
        
        
          <a href="#developer-response-23" class="anchor-heading" aria-labelledby="developer-response-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="4-informational---missing-0-check-in-setduration-engn33r">
        
        
          <a href="#4-informational---missing-0-check-in-setduration-engn33r" class="anchor-heading" aria-labelledby="4-informational---missing-0-check-in-setduration-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Informational - Missing 0 check in <code class="language-plaintext highlighter-rouge">setDuration()</code> (engn33r)
        
        
      </h3>
    

<p>There is no zero check in <code class="language-plaintext highlighter-rouge">setDuration()</code> in BaseGauge.sol. If a duration of zero is chosen, functions like <code class="language-plaintext highlighter-rouge">_notifyRewardAmount()</code> that divide by the duration will revert with a divide by zero error. Zero checks exist on all similar setter functions.</p>
      <h4 id="proof-of-concept-24">
        
        
          <a href="#proof-of-concept-24" class="anchor-heading" aria-labelledby="proof-of-concept-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>If <code class="language-plaintext highlighter-rouge">block.timestamp &lt; periodFinish</code>, then the code will check if newDuration is zero, but this check will not happen if the if statement is skipped when <code class="language-plaintext highlighter-rouge">block.timestamp &gt; periodFinish</code>
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L73</p>

<p>This can cause problems in other functions that divide by the duration
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L170-L177</p>
      <h4 id="impact-24">
        
        
          <a href="#impact-24" class="anchor-heading" aria-labelledby="impact-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational. If the duration is set to zero the owner can change the value to a new non-zero value later</p>
      <h4 id="recommendation-24">
        
        
          <a href="#recommendation-24" class="anchor-heading" aria-labelledby="recommendation-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Add a zero check in the <code class="language-plaintext highlighter-rouge">setDuration()</code> function with <code class="language-plaintext highlighter-rouge">require()</code></p>
      <h4 id="developer-response-24">
        
        
          <a href="#developer-response-24" class="anchor-heading" aria-labelledby="developer-response-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="5-informational---typos-engn33r">
        
        
          <a href="#5-informational---typos-engn33r" class="anchor-heading" aria-labelledby="5-informational---typos-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Informational - Typos (engn33r)
        
        
      </h3>
    

<p>There are some typos that have no impact on code functionality, but fixes could be considered improvements.</p>
      <h4 id="proof-of-concept-25">
        
        
          <a href="#proof-of-concept-25" class="anchor-heading" aria-labelledby="proof-of-concept-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<ol>
  <li>The MAX_DELAGATED variable should be spelled MAX_DELEGATED
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VoteDelegation.sol#L16</li>
  <li>betwwen should be between
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L324</li>
  <li>The last sentence in the ExtraReward.sol contract needs to be fixed, most likely by removing the words “Gauge will”. It reads “Gauge will this contract is used behind multiple delegate proxies.”
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L13-L14</li>
  <li>“claimm veYFI and aditional reward” should be “claim veYFI and additional reward” (two typos)
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L373</li>
  <li>Triger should be Trigger
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L131</li>
  <li>veYFITotalSypply should be veYFITotalSupply
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L284</li>
  <li>“rewards are distributed during 7 days” should says “rewards are distributed during reward duration” because duration is a variable and could change
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L12</li>
  <li>“over a week” should say “over the reward duration” because duration is a variable and could change
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L130</li>
  <li>“restart a new week” should say “restart a new reward duration” because duration is a variable and could change
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/BaseGauge.sol#L154</li>
  <li>A reference to CRV exists in the vyper code. Change ERC20CRV to ERC20YFI
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L152</li>
  <li>“earning for an account” should be “earnings for an account”
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L248-L249</li>
  <li>“address acccount” should be “address account”
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L219</li>
</ol>
      <h4 id="impact-25">
        
        
          <a href="#impact-25" class="anchor-heading" aria-labelledby="impact-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-25">
        
        
          <a href="#recommendation-25" class="anchor-heading" aria-labelledby="recommendation-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Fix typos</p>
      <h4 id="developer-response-25">
        
        
          <a href="#developer-response-25" class="anchor-heading" aria-labelledby="developer-response-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="6-informational---replace-magic-numbers-with-constants-engn33r">
        
        
          <a href="#6-informational---replace-magic-numbers-with-constants-engn33r" class="anchor-heading" aria-labelledby="6-informational---replace-magic-numbers-with-constants-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Informational - Replace magic numbers with constants (engn33r)
        
        
      </h3>
    

<p>Constant variables should be used in place of magic numbers to prevent typos. The magic number <code class="language-plaintext highlighter-rouge">1e18</code> is found in multiple places in YieldStreamer.sol and should be replaced with a constant. Using a constant also adds a description using the variable name to explain what this value is for.</p>
      <h4 id="proof-of-concept-26">
        
        
          <a href="#proof-of-concept-26" class="anchor-heading" aria-labelledby="proof-of-concept-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The value 1e18 appears throughout the contracts</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VeYfiRewards.sol#L62</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VeYfiRewards.sol#L69</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L245</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L274</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L280</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L75</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L86</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L92</li>
</ul>
      <h4 id="impact-26">
        
        
          <a href="#impact-26" class="anchor-heading" aria-labelledby="impact-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-26">
        
        
          <a href="#recommendation-26" class="anchor-heading" aria-labelledby="recommendation-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use constant variables instead of magic numbers.</p>
      <h4 id="developer-response-26">
        
        
          <a href="#developer-response-26" class="anchor-heading" aria-labelledby="developer-response-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="7-informational---code-inconsistency-engn33r">
        
        
          <a href="#7-informational---code-inconsistency-engn33r" class="anchor-heading" aria-labelledby="7-informational---code-inconsistency-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Informational - Code inconsistency (engn33r)
        
        
      </h3>
    

<p>There are three <code class="language-plaintext highlighter-rouge">_updateReward()</code> functions in veYFI. The Gauge.sol <code class="language-plaintext highlighter-rouge">_updateReward()</code> function includes a check if <code class="language-plaintext highlighter-rouge">(_balances[account] != 0)</code> while the other two functions do not. It is unclear if this check should be added to the other functions or can be removed from Gauge.sol, but the developers should compare these three implementations for differences.</p>
      <h4 id="proof-of-concept-27">
        
        
          <a href="#proof-of-concept-27" class="anchor-heading" aria-labelledby="proof-of-concept-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The three different <code class="language-plaintext highlighter-rouge">_updateReward()</code> functions</p>
<ol>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/ExtraReward.sol#L44</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VeYfiRewards.sol#L36</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L183</li>
</ol>
      <h4 id="impact-27">
        
        
          <a href="#impact-27" class="anchor-heading" aria-labelledby="impact-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-27">
        
        
          <a href="#recommendation-27" class="anchor-heading" aria-labelledby="recommendation-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use consistent logic in similar functions.</p>
      <h4 id="developer-response-27">
        
        
          <a href="#developer-response-27" class="anchor-heading" aria-labelledby="developer-response-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>This is to distribute veYFI incentives which only applies the Gauge.</p>
      <h3 id="8-informational---curve-safety-check-removed-engn33r">
        
        
          <a href="#8-informational---curve-safety-check-removed-engn33r" class="anchor-heading" aria-labelledby="8-informational---curve-safety-check-removed-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Informational - Curve safety check removed (engn33r)
        
        
      </h3>
    

<p>There is a check in Curve’s VotingEscrow.vy to prevent contracts from calling certain functions related to increase the amount of locked ve tokens. This is most likely to prevent a rare scenario where a perfect storm is created when:</p>
<ol>
  <li>A user has granted the ve token contract infinite allowance</li>
  <li>The user has a large amount of tokens that they purposefully have not locked</li>
  <li>The user interact with a malicious contract that acts as a proxy to lock the user’s tokens in the ve token contract</li>
</ol>

<p>If this sequence of events occurs, the user will not be able to withdraw their locked tokens without a loss of value. However, this is a minor problem compared to most interactions with malicious contracts, so it may be reasonable to remove this check and allow contract interaction with these functions.</p>
      <h4 id="proof-of-concept-28">
        
        
          <a href="#proof-of-concept-28" class="anchor-heading" aria-labelledby="proof-of-concept-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>This is the check in Curve:</p>
<ul>
  <li>https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L418</li>
  <li>https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L438</li>
  <li>https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L455</li>
</ul>

<p>The check does not exist in the same locations in the veYFI VotingEscrow contract:</p>
<ul>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L458</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L496</li>
  <li>https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L512</li>
</ul>

<p>If this check is added to veYFI, it should also be added to createLockFor, a function that Curve does not have:
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L477</p>
      <h4 id="impact-28">
        
        
          <a href="#impact-28" class="anchor-heading" aria-labelledby="impact-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational. This check only adds value if a user interacts with a malicious contract and has non-zero allowance to transfer to the veYFI contract which is an extreme edge case that doesn’t necessarily need special handling.</p>
      <h4 id="recommendation-28">
        
        
          <a href="#recommendation-28" class="anchor-heading" aria-labelledby="recommendation-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Consider reintroducing the <code class="language-plaintext highlighter-rouge">self.assert_not_contract(msg.sender)</code> check found in the original Curve code in the locations mentioned above.</p>
      <h4 id="developer-response-28">
        
        
          <a href="#developer-response-28" class="anchor-heading" aria-labelledby="developer-response-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>The checks are to prevent contract to tokenize crv locks unless they are whitelisted.</p>
      <h3 id="9-informational---no-migratelock-sample-implementation-engn33r">
        
        
          <a href="#9-informational---no-migratelock-sample-implementation-engn33r" class="anchor-heading" aria-labelledby="9-informational---no-migratelock-sample-implementation-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Informational - No migrateLock sample implementation (engn33r)
        
        
      </h3>
    

<p>The veYFI contract can be migrated. The migrator contract will need to implement the <code class="language-plaintext highlighter-rouge">migrateLock()</code> function, which is called by the existing implementation of veYFI. No sample implementation of this function is in veYFI, meaning that a core piece of the migration functionality was not examined in this review.</p>
      <h4 id="proof-of-concept-29">
        
        
          <a href="#proof-of-concept-29" class="anchor-heading" aria-labelledby="proof-of-concept-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">migrateLock()</code> call in the existing veYFI code:
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/VotingEscrow.vy#L606</p>
      <h4 id="impact-29">
        
        
          <a href="#impact-29" class="anchor-heading" aria-labelledby="impact-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-29">
        
        
          <a href="#recommendation-29" class="anchor-heading" aria-labelledby="recommendation-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Consider creating a reference implementation for the <code class="language-plaintext highlighter-rouge">migrateLock()</code> function before deploying veYFI so any last minute changes in veYFI that can make the lock migration easier can be handled in advance. This is especially important if the migrate function might be used in an emergency situation.</p>
      <h4 id="developer-response-29">
        
        
          <a href="#developer-response-29" class="anchor-heading" aria-labelledby="developer-response-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>That will be done when needed.</p>
      <h3 id="10-informational---use---to-keep-code-concise-engn33r">
        
        
          <a href="#10-informational---use---to-keep-code-concise-engn33r" class="anchor-heading" aria-labelledby="10-informational---use---to-keep-code-concise-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Informational - Use -= to keep code concise (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">withdraw()</code> function of Gauge.sol can use -= to reduce code complexity.</p>
      <h4 id="proof-of-concept-30">
        
        
          <a href="#proof-of-concept-30" class="anchor-heading" aria-labelledby="proof-of-concept-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">+=</code> operator is used often in veYFI, but the <code class="language-plaintext highlighter-rouge">-=</code> operator is not used in this line
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L391</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_balances[msg.sender] = _balances[msg.sender] - _amount;
</code></pre></div></div>

<p>Consider changing this line to</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_balances[msg.sender] -= _amount;
</code></pre></div></div>
      <h4 id="impact-30">
        
        
          <a href="#impact-30" class="anchor-heading" aria-labelledby="impact-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-30">
        
        
          <a href="#recommendation-30" class="anchor-heading" aria-labelledby="recommendation-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use <code class="language-plaintext highlighter-rouge">-=</code> when available for concise code.</p>
      <h4 id="developer-response-30">
        
        
          <a href="#developer-response-30" class="anchor-heading" aria-labelledby="developer-response-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>Fixed</p>
      <h3 id="11-informational---update-rewards-for-other-users-engn33r">
        
        
          <a href="#11-informational---update-rewards-for-other-users-engn33r" class="anchor-heading" aria-labelledby="11-informational---update-rewards-for-other-users-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Informational - Update rewards for other users (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">depositFor()</code> function in Gauge.sol allows the <code class="language-plaintext highlighter-rouge">_updateReward()</code> function to be called for other depositors. This may lead to an attack where a depositor in a gauge finds a way to reduce the rewards for other depositors of the same gauge, possibly similar to the flash loan method mentioned in Medium #3, and calling <code class="language-plaintext highlighter-rouge">depositFor()</code> with an extremely small value to trigger <code class="language-plaintext highlighter-rouge">_updateReward()</code> to update the checkpoint for the other depositors. The attacker may be able to take more rewards from the gauge than they could otherwise. This was noticed at the very end of the review so examination of an attack vector was not performed.</p>
      <h4 id="proof-of-concept-31">
        
        
          <a href="#proof-of-concept-31" class="anchor-heading" aria-labelledby="proof-of-concept-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">depositFor()</code> function:
https://github.com/YAcademy-Residents/veYFI/blob/master/contracts/Gauge.sol#L344</p>
      <h4 id="impact-31">
        
        
          <a href="#impact-31" class="anchor-heading" aria-labelledby="impact-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-31">
        
        
          <a href="#recommendation-31" class="anchor-heading" aria-labelledby="recommendation-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>If there is no strong use case for <code class="language-plaintext highlighter-rouge">depositFor()</code>, removing this function would be the safest approach.</p>
      <h4 id="developer-response-31">
        
        
          <a href="#developer-response-31" class="anchor-heading" aria-labelledby="developer-response-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer Response
        
        
      </h4>
    

<p>An approval mechanism has been added to the contract to whitelist addresses that has been allowed to deposit on your behalf: https://github.com/yearn/veYFI/blob/83d62f9e03ef0cc463aa31c36ce23cd3d7c184eb/contracts/Gauge.sol#L376</p>
      <h2 id="final-remarks">
        
        
          <a href="#final-remarks" class="anchor-heading" aria-labelledby="final-remarks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Final remarks
        
        
      </h2>
    
      <h3 id="engn33r">
        
        
          <a href="#engn33r" class="anchor-heading" aria-labelledby="engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> engn33r
        
        
      </h3>
    

<p>I focused on the voting mechanics because there have been bugs here on similar projects. Once the voting implementation is fully completed and reviewed, I think veYFI will look more solid. There are some minor edge cases in the rewards system that can be ironed out, but the most critical deposit, withdraw, lock, and rewards functions look like they have been thoughtfully pieced together into a cohesive solution. Improvements to the overall documentation of the veYFI contracts and inclusion of <a href="https://docs.convexfinance.com/convexfinance/general-information/voting-and-gauge-weights/vote-locking">similar protective measures to Convex</a> are nice-to-have improvements.</p>
      <h3 id="nibblerexpress">
        
        
          <a href="#nibblerexpress" class="anchor-heading" aria-labelledby="nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> NibblerExpress
        
        
      </h3>
    

<p>I looked for ways to attack the deposit, withdraw, and reward functions to receive excess rewards or to block others from receiving rewards. I was unable to find attacks that circumvented the reward checkpointing or that manipulated the voting escrow contract. The problems seemed to be in how rewards were actually calculated. The reward formula should be reviewed to ensure that the contract is more precisely incentivizing the desired behaviors. I did not take a close look at how voting would occur outside the contract and what mischief could be caused by malicious proposals.</p>
      <h2 id="about-yacademy">
        
        
          <a href="#about-yacademy" class="anchor-heading" aria-labelledby="about-yacademy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> About yAcademy
        
        
      </h2>
    
<p>yAcademy is an ecosystem initiative started by Yearn Finance and its ecosystem partners to bootstrap sustainable and collaborative blockchain security reviews and to nurture aspiring security talent. yAcademy includes a fellowship program and a residents program. In the fellowship program, fellows perform a series of periodic security reviews and presentations during the program. Residents are past fellows who continue to gain experience by performing security reviews of contracts submitted to yAcademy for review (such as this contract).</p>
      <h2 id="appendix-and-faq">
        
        
          <a href="#appendix-and-faq" class="anchor-heading" aria-labelledby="appendix-and-faq"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Appendix and FAQ
        
        
      </h2>

        

        

        
        
          <hr>
          <footer>
            
              <p><a href="#top" id="back-to-top">Back to top</a></p>
            

            

            
              <div class="d-flex mt-2">
                
                
              </div>
            
          </footer>
        

      </div>
    </div>

    
      

      <div class="search-overlay"></div>
    
  </div>
  <link rel="image_src" href="https://yaudit.dev/assets/images/logo.png" />
</body>

  <script>
    var config = {}
;
    mermaid.initialize(config);
    window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
  </script>

</html>

