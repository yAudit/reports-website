

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">


  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  

  
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script>
  

  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>
  <script defer data-domain="reports.yAudit.dev" src="https://plausible.io/js/script.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>05-2022-OpenMEV | yAudit Reports</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="05-2022-OpenMEV" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="OpenMEV yAcademy Report" />
<meta property="og:description" content="OpenMEV yAcademy Report" />
<link rel="canonical" href="http://localhost:4000/reports/05-2022-OpenMEVRouter/" />
<meta property="og:url" content="http://localhost:4000/reports/05-2022-OpenMEVRouter/" />
<meta property="og:site_name" content="yAudit Reports" />
<meta property="og:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="twitter:title" content="05-2022-OpenMEV" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"OpenMEV yAcademy Report","headline":"05-2022-OpenMEV","image":"http://localhost:4000/assets/images/logo.png","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/yaudit-logo.jpg"}},"url":"http://localhost:4000/reports/05-2022-OpenMEVRouter/"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <a class="skip-to-main" href="#main-content">Skip to main content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
    <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE -->
<symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link">
  <title id="svg-external-link-title">(external link)</title>
  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line>
</symbol>

  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="/" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
      
        <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">yAudit Reports</a></li><li class="nav-list-item"><a href="/reports/03-2022-Ohm/" class="nav-list-link">03-2022-Ohm</a></li><li class="nav-list-item"><a href="/reports/04-2022-Ohm-Bond/" class="nav-list-link">04-2022-Ohm-Bond</a></li><li class="nav-list-item"><a href="/reports/04-2022-veYFI/" class="nav-list-link">04-2022-veYFI</a></li><li class="nav-list-item active"><a href="/reports/05-2022-OpenMEVRouter/" class="nav-list-link active">05-2022-OpenMEV</a></li><li class="nav-list-item"><a href="/reports/08-2022-Bunni/" class="nav-list-link">08-2022-Bunni</a></li><li class="nav-list-item"><a href="/reports/08-2022-Timeless-Yield-Daddy/" class="nav-list-link">08-2022-Timeless-Yield-Daddy</a></li><li class="nav-list-item"><a href="/reports/09-2022-yFu-NFT/" class="nav-list-link">09-2022-yFu-NFT</a></li><li class="nav-list-item"><a href="/reports/10-2022-NounsDAO-Token-Buyer/" class="nav-list-link">10-2022-NounsDAO-Token-Buyer</a></li><li class="nav-list-item"><a href="/reports/12-2022-Gro-Protocol/" class="nav-list-link">12-2022-Gro-Protocol</a></li><li class="nav-list-item external">
      <a href="https://yaudit.dev/" class="nav-list-link external">
        yAudit Website
        <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg>
      </a>
    </li></ul>
      
      
    </nav>

    
    
      <footer class="site-footer">
        <!-- This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. -->
      </footer>
    
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      

        

        <div class="search">
          <div class="search-input-wrap">
            <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search yAudit Reports" aria-label="Search yAudit Reports" autocomplete="off">
            <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      
      
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <h1 class="no_toc" id="yacademy-openmev-review">
        
        
          <a href="#yacademy-openmev-review" class="anchor-heading" aria-labelledby="yacademy-openmev-review"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> yAcademy OpenMEV review
        
        
      </h1>
    

<p><strong>Review Resources:</strong>
<a href="https://github.com/manifoldfinance/OpenMevRouter/wiki">Wiki</a>
<a href="https://github.com/manifoldfinance/OpenMevRouter/tree/main/docs">Docs and whitepaper</a></p>

<p><strong>Residents:</strong></p>
<ul>
  <li>Jackson</li>
  <li>engn33r</li>
</ul>
      <h2 class="no_toc" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#review-summary" id="markdown-toc-review-summary">Review Summary</a></li>
  <li><a href="#scope" id="markdown-toc-scope">Scope</a></li>
  <li><a href="#code-evaluation-matrix" id="markdown-toc-code-evaluation-matrix">Code Evaluation Matrix</a></li>
  <li><a href="#findings-explanation" id="markdown-toc-findings-explanation">Findings Explanation</a></li>
  <li><a href="#high-findings" id="markdown-toc-high-findings">High Findings</a>    <ol>
      <li><a href="#1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson" id="markdown-toc-1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson">1. High - The swap and stake mechanisms in OpenMevZapper leave funds in the contract (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept" id="markdown-toc-proof-of-concept">Proof of concept</a></li>
          <li><a href="#impact" id="markdown-toc-impact">Impact</a></li>
          <li><a href="#recommendation" id="markdown-toc-recommendation">Recommendation</a></li>
          <li><a href="#developer-response-sandy" id="markdown-toc-developer-response-sandy">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r" id="markdown-toc-2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r">2. High - Using normal functions for fee-on-transfer tokens causes value loss (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-1" id="markdown-toc-proof-of-concept-1">Proof of concept</a></li>
          <li><a href="#impact-1" id="markdown-toc-impact-1">Impact</a></li>
          <li><a href="#recommendation-1" id="markdown-toc-recommendation-1">Recommendation</a></li>
          <li><a href="#developer-response-sandy-1" id="markdown-toc-developer-response-sandy-1">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r" id="markdown-toc-3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r">3. High - Backrun arb not designed for fee-on-transfer tokens (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-2" id="markdown-toc-proof-of-concept-2">Proof of concept</a></li>
          <li><a href="#impact-2" id="markdown-toc-impact-2">Impact</a></li>
          <li><a href="#recommendation-2" id="markdown-toc-recommendation-2">Recommendation</a></li>
          <li><a href="#developer-response-sandy-2" id="markdown-toc-developer-response-sandy-2">Developer response (Sandy)</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#medium-findings" id="markdown-toc-medium-findings">Medium Findings</a>    <ol>
      <li><a href="#1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson" id="markdown-toc-1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson">1. Medium - Failed flashloan arbitrage reverts the original swap (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-3" id="markdown-toc-proof-of-concept-3">Proof of concept</a></li>
          <li><a href="#impact-3" id="markdown-toc-impact-3">Impact</a></li>
          <li><a href="#recommendation-3" id="markdown-toc-recommendation-3">Recommendation</a></li>
          <li><a href="#developer-response-sandy-3" id="markdown-toc-developer-response-sandy-3">Developer response (Sandy)</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#low-findings" id="markdown-toc-low-findings">Low Findings</a>    <ol>
      <li><a href="#1-low---edge-case-suboptimal-arb-profit-engn33r" id="markdown-toc-1-low---edge-case-suboptimal-arb-profit-engn33r">1. Low - Edge case suboptimal arb profit (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-4" id="markdown-toc-proof-of-concept-4">Proof of concept</a></li>
          <li><a href="#impact-4" id="markdown-toc-impact-4">Impact</a></li>
          <li><a href="#recommendation-4" id="markdown-toc-recommendation-4">Recommendation</a></li>
          <li><a href="#developer-response-sandy-4" id="markdown-toc-developer-response-sandy-4">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r" id="markdown-toc-2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r">2. Low - One failed arb can revert otherwise profitable arb (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-5" id="markdown-toc-proof-of-concept-5">Proof of concept</a></li>
          <li><a href="#impact-5" id="markdown-toc-impact-5">Impact</a></li>
          <li><a href="#recommendation-5" id="markdown-toc-recommendation-5">Recommendation</a></li>
          <li><a href="#developer-response-sandy-5" id="markdown-toc-developer-response-sandy-5">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#3-low---max-approval-granted-to-spender-jackson" id="markdown-toc-3-low---max-approval-granted-to-spender-jackson">3. Low - Max approval granted to spender (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-6" id="markdown-toc-proof-of-concept-6">Proof of concept</a></li>
          <li><a href="#impact-6" id="markdown-toc-impact-6">Impact</a></li>
          <li><a href="#recommendation-6" id="markdown-toc-recommendation-6">Recommendation</a></li>
          <li><a href="#developer-response-sandy-6" id="markdown-toc-developer-response-sandy-6">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#4-low---no-check-for-aave-flashloan-balance-jackson" id="markdown-toc-4-low---no-check-for-aave-flashloan-balance-jackson">4. Low - No check For Aave flashloan balance (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-7" id="markdown-toc-proof-of-concept-7">Proof of concept</a></li>
          <li><a href="#impact-7" id="markdown-toc-impact-7">Impact</a></li>
          <li><a href="#recommendation-7" id="markdown-toc-recommendation-7">Recommendation</a></li>
          <li><a href="#developer-response-sandy-7" id="markdown-toc-developer-response-sandy-7">Developer response (Sandy)</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#gas-savings-findings" id="markdown-toc-gas-savings-findings">Gas Savings Findings</a>    <ol>
      <li><a href="#1-gas---use-_isnonzero-for-gas-savings-engn33r" id="markdown-toc-1-gas---use-_isnonzero-for-gas-savings-engn33r">1. Gas - Use <code class="language-plaintext highlighter-rouge">_isNonZero()</code> for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-8" id="markdown-toc-proof-of-concept-8">Proof of Concept</a></li>
          <li><a href="#impact-8" id="markdown-toc-impact-8">Impact</a></li>
          <li><a href="#recommendation-8" id="markdown-toc-recommendation-8">Recommendation</a></li>
          <li><a href="#developer-response-sandy-8" id="markdown-toc-developer-response-sandy-8">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r" id="markdown-toc-2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r">2. Gas - Use <code class="language-plaintext highlighter-rouge">_inc()</code> instead of <code class="language-plaintext highlighter-rouge">++</code> and <code class="language-plaintext highlighter-rouge">_dec()</code> instead of <code class="language-plaintext highlighter-rouge">--</code> (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-9" id="markdown-toc-proof-of-concept-9">Proof of concept</a></li>
          <li><a href="#impact-9" id="markdown-toc-impact-9">Impact</a></li>
          <li><a href="#recommendation-9" id="markdown-toc-recommendation-9">Recommendation</a></li>
          <li><a href="#developer-response-sandy-9" id="markdown-toc-developer-response-sandy-9">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r" id="markdown-toc-3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r">3. Gas - Bitshifting is cheaper than multiplication or division (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-10" id="markdown-toc-proof-of-concept-10">Proof of concept</a></li>
          <li><a href="#impact-10" id="markdown-toc-impact-10">Impact</a></li>
          <li><a href="#recommendation-10" id="markdown-toc-recommendation-10">Recommendation</a></li>
          <li><a href="#developer-response-sandy-10" id="markdown-toc-developer-response-sandy-10">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#4-gas---unnecessary-zero-initialization-engn33r" id="markdown-toc-4-gas---unnecessary-zero-initialization-engn33r">4. Gas - Unnecessary zero initialization (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-11" id="markdown-toc-proof-of-concept-11">Proof of Concept</a></li>
          <li><a href="#impact-11" id="markdown-toc-impact-11">Impact</a></li>
          <li><a href="#recommendation-11" id="markdown-toc-recommendation-11">Recommendation</a></li>
          <li><a href="#developer-response-sandy-11" id="markdown-toc-developer-response-sandy-11">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#5-gas---payable-functions-can-save-gas-engn33r" id="markdown-toc-5-gas---payable-functions-can-save-gas-engn33r">5. Gas - Payable functions can save gas (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-12" id="markdown-toc-proof-of-concept-12">Proof of concept</a></li>
          <li><a href="#impact-12" id="markdown-toc-impact-12">Impact</a></li>
          <li><a href="#recommendation-12" id="markdown-toc-recommendation-12">Recommendation</a></li>
          <li><a href="#developer-response-sandy-12" id="markdown-toc-developer-response-sandy-12">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#6-gas---avoid--logic-in-require-statements-engn33r" id="markdown-toc-6-gas---avoid--logic-in-require-statements-engn33r">6. Gas - Avoid &amp;&amp; logic in require statements (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-13" id="markdown-toc-proof-of-concept-13">Proof of concept</a></li>
          <li><a href="#impact-13" id="markdown-toc-impact-13">Impact</a></li>
          <li><a href="#recommendation-13" id="markdown-toc-recommendation-13">Recommendation</a></li>
          <li><a href="#developer-response-sandy-13" id="markdown-toc-developer-response-sandy-13">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#7-gas---declare-constant-internal-when-possible-engn33r" id="markdown-toc-7-gas---declare-constant-internal-when-possible-engn33r">7. Gas - Declare constant internal when possible (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-14" id="markdown-toc-proof-of-concept-14">Proof of concept</a></li>
          <li><a href="#impact-14" id="markdown-toc-impact-14">Impact</a></li>
          <li><a href="#recommendation-14" id="markdown-toc-recommendation-14">Recommendation</a></li>
          <li><a href="#developer-response-sandy-14" id="markdown-toc-developer-response-sandy-14">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#8-gas---replace-require-with-errors-in-openmevrouter-jackson" id="markdown-toc-8-gas---replace-require-with-errors-in-openmevrouter-jackson">8. Gas - Replace require with errors in OpenMevRouter (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-15" id="markdown-toc-proof-of-concept-15">Proof of concept</a></li>
          <li><a href="#impact-15" id="markdown-toc-impact-15">Impact</a></li>
          <li><a href="#recommendation-15" id="markdown-toc-recommendation-15">Recommendation</a></li>
          <li><a href="#developer-response-sandy-15" id="markdown-toc-developer-response-sandy-15">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#9-gas---remove-unused-code-jackson" id="markdown-toc-9-gas---remove-unused-code-jackson">9. Gas - Remove unused code (Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-16" id="markdown-toc-proof-of-concept-16">Proof of concept</a></li>
          <li><a href="#impact-16" id="markdown-toc-impact-16">Impact</a></li>
          <li><a href="#recommendation-16" id="markdown-toc-recommendation-16">Recommendation</a></li>
          <li><a href="#developer-response-sandy-16" id="markdown-toc-developer-response-sandy-16">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#10-gas---use-simple-comparison-engn33r" id="markdown-toc-10-gas---use-simple-comparison-engn33r">10. Gas - Use simple comparison (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-17" id="markdown-toc-proof-of-concept-17">Proof of concept</a></li>
          <li><a href="#impact-17" id="markdown-toc-impact-17">Impact</a></li>
          <li><a href="#recommendation-17" id="markdown-toc-recommendation-17">Recommendation</a></li>
          <li><a href="#developer-response-sandy-17" id="markdown-toc-developer-response-sandy-17">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#11-gas---combine-reserve-value-checks-engn33r" id="markdown-toc-11-gas---combine-reserve-value-checks-engn33r">11. Gas - Combine reserve value checks (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-18" id="markdown-toc-proof-of-concept-18">Proof of concept</a></li>
          <li><a href="#impact-18" id="markdown-toc-impact-18">Impact</a></li>
          <li><a href="#recommendation-18" id="markdown-toc-recommendation-18">Recommendation</a></li>
          <li><a href="#developer-response-sandy-18" id="markdown-toc-developer-response-sandy-18">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#12-gas---use-msg-global-vars-directly-engn33r" id="markdown-toc-12-gas---use-msg-global-vars-directly-engn33r">12. Gas - Use msg global vars directly (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-19" id="markdown-toc-proof-of-concept-19">Proof of concept</a></li>
          <li><a href="#impact-19" id="markdown-toc-impact-19">Impact</a></li>
          <li><a href="#recommendation-19" id="markdown-toc-recommendation-19">Recommendation</a></li>
          <li><a href="#developer-response-sandy-19" id="markdown-toc-developer-response-sandy-19">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#13-gas---remove-duplicate-internal-function-call-engn33r" id="markdown-toc-13-gas---remove-duplicate-internal-function-call-engn33r">13. Gas - Remove duplicate internal function call (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-20" id="markdown-toc-proof-of-concept-20">Proof of concept</a></li>
          <li><a href="#impact-20" id="markdown-toc-impact-20">Impact</a></li>
          <li><a href="#recommendation-20" id="markdown-toc-recommendation-20">Recommendation</a></li>
          <li><a href="#developer-response-sandy-20" id="markdown-toc-developer-response-sandy-20">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#14-gas---deadline-special-case-not-aligned-with-permit-engn33r" id="markdown-toc-14-gas---deadline-special-case-not-aligned-with-permit-engn33r">14. Gas - deadline special case not aligned with permit (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-21" id="markdown-toc-proof-of-concept-21">Proof of concept</a></li>
          <li><a href="#impact-21" id="markdown-toc-impact-21">Impact</a></li>
          <li><a href="#recommendation-21" id="markdown-toc-recommendation-21">Recommendation</a></li>
          <li><a href="#developer-response-sandy-21" id="markdown-toc-developer-response-sandy-21">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#15-gas---replace-pairswap-with-_asmswap-engn33r" id="markdown-toc-15-gas---replace-pairswap-with-_asmswap-engn33r">15. Gas - Replace <code class="language-plaintext highlighter-rouge">pair.swap()</code> with <code class="language-plaintext highlighter-rouge">_asmSwap()</code> (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-22" id="markdown-toc-proof-of-concept-22">Proof of concept</a></li>
          <li><a href="#impact-22" id="markdown-toc-impact-22">Impact</a></li>
          <li><a href="#recommendation-22" id="markdown-toc-recommendation-22">Recommendation</a></li>
          <li><a href="#developer-response-sandy-22" id="markdown-toc-developer-response-sandy-22">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#16-gas---remove-a-sorttokens-call-engn33r" id="markdown-toc-16-gas---remove-a-sorttokens-call-engn33r">16. Gas - Remove a sortTokens call (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-23" id="markdown-toc-proof-of-concept-23">Proof of concept</a></li>
          <li><a href="#impact-23" id="markdown-toc-impact-23">Impact</a></li>
          <li><a href="#recommendation-23" id="markdown-toc-recommendation-23">Recommendation</a></li>
          <li><a href="#developer-response-sandy-23" id="markdown-toc-developer-response-sandy-23">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#17-gas---missing-curly-brace-engn33r" id="markdown-toc-17-gas---missing-curly-brace-engn33r">17. Gas - Missing curly brace (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-24" id="markdown-toc-proof-of-concept-24">Proof of concept</a></li>
          <li><a href="#impact-24" id="markdown-toc-impact-24">Impact</a></li>
          <li><a href="#recommendation-24" id="markdown-toc-recommendation-24">Recommendation</a></li>
          <li><a href="#developer-response-sandy-24" id="markdown-toc-developer-response-sandy-24">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#18-gas---reduce-number-of-swaps-engn33r" id="markdown-toc-18-gas---reduce-number-of-swaps-engn33r">18. Gas - Reduce number of swaps (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-25" id="markdown-toc-proof-of-concept-25">Proof of concept</a></li>
          <li><a href="#impact-25" id="markdown-toc-impact-25">Impact</a></li>
          <li><a href="#recommendation-25" id="markdown-toc-recommendation-25">Recommendation</a></li>
          <li><a href="#developer-response-sandy-25" id="markdown-toc-developer-response-sandy-25">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#19-gas---revert-if-zero-flashloan-profit-engn33r" id="markdown-toc-19-gas---revert-if-zero-flashloan-profit-engn33r">19. Gas - Revert if zero flashloan profit (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-26" id="markdown-toc-proof-of-concept-26">Proof of concept</a></li>
          <li><a href="#impact-26" id="markdown-toc-impact-26">Impact</a></li>
          <li><a href="#recommendation-26" id="markdown-toc-recommendation-26">Recommendation</a></li>
          <li><a href="#developer-response-sandy-26" id="markdown-toc-developer-response-sandy-26">Developer response (Sandy)</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#informational-findings" id="markdown-toc-informational-findings">Informational Findings</a>    <ol>
      <li><a href="#1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson" id="markdown-toc-1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson">1. Informational - OpenMevRouter should inherit from IFlashBorrower and IOpenMevRouter (Jackson)</a>        <ol>
          <li><a href="#impact-27" id="markdown-toc-impact-27">Impact</a></li>
          <li><a href="#developer-response-sandy-27" id="markdown-toc-developer-response-sandy-27">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson" id="markdown-toc-2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson">2. Informational - The ETHERSCAN_API key is present in plaintext (Jackson)</a>        <ol>
          <li><a href="#impact-28" id="markdown-toc-impact-28">Impact</a></li>
          <li><a href="#developer-response-sandy-28" id="markdown-toc-developer-response-sandy-28">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson" id="markdown-toc-3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson">3. Informational - SafeTransferLib does not match Solmate’s main branch (Jackson)</a>        <ol>
          <li><a href="#impact-29" id="markdown-toc-impact-29">Impact</a></li>
          <li><a href="#developer-response-sandy-29" id="markdown-toc-developer-response-sandy-29">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#4-informational---incorrect-comment-engn33r-jackson" id="markdown-toc-4-informational---incorrect-comment-engn33r-jackson">4. Informational - Incorrect comment (engn33r, Jackson)</a>        <ol>
          <li><a href="#proof-of-concept-27" id="markdown-toc-proof-of-concept-27">Proof of concept</a></li>
          <li><a href="#impact-30" id="markdown-toc-impact-30">Impact</a></li>
          <li><a href="#recommendation-27" id="markdown-toc-recommendation-27">Recommendation</a></li>
          <li><a href="#developer-response-sandy-30" id="markdown-toc-developer-response-sandy-30">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#5-informational---replace-magic-numbers-with-constants-engn33r" id="markdown-toc-5-informational---replace-magic-numbers-with-constants-engn33r">5. Informational - Replace magic numbers with constants (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-28" id="markdown-toc-proof-of-concept-28">Proof of concept</a></li>
          <li><a href="#impact-31" id="markdown-toc-impact-31">Impact</a></li>
          <li><a href="#recommendation-28" id="markdown-toc-recommendation-28">Recommendation</a></li>
          <li><a href="#developer-response-sandy-31" id="markdown-toc-developer-response-sandy-31">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#6-informational---typos-engn33r" id="markdown-toc-6-informational---typos-engn33r">6. Informational - Typos (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-29" id="markdown-toc-proof-of-concept-29">Proof of concept</a></li>
          <li><a href="#impact-32" id="markdown-toc-impact-32">Impact</a></li>
          <li><a href="#recommendation-29" id="markdown-toc-recommendation-29">Recommendation</a></li>
          <li><a href="#developer-response-sandy-32" id="markdown-toc-developer-response-sandy-32">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#7-informational---hard-coded-aave-token-list-engn33r" id="markdown-toc-7-informational---hard-coded-aave-token-list-engn33r">7. Informational - Hard coded Aave token list (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-30" id="markdown-toc-proof-of-concept-30">Proof of concept</a></li>
          <li><a href="#impact-33" id="markdown-toc-impact-33">Impact</a></li>
          <li><a href="#recommendation-30" id="markdown-toc-recommendation-30">Recommendation</a></li>
          <li><a href="#developer-response-sandy-33" id="markdown-toc-developer-response-sandy-33">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#8-informational---inconsistency-in-weth-transfers-engn33r" id="markdown-toc-8-informational---inconsistency-in-weth-transfers-engn33r">8. Informational - Inconsistency in WETH transfers (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-31" id="markdown-toc-proof-of-concept-31">Proof of concept</a></li>
          <li><a href="#impact-34" id="markdown-toc-impact-34">Impact</a></li>
          <li><a href="#recommendation-31" id="markdown-toc-recommendation-31">Recommendation</a></li>
          <li><a href="#developer-response-sandy-34" id="markdown-toc-developer-response-sandy-34">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r" id="markdown-toc-9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r">9. Informational - safeApprove vulnerable to double withdraw (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-32" id="markdown-toc-proof-of-concept-32">Proof of concept</a></li>
          <li><a href="#impact-35" id="markdown-toc-impact-35">Impact</a></li>
          <li><a href="#recommendation-32" id="markdown-toc-recommendation-32">Recommendation</a></li>
          <li><a href="#developer-response-sandy-35" id="markdown-toc-developer-response-sandy-35">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r" id="markdown-toc-10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r">10. Informational - Same frontrunning weaknesses as Uniswap/SushiSwap (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-33" id="markdown-toc-proof-of-concept-33">Proof of concept</a></li>
          <li><a href="#impact-36" id="markdown-toc-impact-36">Impact</a></li>
          <li><a href="#recommendation-33" id="markdown-toc-recommendation-33">Recommendation</a></li>
          <li><a href="#developer-response-sandy-36" id="markdown-toc-developer-response-sandy-36">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r" id="markdown-toc-11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r">11. Informational - Kashi flashloanable tokens assumed same as aave (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-34" id="markdown-toc-proof-of-concept-34">Proof of concept</a></li>
          <li><a href="#impact-37" id="markdown-toc-impact-37">Impact</a></li>
          <li><a href="#recommendation-34" id="markdown-toc-recommendation-34">Recommendation</a></li>
          <li><a href="#developer-response-sandy-37" id="markdown-toc-developer-response-sandy-37">Developer response (Sandy)</a></li>
        </ol>
      </li>
      <li><a href="#12-informational----engn33r" id="markdown-toc-12-informational----engn33r">12. Informational -  (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-35" id="markdown-toc-proof-of-concept-35">Proof of concept</a></li>
          <li><a href="#impact-38" id="markdown-toc-impact-38">Impact</a></li>
          <li><a href="#recommendation-35" id="markdown-toc-recommendation-35">Recommendation</a></li>
          <li><a href="#developer-response-sandy-38" id="markdown-toc-developer-response-sandy-38">Developer response (Sandy)</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#final-remarks" id="markdown-toc-final-remarks">Final remarks</a>    <ol>
      <li><a href="#engn33r" id="markdown-toc-engn33r">engn33r</a></li>
      <li><a href="#jackson" id="markdown-toc-jackson">Jackson</a></li>
    </ol>
  </li>
  <li><a href="#about-yacademy" id="markdown-toc-about-yacademy">About yAcademy</a></li>
  <li><a href="#appendix-and-faq" id="markdown-toc-appendix-and-faq">Appendix and FAQ</a></li>
</ol>
      <h2 id="review-summary">
        
        
          <a href="#review-summary" class="anchor-heading" aria-labelledby="review-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Review Summary
        
        
      </h2>
    

<p><strong>OpenMEV</strong></p>

<p>The purpose of OpenMEVRouter is to offer a drop-in replacement to a similar Uniswap/SushiSwap router. While enabling exchanges with UniSwap and SushiSwap, it also protects against direct MEV arbitrage (arb) between the two platforms by performing the arb within the DEX swap process. This leaves no arbitrage opportunities for MEV searches.</p>

<p>The main branch of the OpenMEV <a href="https://github.com/manifoldfinance/OpenMevRouter">Repo</a> was reviewed over 22 days, 4 of which were used to create an initial overview of the contract. The code review was performed between May 12 and June 3, 2022. The code was reviewed by 2 residents for a total of 59 man hours (engn33r: 34 hours, and Jackson 25 hours). The repository was under active development during the review, but the review was limited to <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/8648277c0a89d0091f959948682543bdcf0c280b">one specific commit</a>.</p>
      <h2 id="scope">
        
        
          <a href="#scope" class="anchor-heading" aria-labelledby="scope"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scope
        
        
      </h2>
    
<p><a href="https://github.com/manifoldfinance/OpenMevRouter">Code Repo</a>
<a href="https://github.com/manifoldfinance/OpenMevRouter/commit/8648277c0a89d0091f959948682543bdcf0c280b">Commit</a></p>

<p>The commit reviewed was 8648277c0a89d0091f959948682543bdcf0c280b. The review covered the entire repository at this specific commit but focused on the contracts directory.</p>

<p>After the findings were presented to the OpenMEV team, fixes were made and included in several PRs.</p>

<p>The review was a time-limited review to provide rapid feedback on potential vulnerabilities. The review was not a full audit. The review did not explore all potential attack vectors or areas of vulnerability and may not have identified all potential issues.</p>

<p>yAcademy and the residents make no warranties regarding the security of the code and do not warrant that the code is free from defects. yAcademy and the residents do not represent nor imply to third parties that the code has been audited nor that the code is free from defects. Manifold and third parties should use the code at their own risk.</p>
      <h2 id="code-evaluation-matrix">
        
        
          <a href="#code-evaluation-matrix" class="anchor-heading" aria-labelledby="code-evaluation-matrix"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code Evaluation Matrix
        
        
      </h2>
    

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Category</th>
      <th>Mark</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Access Control</td>
      <td>Good</td>
      <td>The onlyOwner modifier was only applied to the <code class="language-plaintext highlighter-rouge">harvest()</code> function. Access controls existed on the relevant callback functions in OpenMevRouter.sol for flashloans. msg.sender is properly used so that the user cannot perform actions they should not be able to. Access controls are applied where needed.</td>
    </tr>
    <tr>
      <td>Mathematics</td>
      <td>Average</td>
      <td>Solidity 0.8.13 is used, which provides overflow and underflow protect. There was no unusually complex math beyond the Uint512 library. The <code class="language-plaintext highlighter-rouge">sqrt512()</code> function using the Karatsuba Square Root method is an unusual and potentially custom implementation.</td>
    </tr>
    <tr>
      <td>Complexity</td>
      <td>Average</td>
      <td>Many function names and implementations are borrowed from UniswapV2 contracts and BeefySwap’s zapper. This reduces the amount of custom development work necessary. The primary source of complexity is the backrun swap arb process and the equations derived for that purpose.</td>
    </tr>
    <tr>
      <td>Libraries</td>
      <td>Good</td>
      <td>A custom OpenMevLibrary contract is based heavily on the UniswapV2Library contract. The Uint512 contract supports math operations for uint512 integers comprised of two uint256 integers. SafeTransferLib and ERC20 libraries are imported by OpenMevRouter but are commonly used contracts.</td>
    </tr>
    <tr>
      <td>Decentralization</td>
      <td>Good</td>
      <td>The onlyOwner modifier on the <code class="language-plaintext highlighter-rouge">harvest()</code> function indicates there is some centralization risk, but it is expected that Sushi governance will take this role and can be considered a trusted party.</td>
    </tr>
    <tr>
      <td>Code stability</td>
      <td>Good</td>
      <td>Changes were reviewed at a specific commit hash and the scope was not expanded after the review was started. The code reviewed had nearly all features implemented.</td>
    </tr>
    <tr>
      <td>Documentation</td>
      <td>Good</td>
      <td>Descriptive NatSpec comments are found throughout the OpenMevRouter contracts. The comments accurately describe the function purpose and function input/output arguments.</td>
    </tr>
    <tr>
      <td>Monitoring</td>
      <td>Average</td>
      <td>Only <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> emitted an event. However, the UniswapV2 Router does not emit any events and the OpenMevRouter contracts prioritize gas savings, so additional events may not be necessary.</td>
    </tr>
    <tr>
      <td>Testing and verification</td>
      <td>Average</td>
      <td>Brownie tests and foundry tests were written. The foundry tests were more comprehensive that the brownie tests, but getting the exact test coverage numbers with foundry is still <a href="https://github.com/foundry-rs/foundry/issues/99">a work in progress</a> at the time this review was performed. The coverage could be improved to test for the edge cases introduced by modifications to the forked Uniswap and BeefySwap contracts as demonstrated by the findings.</td>
    </tr>
  </tbody>
</table></div>
      <h2 id="findings-explanation">
        
        
          <a href="#findings-explanation" class="anchor-heading" aria-labelledby="findings-explanation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Findings Explanation
        
        
      </h2>
    

<p>Findings are broken down into sections by their respective impact:</p>
<ul>
  <li>Critical, High, Medium, Low impact
    <ul>
      <li>These are findings that range from attacks that may cause loss of funds, impact control/ownership of the contracts, or cause any unintended consequences/actions that are outside the scope of the requirements</li>
    </ul>
  </li>
  <li>Gas savings
    <ul>
      <li>Findings that can improve the gas efficiency of the contracts</li>
    </ul>
  </li>
  <li>Informational
    <ul>
      <li>Findings including recommendations and best practices</li>
    </ul>
  </li>
</ul><hr />
      <h2 id="high-findings">
        
        
          <a href="#high-findings" class="anchor-heading" aria-labelledby="high-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> High Findings
        
        
      </h2>
    
      <h3 id="1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson">
        
        
          <a href="#1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson" class="anchor-heading" aria-labelledby="1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. High - The swap and stake mechanisms in OpenMevZapper leave funds in the contract (Jackson)
        
        
      </h3>
    

<p>Half of the input amount in both <code class="language-plaintext highlighter-rouge">swapAndStakeLiquidity</code> and <code class="language-plaintext highlighter-rouge">swapETHAndStakeLiquidity</code> is used as the <code class="language-plaintext highlighter-rouge">swapAmountIn</code> when atomically swapping and staking.  However, this leaves funds in the contract due to the reserve asset ratio change post-swap.  See <a href="https://blog.alphaventuredao.io/onesideduniswap/">“Optimal One-sided Supply to Uniswap”</a> for more information.</p>
      <h4 id="proof-of-concept">
        
        
          <a href="#proof-of-concept" class="anchor-heading" aria-labelledby="proof-of-concept"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Both <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L126-L159"><code class="language-plaintext highlighter-rouge">swapAndStakeLiquidity</code></a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L165-L195"><code class="language-plaintext highlighter-rouge">swapETHAndStakeLiquidity</code></a> take the input tokens or ETH sent by a user, divide it by 2, swap it into the B token, and stake these tokens as a pair.  However, this approach leaves some of the B token in the contract due to the reserve asset ratio change before and after the swap.</p>
      <h4 id="impact">
        
        
          <a href="#impact" class="anchor-heading" aria-labelledby="impact"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High.  The funds are not returned to the user, and will likely be swept by Sushi governance during a call to <code class="language-plaintext highlighter-rouge">harvest</code>.</p>
      <h4 id="recommendation">
        
        
          <a href="#recommendation" class="anchor-heading" aria-labelledby="recommendation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use the formula found in <a href="https://blog.alphaventuredao.io/onesideduniswap/">“Optimal One-sided Supply to Uniswap”</a> for the <code class="language-plaintext highlighter-rouge">swapAmountIn</code>, rather than ` / 2`.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sqrt</span><span class="p">(</span>
    <span class="n">reserveIn</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">userIn</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">3988000</span><span class="p">)</span> <span class="o">+</span> <span class="n">reserveIn</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">3988009</span><span class="p">)))</span>
        <span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">reserveIn</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">1997</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1994</span><span class="p">;</span>
</code></pre></div></div>
      <h4 id="developer-response-sandy">
        
        
          <a href="#developer-response-sandy" class="anchor-heading" aria-labelledby="developer-response-sandy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Fixed <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/d95ec8543337787dcb3f7499f6f4ec6d69eb7b52">here</a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/958a70d6034db745555cf8b9effcb97bd2c59e20">here</a>.</p>
      <h3 id="2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r">
        
        
          <a href="#2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r" class="anchor-heading" aria-labelledby="2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. High - Using normal functions for fee-on-transfer tokens causes value loss (engn33r)
        
        
      </h3>
    

<p>Uniswap’s code relies on the assumption that functions without direct support for fee-on-transfer tokens, like <code class="language-plaintext highlighter-rouge">removeLiquidityETH</code>, will revert. This assumption is invalid in OpenMevRouter. The difference is that Uniswap routers are designed to <a href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02">not hold token balance</a>, which <a href="https://etherscan.io/address/0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D">the etherscan token balance confirms</a>. In comparison, the docs for OpenMevRouter.sol show it stores value that is later collected with the <code class="language-plaintext highlighter-rouge">harvest()</code> function. If enough fee-on-transfer tokens are held by the OpenMevRouter contract, functions such as <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code> can be called instead of <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code> and the function will not revert. This leads to the OpenMevRouter contract losing value due to the fees paid for the fee-on-transfer transfer.</p>
      <h4 id="proof-of-concept-1">
        
        
          <a href="#proof-of-concept-1" class="anchor-heading" aria-labelledby="proof-of-concept-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The NatSpec comment for <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code> includes</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Identical to removeLiquidityETH, but succeeds for tokens that take a fee on transfer
</code></pre></div></div>

<p>The only difference in these functions, and what is implied to cause the revert condition in <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code>, is the amount used in <code class="language-plaintext highlighter-rouge">safeTransfer()</code>. <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code> has an amount of <code class="language-plaintext highlighter-rouge">amountToken</code>, while <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code> uses <code class="language-plaintext highlighter-rouge">ERC20(token).balanceOf(address(this)) - balanceBefore</code>. This does cause a revert in Uniswap’s code because of the Uniswap assumption that the router holds no token balance, but OpenMevRouter can hold a token balance.</p>

<p>The process of value loss is:</p>
<ol>
  <li>Fee-on-transfer token is held by the router. This can happen either with an initial deposit by the Manifold team or from backrun arbitrage profits. The devs suggested the tokens that will be sent to the router will likely be tokens that Aave does not support flashloans for, which could include lesser known tokens with fee-on-transfer support.</li>
  <li>User wants to remove liquidity from WETH-ERC20 pair where the ERC20 has a non-zero fee-on-transfer. Instead of using  <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code>, the user calls <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code>.</li>
  <li>The code of <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code> and <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code> is identical except for the amount in <code class="language-plaintext highlighter-rouge">ERC20(token).safeTransfer()</code>. The <code class="language-plaintext highlighter-rouge">amountToken</code> value used in <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code> is greater than the amount of fee-on-transfer tokens received from the <code class="language-plaintext highlighter-rouge">removeLiquidity()</code> call, so the amount transferred to the user will include some of the token balance that was held by the router before the user’s remove liquidity interaction.</li>
  <li>Result: The router lost value in the form of the transfer-on-fee token</li>
</ol>
      <h4 id="impact-1">
        
        
          <a href="#impact-1" class="anchor-heading" aria-labelledby="impact-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High. Value can be lost from the router if the router stores fee-on-transfer tokens. While it may be unlikely for OpenMevRouter.sol to hold many fee-on-transfer tokens (note: USDT could become fee-on-transfer in the future), value loss would occur if the scenario does arise and no protections prevent against this.</p>
      <h4 id="recommendation-1">
        
        
          <a href="#recommendation-1" class="anchor-heading" aria-labelledby="recommendation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>The router should follow the Uniswap assumptions and not store value. Instead, the profits from any arbs should be stored in a separate contract where it can be flashloaned to the router for arbitrage opportunities. This would impact the <code class="language-plaintext highlighter-rouge">harvest()</code> and <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> functions at a minimum, and most likely require some redesigning of the overall contract.</p>

<p>If there is a preference to maintain the current design where the router holds value, add stricter checks to functions not designed for fee-on-transfer tokens. For example, a rewrite of <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code> logic:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ensure</span><span class="p">(</span><span class="n">deadline</span><span class="p">);</span>
<span class="kt">address</span> <span class="n">weth</span> <span class="o">=</span> <span class="n">WETH09</span><span class="p">;</span>
<span class="kt">uint256</span> <span class="n">balanceBefore</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
<span class="p">(</span><span class="n">amountToken</span><span class="p">,</span> <span class="n">amountETH</span><span class="p">)</span> <span class="o">=</span> <span class="n">removeLiquidity</span><span class="p">(</span>
    <span class="n">token</span><span class="p">,</span>
    <span class="n">weth</span><span class="p">,</span>
    <span class="n">liquidity</span><span class="p">,</span>
    <span class="n">amountTokenMin</span><span class="p">,</span>
    <span class="n">amountETHMin</span><span class="p">,</span>
    <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span>
    <span class="n">deadline</span>
<span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">amountToken</span> <span class="o">!=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">-</span> <span class="n">balanceBefore</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">TokenIsFeeOnTransfer</span><span class="p">();</span>
<span class="n">ERC20</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">safeTransfer</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">amountToken</span><span class="p">);</span>
<span class="n">IWETH</span><span class="p">(</span><span class="n">weth</span><span class="p">).</span><span class="n">withdraw</span><span class="p">(</span><span class="n">amountETH</span><span class="p">);</span>
<span class="n">SafeTransferLib</span><span class="p">.</span><span class="n">safeTransferETH</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">amountETH</span><span class="p">);</span>
</code></pre></div></div>
      <h4 id="developer-response-sandy-1">
        
        
          <a href="#developer-response-sandy-1" class="anchor-heading" aria-labelledby="developer-response-sandy-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Good find and good recommendation. <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/e73c70c98870ba94359c4e9a1eec82326aa046e1">Fixed</a>.</p>
      <h3 id="3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r">
        
        
          <a href="#3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r" class="anchor-heading" aria-labelledby="3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. High - Backrun arb not designed for fee-on-transfer tokens (engn33r)
        
        
      </h3>
    

<p>The backrun process is performed for any swap, but the backrun process is not designed for fee-on-transfer tokens. Because the router contract may hold fee-on-transfer tokens, the router contract may lose some of this stored value to fees when performing an arb involving a fee-on-transfer token.</p>
      <h4 id="proof-of-concept-2">
        
        
          <a href="#proof-of-concept-2" class="anchor-heading" aria-labelledby="proof-of-concept-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>While Aave and Kashi do not currently allow flashloans on any fee-on-transfer tokens, <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L897">this call of <code class="language-plaintext highlighter-rouge">_arb()</code> using internal router contract funds</a> is problematic.</p>

<p>The <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1116">first</a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1130">second</a> swaps are performed with <code class="language-plaintext highlighter-rouge">_asmSwap()</code>, which have a <code class="language-plaintext highlighter-rouge">safeTransfer()</code> performed first to send the token to the pair address.</p>

<p>It is assumed that the <code class="language-plaintext highlighter-rouge">amountOut</code> value calculated by <code class="language-plaintext highlighter-rouge">OpenMevLibrary.getAmountOut()</code> accurately stores the amount of tokens that the router contract receives from the swap process. Instead, to support fee-on-transfer tokens, a calculation of <code class="language-plaintext highlighter-rouge">ERC20(token).balanceOf(address(this)) - balanceBefore</code> as found in the router function <code class="language-plaintext highlighter-rouge">removeLiquidityETHSupportingFeeOnTransferTokens()</code> should be used.</p>

<p>The <code class="language-plaintext highlighter-rouge">_arb()</code> function can even cause problems when neither the first nor last token is a fee-on-transfer token, but one of the intermediate swaps uses a fee-on-transfer token. Because the <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> function <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L877">loops through the array of swaps</a>, any of the backrun swaps that involve a fee-on-transfer token could be problematic.</p>
      <h4 id="impact-2">
        
        
          <a href="#impact-2" class="anchor-heading" aria-labelledby="impact-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High. The router contract can lose funds when paying fees for fee-on-transfer token transfers.</p>
      <h4 id="recommendation-2">
        
        
          <a href="#recommendation-2" class="anchor-heading" aria-labelledby="recommendation-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>If the router is redesigned to not hold fee-on-transfer tokens, the backrun would likely revert because the math is not designed for fee-on-transfer tokens. The easiest solution is to remove the <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> calls when a fee-on-transfer swap is involved. Another option is to write a new <code class="language-plaintext highlighter-rouge">_arb()</code> function that supports fee-on-transfer arbitrage.</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L763">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L792">Second instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L823">Third instance</a></li>
</ul>
      <h4 id="developer-response-sandy-2">
        
        
          <a href="#developer-response-sandy-2" class="anchor-heading" aria-labelledby="developer-response-sandy-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Backrun attempts have been removed from fee-on-transfer swaps. <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/7e6bc4652da20d00cc5c6fbb68860c4cc054678c">Fixed</a>.</p>
      <h2 id="medium-findings">
        
        
          <a href="#medium-findings" class="anchor-heading" aria-labelledby="medium-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Medium Findings
        
        
      </h2>
    
      <h3 id="1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson">
        
        
          <a href="#1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson" class="anchor-heading" aria-labelledby="1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Medium - Failed flashloan arbitrage reverts the original swap (Jackson)
        
        
      </h3>
    

<p>If one of the backrun flashloan arbitrages fails to return a profit, the original swap is reverted.</p>
      <h4 id="proof-of-concept-3">
        
        
          <a href="#proof-of-concept-3" class="anchor-heading" aria-labelledby="proof-of-concept-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>These lines include the revert for each flashloan [<a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L966">1</a>, <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1042">2</a>].</p>
      <h4 id="impact-3">
        
        
          <a href="#impact-3" class="anchor-heading" aria-labelledby="impact-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Medium. While this will not involve a loss of user funds, it will result it a poor user experience when user swaps are unecessarily reverted.</p>
      <h4 id="recommendation-3">
        
        
          <a href="#recommendation-3" class="anchor-heading" aria-labelledby="recommendation-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use a try-catch when executing the flashloans such that if they revert, the entire swap is not also reverted.</p>
      <h4 id="developer-response-sandy-3">
        
        
          <a href="#developer-response-sandy-3" class="anchor-heading" aria-labelledby="developer-response-sandy-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/8d886f0cbaff78aa0977c88b7cc844138820d413">Fixed</a>.</p>
      <h2 id="low-findings">
        
        
          <a href="#low-findings" class="anchor-heading" aria-labelledby="low-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Low Findings
        
        
      </h2>
    
      <h3 id="1-low---edge-case-suboptimal-arb-profit-engn33r">
        
        
          <a href="#1-low---edge-case-suboptimal-arb-profit-engn33r" class="anchor-heading" aria-labelledby="1-low---edge-case-suboptimal-arb-profit-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Low - Edge case suboptimal arb profit (engn33r)
        
        
      </h3>
    

<p>There can be cases where <code class="language-plaintext highlighter-rouge">contractAssetBalance &gt;= optimalAmount</code> is not true, but using the available contractAssetBalance is still cheaper than using a flashloan with a fee. For example, if <code class="language-plaintext highlighter-rouge">contractAssetBalance = optimalAmount - 1</code>, using <code class="language-plaintext highlighter-rouge">contractAssetBalance</code> will normally produce a superior result to using a flashloan.</p>
      <h4 id="proof-of-concept-4">
        
        
          <a href="#proof-of-concept-4" class="anchor-heading" aria-labelledby="proof-of-concept-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The logic branch checks if <code class="language-plaintext highlighter-rouge">contractAssetBalance &gt;= optimalAmount</code>, otherwise <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L896">a flashloan is used</a>.</p>
      <h4 id="impact-4">
        
        
          <a href="#impact-4" class="anchor-heading" aria-labelledby="impact-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. This is an edge case that may be rare, but can reduce the profits of the router. Hypothetically this could be gamed by liquidity providers looking to increase yield through flashloan fees on certain assets in Aave or Kashi, because the fees are paid by OpenMevRouter arb profits.</p>
      <h4 id="recommendation-4">
        
        
          <a href="#recommendation-4" class="anchor-heading" aria-labelledby="recommendation-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>When calculating the optimalAmount for the backrun process, account for the profit loss due to Aave or Kashi fees.</p>
      <h4 id="developer-response-sandy-4">
        
        
          <a href="#developer-response-sandy-4" class="anchor-heading" aria-labelledby="developer-response-sandy-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Acknowledged. I am looking for an efficient way to implement this logic. At first glance, it seems like it would add complexity to every backrun for a rare edge case where the profit difference is marginal.</p>

<p>As a follow-up, I ran some tests with this check implemented in branch <code class="language-plaintext highlighter-rouge">test/profit-edge</code>. In short the extra gas cost for the check averaged <code class="language-plaintext highlighter-rouge">11,500</code> while there was <code class="language-plaintext highlighter-rouge">0</code> profit difference from the generic tests. Details below.</p>

<p>Code check for edge case inserted after <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/c6b420d1aed9c2f9b4e5954734b6f641424aa7f8/contracts/libraries/OpenMevLibrary.sol#L429">line 429 in OpenMevLibrary</a></p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">optimalAmount</span> <span class="o">&gt;</span> <span class="n">contractAssetBalance</span> <span class="o">&amp;&amp;</span> <span class="n">_isNonZero</span><span class="p">(</span><span class="n">contractAssetBalance</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">_balanceReturns</span> <span class="o">=</span> <span class="n">calcReturns</span><span class="p">(</span><span class="n">Cb</span><span class="p">,</span> <span class="n">Cf</span><span class="p">,</span> <span class="n">Cg</span><span class="p">,</span> <span class="n">contractAssetBalance</span><span class="p">);</span>
    <span class="kt">uint256</span> <span class="n">_fee</span> <span class="o">=</span> <span class="n">optimalAmount</span> <span class="o">&lt;=</span> <span class="n">bentoBalance</span> <span class="o">?</span> <span class="n">optimalAmount</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">:</span> <span class="n">optimalAmount</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_balanceReturns</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">optimalReturns</span> <span class="o">-</span> <span class="n">_fee</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">optimalAmount</span> <span class="o">=</span> <span class="n">contractAssetBalance</span><span class="p">;</span>
        <span class="n">optimalReturns</span> <span class="o">=</span> <span class="n">_balanceReturns</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Test comparison:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brownie run deployAndTestGas.py <span class="nt">--network</span> mainnet-fork2
</code></pre></div></div>

<p>Gas results:</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Gas without edge profit check</th>
      <th>Gas with edge profit check</th>
      <th>Gas difference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>113591</td>
      <td>113591</td>
      <td>0</td>
    </tr>
    <tr>
      <td>87791</td>
      <td>75631</td>
      <td>-12160</td>
    </tr>
    <tr>
      <td>94634</td>
      <td>94692</td>
      <td>58</td>
    </tr>
    <tr>
      <td>233389</td>
      <td>233447</td>
      <td>58</td>
    </tr>
    <tr>
      <td>455588</td>
      <td>456057</td>
      <td>469</td>
    </tr>
    <tr>
      <td>444788</td>
      <td>445257</td>
      <td>469</td>
    </tr>
    <tr>
      <td>365001</td>
      <td>445005</td>
      <td>80004</td>
    </tr>
    <tr>
      <td>150411</td>
      <td>150411</td>
      <td>0</td>
    </tr>
    <tr>
      <td>143863</td>
      <td>168183</td>
      <td>24320</td>
    </tr>
    <tr>
      <td>442431</td>
      <td>442547</td>
      <td>116</td>
    </tr>
    <tr>
      <td>674209</td>
      <td>675136</td>
      <td>927</td>
    </tr>
    <tr>
      <td>86431</td>
      <td>98591</td>
      <td>12160</td>
    </tr>
    <tr>
      <td>86431</td>
      <td>86431</td>
      <td>0</td>
    </tr>
    <tr>
      <td>184572</td>
      <td>196635</td>
      <td>12063</td>
    </tr>
    <tr>
      <td>208748</td>
      <td>208795</td>
      <td>47</td>
    </tr>
    <tr>
      <td>184572</td>
      <td>184619</td>
      <td>47</td>
    </tr>
    <tr>
      <td>184596</td>
      <td>208819</td>
      <td>24223</td>
    </tr>
    <tr>
      <td>184582</td>
      <td>208805</td>
      <td>24223</td>
    </tr>
    <tr>
      <td>135411</td>
      <td>135411</td>
      <td>0</td>
    </tr>
    <tr>
      <td>268015</td>
      <td>268062</td>
      <td>47</td>
    </tr>
    <tr>
      <td>366412</td>
      <td>403253</td>
      <td>36841</td>
    </tr>
    <tr>
      <td>560339</td>
      <td>609207</td>
      <td>48868</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td> </td>
      <td>Average extra gas</td>
      <td>11490</td>
    </tr>
  </tbody>
</table></div>
      <h3 id="2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r">
        
        
          <a href="#2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r" class="anchor-heading" aria-labelledby="2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Low - One failed arb can revert otherwise profitable arb (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> function may loop through multiple swaps to arbitrage each one. If one of these swaps does not have a sufficiently profitable opportunity or has a failed flashloan, the profitable opportunity from the other swaps may be missed.</p>
      <h4 id="proof-of-concept-5">
        
        
          <a href="#proof-of-concept-5" class="anchor-heading" aria-labelledby="proof-of-concept-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> function <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L877">loops through the array of swaps</a>. Imagine a scenario where <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> is called with a swaps array of length 4. Assume the 1st, 2nd, and 4th backrun swaps are profitable, but the 3rd backrun swap is not. Performing this series of four backrun swaps can still be net profitable even if one of the individual backrun swaps is not. The reason the 3rd backrun swap is not profitable may be because the flashloan fee costs more than the profit of this arb, which reverts <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L966">here</a> or <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1042">here</a>, or <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L905">a similar revert can happen</a> if the router contract funds are used for the arb and the amount received is less than expected.</p>

<p>The result is the transaction reverts and OpenMevRouter will miss out on the arb profits if the swaps had been completed even if one individual backrun swap wasn’t profitable.</p>
      <h4 id="impact-5">
        
        
          <a href="#impact-5" class="anchor-heading" aria-labelledby="impact-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. This is an edge case that may be rare, but can reduce the profits of the router.</p>
      <h4 id="recommendation-5">
        
        
          <a href="#recommendation-5" class="anchor-heading" aria-labelledby="recommendation-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>A single flashloan or arb opportunity resulting in no profit should not revert the entire transaction. Instead, that specific backrun swap arb should be skipped. It is not even necessary to skip an unprofitable backrun swap if there is a positive net profit that is calculated at the start of the <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> function.</p>
      <h4 id="developer-response-sandy-5">
        
        
          <a href="#developer-response-sandy-5" class="anchor-heading" aria-labelledby="developer-response-sandy-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/8d886f0cbaff78aa0977c88b7cc844138820d413">Fixed for flashloan backruns</a> with <code class="language-plaintext highlighter-rouge">try/catch</code>.</p>

<p>Acknowledged as an edge case for non-flashloan backruns. Looking for a good solution to this case.</p>
      <h3 id="3-low---max-approval-granted-to-spender-jackson">
        
        
          <a href="#3-low---max-approval-granted-to-spender-jackson" class="anchor-heading" aria-labelledby="3-low---max-approval-granted-to-spender-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Low - Max approval granted to spender (Jackson)
        
        
      </h3>
    

<p>Maximum approvals should be avoided, particularly when the necessary amount is known.</p>
      <h4 id="proof-of-concept-6">
        
        
          <a href="#proof-of-concept-6" class="anchor-heading" aria-labelledby="proof-of-concept-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><code class="language-plaintext highlighter-rouge">ERC20(token).safeApprove(spender, type(uint256).max);</code> in <code class="language-plaintext highlighter-rouge">_approveTokenIfNeeded</code> approves the spend to spent the entire balance.</p>
      <h4 id="impact-6">
        
        
          <a href="#impact-6" class="anchor-heading" aria-labelledby="impact-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. Assuming nothing problematic occurs this is not a problem.  However, it is a level of protection in case of attack.</p>
      <h4 id="recommendation-6">
        
        
          <a href="#recommendation-6" class="anchor-heading" aria-labelledby="recommendation-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Only approve what is necessary for the transaction when it is known prior to granting approval.</p>
      <h4 id="developer-response-sandy-6">
        
        
          <a href="#developer-response-sandy-6" class="anchor-heading" aria-labelledby="developer-response-sandy-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/53790ec806c2b4fd72c67efd826b017f0d1cc203">Fixed</a>.</p>
      <h3 id="4-low---no-check-for-aave-flashloan-balance-jackson">
        
        
          <a href="#4-low---no-check-for-aave-flashloan-balance-jackson" class="anchor-heading" aria-labelledby="4-low---no-check-for-aave-flashloan-balance-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Low - No check For Aave flashloan balance (Jackson)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">_backrunSwaps</code> in <code class="language-plaintext highlighter-rouge">OpenMevRouter</code> checks that Kashi has the necessary liqudity to take a flashloan against, but does not check that Aave does as well.</p>
      <h4 id="proof-of-concept-7">
        
        
          <a href="#proof-of-concept-7" class="anchor-heading" aria-labelledby="proof-of-concept-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L915">L915 of OpenMevRouter</a></p>
      <h4 id="impact-7">
        
        
          <a href="#impact-7" class="anchor-heading" aria-labelledby="impact-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low. It is unlikely that Aave will not have the necessary liquidity for the flashloan.</p>
      <h4 id="recommendation-7">
        
        
          <a href="#recommendation-7" class="anchor-heading" aria-labelledby="recommendation-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Check that Aave contains the necessary liquidity at the time of the flashloan as is done for Kashi. A fix is underway in <a href="https://github.com/manifoldfinance/OpenMevRouter/pull/40">PR #40</a>.</p>
      <h4 id="developer-response-sandy-7">
        
        
          <a href="#developer-response-sandy-7" class="anchor-heading" aria-labelledby="developer-response-sandy-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/0a115df66b83a3dc14fc347f5137b95f468c79ae">Fixed</a>.</p>
      <h2 id="gas-savings-findings">
        
        
          <a href="#gas-savings-findings" class="anchor-heading" aria-labelledby="gas-savings-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gas Savings Findings
        
        
      </h2>
    
      <h3 id="1-gas---use-_isnonzero-for-gas-savings-engn33r">
        
        
          <a href="#1-gas---use-_isnonzero-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="1-gas---use-_isnonzero-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Gas - Use <code class="language-plaintext highlighter-rouge">_isNonZero()</code> for gas savings (engn33r)
        
        
      </h3>
    

<p>There is a gas efficient <code class="language-plaintext highlighter-rouge">_isNonZero()</code> function that is not used in two places. Otherwise, <code class="language-plaintext highlighter-rouge">!= 0</code> is preferred to <code class="language-plaintext highlighter-rouge">&gt; 0</code> when comparing a uint to zero.</p>
      <h4 id="proof-of-concept-8">
        
        
          <a href="#proof-of-concept-8" class="anchor-heading" aria-labelledby="proof-of-concept-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of Concept
        
        
      </h4>
    

<p>Two instances of this were found:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L68">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1151">Second instance</a></li>
</ul>
      <h4 id="impact-8">
        
        
          <a href="#impact-8" class="anchor-heading" aria-labelledby="impact-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-8">
        
        
          <a href="#recommendation-8" class="anchor-heading" aria-labelledby="recommendation-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace <code class="language-plaintext highlighter-rouge">&gt; 0</code> with <code class="language-plaintext highlighter-rouge">!= 0</code> to save gas. Even better, use the existing <code class="language-plaintext highlighter-rouge">_isNonZero()</code> function in OpenMevLibrary.sol.</p>
      <h4 id="developer-response-sandy-8">
        
        
          <a href="#developer-response-sandy-8" class="anchor-heading" aria-labelledby="developer-response-sandy-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/802810c2e58722ebf9edcfbe305b80447b544228">Fixed</a>.</p>
      <h3 id="2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r">
        
        
          <a href="#2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r" class="anchor-heading" aria-labelledby="2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Gas - Use <code class="language-plaintext highlighter-rouge">_inc()</code> instead of <code class="language-plaintext highlighter-rouge">++</code> and <code class="language-plaintext highlighter-rouge">_dec()</code> instead of <code class="language-plaintext highlighter-rouge">--</code> (engn33r)
        
        
      </h3>
    

<p>Gas efficient functions <code class="language-plaintext highlighter-rouge">_inc()</code> and <code class="language-plaintext highlighter-rouge">_dec()</code> should be used to replace normal increments and decrements. Otherwise, if these functions were not available, use prefix is preferred to postfix for gas efficiency. In other words, use <code class="language-plaintext highlighter-rouge">++i</code> instead of <code class="language-plaintext highlighter-rouge">i++</code>.</p>
      <h4 id="proof-of-concept-9">
        
        
          <a href="#proof-of-concept-9" class="anchor-heading" aria-labelledby="proof-of-concept-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There is <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L66">one instance</a> of an increment improvement.</p>

<p>There are two instances of a double decrement that could be replaced with <code class="language-plaintext highlighter-rouge">_dec(_decr())</code> or with <code class="language-plaintext highlighter-rouge">unchecked { length - 2; }</code>:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L274">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L313">Second instance</a></li>
</ul>
      <h4 id="impact-9">
        
        
          <a href="#impact-9" class="anchor-heading" aria-labelledby="impact-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-9">
        
        
          <a href="#recommendation-9" class="anchor-heading" aria-labelledby="recommendation-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Increment with prefix addition and not postfix in for loops. Even better, use <code class="language-plaintext highlighter-rouge">_inc()</code> and <code class="language-plaintext highlighter-rouge">_dec()</code>.</p>
      <h4 id="developer-response-sandy-9">
        
        
          <a href="#developer-response-sandy-9" class="anchor-heading" aria-labelledby="developer-response-sandy-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/c21a52a2ca06b2fab9bbf54d18f38d0517a8c373">Fixed</a>.</p>
      <h3 id="3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r">
        
        
          <a href="#3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r" class="anchor-heading" aria-labelledby="3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Gas - Bitshifting is cheaper than multiplication or division (engn33r)
        
        
      </h3>
    

<p>Bitshifting is cheaper than multiplication or division. Multiplication and division can be replaced by a bitshift easily when a multiple of two is involved.</p>
      <h4 id="proof-of-concept-10">
        
        
          <a href="#proof-of-concept-10" class="anchor-heading" aria-labelledby="proof-of-concept-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There are four instance of divide by 2 operations that can use bitshifting for gas efficiency:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L137">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L172">Second instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L204">Third instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/Uint512.sol#L344">Fourth instance</a></li>
</ul>
      <h4 id="impact-10">
        
        
          <a href="#impact-10" class="anchor-heading" aria-labelledby="impact-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-10">
        
        
          <a href="#recommendation-10" class="anchor-heading" aria-labelledby="recommendation-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace multiplication and division by a bitshift when a power of two is involved.</p>
      <h4 id="developer-response-sandy-10">
        
        
          <a href="#developer-response-sandy-10" class="anchor-heading" aria-labelledby="developer-response-sandy-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/05cc6a58f9d6a12548561e8015c8ec2204cc4410">Fixed</a>.</p>
      <h3 id="4-gas---unnecessary-zero-initialization-engn33r">
        
        
          <a href="#4-gas---unnecessary-zero-initialization-engn33r" class="anchor-heading" aria-labelledby="4-gas---unnecessary-zero-initialization-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Gas - Unnecessary zero initialization (engn33r)
        
        
      </h3>
    

<p>Initializing an int or uint to zero is unnecessary, because solidity defaults int/uint variables to a zero value. Removing the initialization to zero can save gas.</p>
      <h4 id="proof-of-concept-11">
        
        
          <a href="#proof-of-concept-11" class="anchor-heading" aria-labelledby="proof-of-concept-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of Concept
        
        
      </h4>
    

<p>Two instances of this were found:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L71">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1152">Second instance</a></li>
</ul>
      <h4 id="impact-11">
        
        
          <a href="#impact-11" class="anchor-heading" aria-labelledby="impact-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-11">
        
        
          <a href="#recommendation-11" class="anchor-heading" aria-labelledby="recommendation-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove the explicit uint variable initializations to zero.</p>
      <h4 id="developer-response-sandy-11">
        
        
          <a href="#developer-response-sandy-11" class="anchor-heading" aria-labelledby="developer-response-sandy-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/451ee99ac2ecfd390a5b6d37477591c36df95eaf">Fixed</a>.</p>
      <h3 id="5-gas---payable-functions-can-save-gas-engn33r">
        
        
          <a href="#5-gas---payable-functions-can-save-gas-engn33r" class="anchor-heading" aria-labelledby="5-gas---payable-functions-can-save-gas-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Gas - Payable functions can save gas (engn33r)
        
        
      </h3>
    

<p>If there is no risk of a function accidentally receiving ether, such as a function with the onlyOwner modifier, this function can use the payable modifier to save gas.</p>
      <h4 id="proof-of-concept-12">
        
        
          <a href="#proof-of-concept-12" class="anchor-heading" aria-labelledby="proof-of-concept-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The following functions have the onlyOwner modifier and can be marked as payable</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1141">First function</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/TwoStepOwnable.sol#L66">Second function</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/TwoStepOwnable.sol#L80">Third function</a></li>
</ul>
      <h4 id="impact-12">
        
        
          <a href="#impact-12" class="anchor-heading" aria-labelledby="impact-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-12">
        
        
          <a href="#recommendation-12" class="anchor-heading" aria-labelledby="recommendation-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Mark functions that have onlyOwner as payable for gas savings. This might not be aesthetically pleasing, but it works.</p>
      <h4 id="developer-response-sandy-12">
        
        
          <a href="#developer-response-sandy-12" class="anchor-heading" aria-labelledby="developer-response-sandy-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/32fdf1e2ef1ec4f9bc9852f825aa882fbb932b15">Fixed</a>.</p>
      <h3 id="6-gas---avoid--logic-in-require-statements-engn33r">
        
        
          <a href="#6-gas---avoid--logic-in-require-statements-engn33r" class="anchor-heading" aria-labelledby="6-gas---avoid--logic-in-require-statements-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Gas - Avoid &amp;&amp; logic in require statements (engn33r)
        
        
      </h3>
    

<p>Using &amp;&amp; logic in require statements uses more gas than using separate require statements. Dividing the logic into multiple require statements is more gas efficient.</p>
      <h4 id="proof-of-concept-13">
        
        
          <a href="#proof-of-concept-13" class="anchor-heading" aria-labelledby="proof-of-concept-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/ERC20.sol#L151">One instance</a> of require with &amp;&amp; logic was found.</p>
      <h4 id="impact-13">
        
        
          <a href="#impact-13" class="anchor-heading" aria-labelledby="impact-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-13">
        
        
          <a href="#recommendation-13" class="anchor-heading" aria-labelledby="recommendation-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace require statements that use &amp;&amp; by dividing up the logic into multiple require statements.</p>
      <h4 id="developer-response-sandy-13">
        
        
          <a href="#developer-response-sandy-13" class="anchor-heading" aria-labelledby="developer-response-sandy-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/e5e1b865e37dbfeec3c8a5940f7da84de552deaa">Fixed</a>.</p>
      <h3 id="7-gas---declare-constant-internal-when-possible-engn33r">
        
        
          <a href="#7-gas---declare-constant-internal-when-possible-engn33r" class="anchor-heading" aria-labelledby="7-gas---declare-constant-internal-when-possible-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Gas - Declare constant internal when possible (engn33r)
        
        
      </h3>
    

<p>Declaring constant with internal visibility is cheaper than public constants. This is already applied to all constants in the code except one.</p>
      <h4 id="proof-of-concept-14">
        
        
          <a href="#proof-of-concept-14" class="anchor-heading" aria-labelledby="proof-of-concept-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">bento</code> constant <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L89">should be internal if possible</a>.</p>
      <h4 id="impact-14">
        
        
          <a href="#impact-14" class="anchor-heading" aria-labelledby="impact-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-14">
        
        
          <a href="#recommendation-14" class="anchor-heading" aria-labelledby="recommendation-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Make constant variables internal for gas savings.</p>
      <h4 id="developer-response-sandy-14">
        
        
          <a href="#developer-response-sandy-14" class="anchor-heading" aria-labelledby="developer-response-sandy-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/15650fdd1e63df7c13bd316a579251d8cdc03dd0">Fixed</a>.</p>
      <h3 id="8-gas---replace-require-with-errors-in-openmevrouter-jackson">
        
        
          <a href="#8-gas---replace-require-with-errors-in-openmevrouter-jackson" class="anchor-heading" aria-labelledby="8-gas---replace-require-with-errors-in-openmevrouter-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Gas - Replace require with errors in OpenMevRouter (Jackson)
        
        
      </h3>
    

<p>Two require statements can be replaced with custom errors in OpenMevRouter.</p>

<p>Custom errors are already used elsewhere in OpenMevRouter and <a href="https://blog.soliditylang.org/2021/04/21/custom-errors/">are more gas-efficient than require statements</a>.</p>
      <h4 id="proof-of-concept-15">
        
        
          <a href="#proof-of-concept-15" class="anchor-heading" aria-labelledby="proof-of-concept-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L138">One instance</a> in <code class="language-plaintext highlighter-rouge">_addLiquidity</code> (<code class="language-plaintext highlighter-rouge">require(amountAOptimal &lt;= amountADesired);</code>) and <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L226">another instance</a> in <code class="language-plaintext highlighter-rouge">addLiquidityETH</code> (<code class="language-plaintext highlighter-rouge">require(IWETH(weth).transfer(pair, amountETH));</code>, which can be replaced with <code class="language-plaintext highlighter-rouge">safeTransfer</code> as is done in <code class="language-plaintext highlighter-rouge">swapExactETHForTokens</code>).</p>
      <h4 id="impact-15">
        
        
          <a href="#impact-15" class="anchor-heading" aria-labelledby="impact-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-15">
        
        
          <a href="#recommendation-15" class="anchor-heading" aria-labelledby="recommendation-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use solidity custom errors instead of require statements.</p>
      <h4 id="developer-response-sandy-15">
        
        
          <a href="#developer-response-sandy-15" class="anchor-heading" aria-labelledby="developer-response-sandy-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/ee18037b1b1f6ecc4c3ba2f3e324cab3028d87ff">Fixed</a>.</p>
      <h3 id="9-gas---remove-unused-code-jackson">
        
        
          <a href="#9-gas---remove-unused-code-jackson" class="anchor-heading" aria-labelledby="9-gas---remove-unused-code-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Gas - Remove unused code (Jackson)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">RESERVE_SELECTOR</code> is not used in <code class="language-plaintext highlighter-rouge">OpenMevLibrary</code> and can be removed, neither are <code class="language-plaintext highlighter-rouge">_require()</code> or <code class="language-plaintext highlighter-rouge">_revert()</code> in <code class="language-plaintext highlighter-rouge">OpenMevErrors</code>.</p>
      <h4 id="proof-of-concept-16">
        
        
          <a href="#proof-of-concept-16" class="anchor-heading" aria-labelledby="proof-of-concept-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<ol>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L36">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L9">Second instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L16">Third instance</a></li>
</ol>
      <h4 id="impact-16">
        
        
          <a href="#impact-16" class="anchor-heading" aria-labelledby="impact-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-16">
        
        
          <a href="#recommendation-16" class="anchor-heading" aria-labelledby="recommendation-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove unused code to save gas on deployment.</p>
      <h4 id="developer-response-sandy-16">
        
        
          <a href="#developer-response-sandy-16" class="anchor-heading" aria-labelledby="developer-response-sandy-16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Fixed <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/6de27119f494d65c118d962b669c0e8bcdbed8f4">here</a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/7e6bc4652da20d00cc5c6fbb68860c4cc054678c#diff-b4834e810cd44d32d41b3219df7de3686fcea39955037126dac7bba1793b6327">here</a>.</p>
      <h3 id="10-gas---use-simple-comparison-engn33r">
        
        
          <a href="#10-gas---use-simple-comparison-engn33r" class="anchor-heading" aria-labelledby="10-gas---use-simple-comparison-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Gas - Use simple comparison (engn33r)
        
        
      </h3>
    

<p>Using a compound comparison such as ≥ or ≤ uses more gas than a simple comparison check like &gt;, &lt;, or ==. Compound comparison operators can be replaced with simple ones for gas savings.</p>
      <h4 id="proof-of-concept-17">
        
        
          <a href="#proof-of-concept-17" class="anchor-heading" aria-labelledby="proof-of-concept-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">_addLiquidity()</code> function in OpenMenRouter.sol contains <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L131-L143">this code</a>:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">amountBOptimal</span> <span class="o">&lt;=</span> <span class="n">amountBDesired</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// require(amountBOptimal &gt;= amountBMin, 'UniswapV2Router: INSUFFICIENT_B_AMOUNT');
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">amountBOptimal</span> <span class="o">&lt;</span> <span class="n">amountBMin</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientBAmount</span><span class="p">();</span>
    <span class="c1">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });
</span>    <span class="p">(</span><span class="n">amountA</span><span class="p">,</span> <span class="n">amountB</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">amountADesired</span><span class="p">,</span> <span class="n">amountBOptimal</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">amountAOptimal</span> <span class="o">=</span> <span class="n">OpenMevLibrary</span><span class="p">.</span><span class="n">quote</span><span class="p">(</span><span class="n">amountBDesired</span><span class="p">,</span> <span class="n">reserveB</span><span class="p">,</span> <span class="n">reserveA</span><span class="p">);</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">amountAOptimal</span> <span class="o">&lt;=</span> <span class="n">amountADesired</span><span class="p">);</span>
    <span class="c1">// require(amountAOptimal &gt;= amountAMin, 'UniswapV2Router: INSUFFICIENT_A_AMOUNT');
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">amountAOptimal</span> <span class="o">&lt;</span> <span class="n">amountAMin</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAAmount</span><span class="p">();</span>
    <span class="c1">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });
</span>    <span class="p">(</span><span class="n">amountA</span><span class="p">,</span> <span class="n">amountB</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">amountAOptimal</span><span class="p">,</span> <span class="n">amountBDesired</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By switching around the if/else clauses, we can replace the compound operator with a simple one</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">amountBOptimal</span> <span class="o">&gt;</span> <span class="n">amountBDesired</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">amountAOptimal</span> <span class="o">=</span> <span class="n">OpenMevLibrary</span><span class="p">.</span><span class="n">quote</span><span class="p">(</span><span class="n">amountBDesired</span><span class="p">,</span> <span class="n">reserveB</span><span class="p">,</span> <span class="n">reserveA</span><span class="p">);</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">amountAOptimal</span> <span class="o">&lt;=</span> <span class="n">amountADesired</span><span class="p">);</span>
    <span class="c1">// require(amountAOptimal &gt;= amountAMin, 'UniswapV2Router: INSUFFICIENT_A_AMOUNT');
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">amountAOptimal</span> <span class="o">&lt;</span> <span class="n">amountAMin</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAAmount</span><span class="p">();</span>
    <span class="c1">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });
</span>    <span class="p">(</span><span class="n">amountA</span><span class="p">,</span> <span class="n">amountB</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">amountAOptimal</span><span class="p">,</span> <span class="n">amountBDesired</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// require(amountBOptimal &gt;= amountBMin, 'UniswapV2Router: INSUFFICIENT_B_AMOUNT');
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">amountBOptimal</span> <span class="o">&lt;</span> <span class="n">amountBMin</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientBAmount</span><span class="p">();</span>
    <span class="c1">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });
</span>    <span class="p">(</span><span class="n">amountA</span><span class="p">,</span> <span class="n">amountB</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">amountADesired</span><span class="p">,</span> <span class="n">amountBOptimal</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another instance of this improvement is found with the comparison <code class="language-plaintext highlighter-rouge">&gt;= 1</code>. Two other instances of this are in OpenMevLibrary.sol (lines 270 and 331), but to show <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L729">the example from <code class="language-plaintext highlighter-rouge">_swapSupportingFeeOnTransferTokens()</code></a>:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">swaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isBackrunable</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">amountInput</span><span class="p">)</span> <span class="o">/</span> <span class="n">reserveInput</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>Because <code class="language-plaintext highlighter-rouge">&gt;= 1</code> equates to <code class="language-plaintext highlighter-rouge">&gt; 0</code>, and G1 shows how <code class="language-plaintext highlighter-rouge">!= 0</code> or <code class="language-plaintext highlighter-rouge">_isNonZero()</code> is better than <code class="language-plaintext highlighter-rouge">&gt; 0</code>, the comparison can be simplified to</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">swaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isBackrunable</span> <span class="o">=</span> <span class="n">_isNonZero</span><span class="p">(((</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">amountInput</span><span class="p">)</span> <span class="o">/</span> <span class="n">reserveInput</span><span class="p">));</span>
</code></pre></div></div>
      <h4 id="impact-17">
        
        
          <a href="#impact-17" class="anchor-heading" aria-labelledby="impact-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-17">
        
        
          <a href="#recommendation-17" class="anchor-heading" aria-labelledby="recommendation-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace compound comparison operators with simple ones for gas savings.</p>
      <h4 id="developer-response-sandy-17">
        
        
          <a href="#developer-response-sandy-17" class="anchor-heading" aria-labelledby="developer-response-sandy-17"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/474b00d0b3b4bc02651fd9548c2a567c14039cd6">Fixed</a>.</p>
      <h3 id="11-gas---combine-reserve-value-checks-engn33r">
        
        
          <a href="#11-gas---combine-reserve-value-checks-engn33r" class="anchor-heading" aria-labelledby="11-gas---combine-reserve-value-checks-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Gas - Combine reserve value checks (engn33r)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">getAmountOut()</code> in OpenMevLibrary.sol checks if the reserve values with <code class="language-plaintext highlighter-rouge">_isZero()</code>. Most locations where <code class="language-plaintext highlighter-rouge">OpenMevLibrary.getAmountOut()</code> is called also use the check <code class="language-plaintext highlighter-rouge">if (reserve0 &lt; 1000 || reserve1 &lt; 1000)</code> before <code class="language-plaintext highlighter-rouge">getAmountOut()</code> is called. Rather than duplicating similar checks, gas could be saved by consistently checking reserve values before calling <code class="language-plaintext highlighter-rouge">getAmountOut()</code>, or requiring <code class="language-plaintext highlighter-rouge">reserve0 &lt; 1000 &amp;&amp; reserve1 &lt; 1000</code> inside <code class="language-plaintext highlighter-rouge">getAmountOut()</code>.</p>
      <h4 id="proof-of-concept-18">
        
        
          <a href="#proof-of-concept-18" class="anchor-heading" aria-labelledby="proof-of-concept-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">Most places</a> where <code class="language-plaintext highlighter-rouge">OpenMevLibrary.getAmountOut()</code> in OpenMevZapper results in duplicated reserve checks.</p>
      <h4 id="impact-18">
        
        
          <a href="#impact-18" class="anchor-heading" aria-labelledby="impact-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-18">
        
        
          <a href="#recommendation-18" class="anchor-heading" aria-labelledby="recommendation-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove duplicated reserves checks to save gas</p>
      <h4 id="developer-response-sandy-18">
        
        
          <a href="#developer-response-sandy-18" class="anchor-heading" aria-labelledby="developer-response-sandy-18"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/9fdfb43c6f2d99056d9a95f8531391e907b85e3d">Fixed</a>.</p>
      <h3 id="12-gas---use-msg-global-vars-directly-engn33r">
        
        
          <a href="#12-gas---use-msg-global-vars-directly-engn33r" class="anchor-heading" aria-labelledby="12-gas---use-msg-global-vars-directly-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 12. Gas - Use msg global vars directly (engn33r)
        
        
      </h3>
    

<p>Using msg.sender and msg.value without caching is slightly more gas efficient than caching the value.</p>
      <h4 id="proof-of-concept-19">
        
        
          <a href="#proof-of-concept-19" class="anchor-heading" aria-labelledby="proof-of-concept-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>msg.value is unnecessarily cached in:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L214"><code class="language-plaintext highlighter-rouge">addLiquidityETH()</code></a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L666"><code class="language-plaintext highlighter-rouge">swapETHForExactTokens()</code></a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L166"><code class="language-plaintext highlighter-rouge">swapETHAndStakeLiquidity()</code></a></li>
</ul>

<p>msg.value can replace swaps[0].amountIn</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">swapExactETHForTokens()</code> <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L564">here</a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L566">here</a></li>
</ul>
      <h4 id="impact-19">
        
        
          <a href="#impact-19" class="anchor-heading" aria-labelledby="impact-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-19">
        
        
          <a href="#recommendation-19" class="anchor-heading" aria-labelledby="recommendation-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Improve gas efficiency by removing the caching of msg global vars to use the global vars directly</p>
      <h4 id="developer-response-sandy-19">
        
        
          <a href="#developer-response-sandy-19" class="anchor-heading" aria-labelledby="developer-response-sandy-19"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/e7f347875c8d8b4869e527a2d1ba35d25b87c58d">Fixed</a>.</p>
      <h3 id="13-gas---remove-duplicate-internal-function-call-engn33r">
        
        
          <a href="#13-gas---remove-duplicate-internal-function-call-engn33r" class="anchor-heading" aria-labelledby="13-gas---remove-duplicate-internal-function-call-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 13. Gas - Remove duplicate internal function call (engn33r)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">ensure()</code> gets called twice in ETH-related functions. The first call happens at the start of <code class="language-plaintext highlighter-rouge">addLiquidityETH()</code> or <code class="language-plaintext highlighter-rouge">removeLiquidityETH()</code>, and the second call happens when this function calls <code class="language-plaintext highlighter-rouge">addLiquidity()</code> or <code class="language-plaintext highlighter-rouge">removeLiquidity()</code>. However, this only helps in the case where no revert occurs, otherwise reverting earlier is better.</p>
      <h4 id="proof-of-concept-20">
        
        
          <a href="#proof-of-concept-20" class="anchor-heading" aria-labelledby="proof-of-concept-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>One example:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L212">First call</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L177">Second call</a></li>
</ul>
      <h4 id="impact-20">
        
        
          <a href="#impact-20" class="anchor-heading" aria-labelledby="impact-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-20">
        
        
          <a href="#recommendation-20" class="anchor-heading" aria-labelledby="recommendation-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove the <code class="language-plaintext highlighter-rouge">ensure()</code> call at the start of the ETH-related functions in OpenMevRouter.sol.</p>
      <h4 id="developer-response-sandy-20">
        
        
          <a href="#developer-response-sandy-20" class="anchor-heading" aria-labelledby="developer-response-sandy-20"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/6388d03c32af1eba0aea4300c82b1e58ac1319f8">Fixed</a>.</p>
      <h3 id="14-gas---deadline-special-case-not-aligned-with-permit-engn33r">
        
        
          <a href="#14-gas---deadline-special-case-not-aligned-with-permit-engn33r" class="anchor-heading" aria-labelledby="14-gas---deadline-special-case-not-aligned-with-permit-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 14. Gas - deadline special case not aligned with permit (engn33r)
        
        
      </h3>
    

<p>From EIP-2612:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The deadline argument can be set to uint(-1) to create Permits that effectively never expire.
</code></pre></div></div>

<p>In contrast, <code class="language-plaintext highlighter-rouge">ensure()</code> implies a value of zero for a deadline that never expires</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">deadline</span> <span class="o">&lt;</span> <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&amp;&amp;</span> <span class="n">_isNonZero</span><span class="p">(</span><span class="n">deadline</span><span class="p">))</span> <span class="nb">revert</span> <span class="n">Expired</span><span class="p">();</span>
</code></pre></div></div>
      <h4 id="proof-of-concept-21">
        
        
          <a href="#proof-of-concept-21" class="anchor-heading" aria-labelledby="proof-of-concept-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://eips.ethereum.org/EIPS/eip-2612#rationale">EIP-2612 text</a></p>

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L98"><code class="language-plaintext highlighter-rouge">ensure()</code> function</a></p>
      <h4 id="impact-21">
        
        
          <a href="#impact-21" class="anchor-heading" aria-labelledby="impact-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-21">
        
        
          <a href="#recommendation-21" class="anchor-heading" aria-labelledby="recommendation-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use the same permit approach as EIP-2612. This simplifies and aligns the check in <code class="language-plaintext highlighter-rouge">ensure()</code> to match Uniswap’s check.</p>

<p><a href="https://github.com/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2ERC20.sol#L82">Uniswap code</a>:
<code class="language-plaintext highlighter-rouge">require(deadline &gt;= block.timestamp, 'UniswapV2: EXPIRED');</code></p>

<p>Revised OpenMevRouter.sol <code class="language-plaintext highlighter-rouge">ensure()</code> logic:
<code class="language-plaintext highlighter-rouge">if (deadline &lt; block.timestamp) revert Expired();</code></p>
      <h4 id="developer-response-sandy-21">
        
        
          <a href="#developer-response-sandy-21" class="anchor-heading" aria-labelledby="developer-response-sandy-21"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>This was a feature request from Sam. Not sure why. Removed for compliance. <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/bf4b1d25830bf01b1506ca3bd339e826d4dd3670">Fixed</a>.</p>
      <h3 id="15-gas---replace-pairswap-with-_asmswap-engn33r">
        
        
          <a href="#15-gas---replace-pairswap-with-_asmswap-engn33r" class="anchor-heading" aria-labelledby="15-gas---replace-pairswap-with-_asmswap-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 15. Gas - Replace <code class="language-plaintext highlighter-rouge">pair.swap()</code> with <code class="language-plaintext highlighter-rouge">_asmSwap()</code> (engn33r)
        
        
      </h3>
    

<p>One instance of <code class="language-plaintext highlighter-rouge">pair.swap()</code> has not been replaced with <code class="language-plaintext highlighter-rouge">_asmSwap()</code> for gas efficiency.</p>
      <h4 id="proof-of-concept-22">
        
        
          <a href="#proof-of-concept-22" class="anchor-heading" aria-labelledby="proof-of-concept-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L699">Line 699 of OpenMEVRouter.sol</a></p>
      <h4 id="impact-22">
        
        
          <a href="#impact-22" class="anchor-heading" aria-labelledby="impact-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-22">
        
        
          <a href="#recommendation-22" class="anchor-heading" aria-labelledby="recommendation-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Replace all instances of <code class="language-plaintext highlighter-rouge">pair.swap()</code> with <code class="language-plaintext highlighter-rouge">_asmSwap()</code>. This may allow the swap to be moved out of <code class="language-plaintext highlighter-rouge">_swapSupportingFeeOnTransferTokensExecute()</code> and into <code class="language-plaintext highlighter-rouge">_swapSupportingFeeOnTransferTokens()</code>.</p>
      <h4 id="developer-response-sandy-22">
        
        
          <a href="#developer-response-sandy-22" class="anchor-heading" aria-labelledby="developer-response-sandy-22"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/d0e2d4f644078251ddacac1a45b3c6a2c4220189">Fixed</a>.</p>
      <h3 id="16-gas---remove-a-sorttokens-call-engn33r">
        
        
          <a href="#16-gas---remove-a-sorttokens-call-engn33r" class="anchor-heading" aria-labelledby="16-gas---remove-a-sorttokens-call-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 16. Gas - Remove a sortTokens call (engn33r)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">_swapSupportingFeeOnTransferTokens()</code> in OpenMevRouter.sol calls <code class="language-plaintext highlighter-rouge">sortTokens()</code> twice. Caching the outputs from the first call can remove the need for the 2nd call.</p>
      <h4 id="proof-of-concept-23">
        
        
          <a href="#proof-of-concept-23" class="anchor-heading" aria-labelledby="proof-of-concept-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L714">The first <code class="language-plaintext highlighter-rouge">sortTokens()</code> call</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L714">The second <code class="language-plaintext highlighter-rouge">sortTokens()</code> call happens in <code class="language-plaintext highlighter-rouge">pairFor()</code></a></li>
</ul>
      <h4 id="impact-23">
        
        
          <a href="#impact-23" class="anchor-heading" aria-labelledby="impact-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-23">
        
        
          <a href="#recommendation-23" class="anchor-heading" aria-labelledby="recommendation-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Cache the outputs from the first <code class="language-plaintext highlighter-rouge">sortTokens()</code> call, then replace <code class="language-plaintext highlighter-rouge">OpenMevLibrary.pairFor()</code> with <code class="language-plaintext highlighter-rouge">OpenMevLibrary._asmPairFor()</code>.</p>
      <h4 id="developer-response-sandy-23">
        
        
          <a href="#developer-response-sandy-23" class="anchor-heading" aria-labelledby="developer-response-sandy-23"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/9abb39d419a79c21c22c40a85dfd8e6cd94c801c">Fixed</a>.</p>
      <h3 id="17-gas---missing-curly-brace-engn33r">
        
        
          <a href="#17-gas---missing-curly-brace-engn33r" class="anchor-heading" aria-labelledby="17-gas---missing-curly-brace-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 17. Gas - Missing curly brace (engn33r)
        
        
      </h3>
    

<p>The final if statement in <code class="language-plaintext highlighter-rouge">withdrawLiquidityAndSwap()</code> is missing curly braces. The code added in OpenMevZapper not found in Beefy is designed to save gas, but the curly braces are necessary to provide the gas savings. Otherwise the token swap always happens even if <code class="language-plaintext highlighter-rouge">desiredTokenOutMin</code> of <code class="language-plaintext highlighter-rouge">desiredToken</code> are already available to send to the user.</p>
      <h4 id="proof-of-concept-24">
        
        
          <a href="#proof-of-concept-24" class="anchor-heading" aria-labelledby="proof-of-concept-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L107-L115">This if statement</a> is missing curly braces.</p>
      <h4 id="impact-24">
        
        
          <a href="#impact-24" class="anchor-heading" aria-labelledby="impact-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-24">
        
        
          <a href="#recommendation-24" class="anchor-heading" aria-labelledby="recommendation-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>The revised code should read</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="p">(</span><span class="n">desiredTokenOutMin</span> <span class="o">&gt;</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">desiredToken</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">desiredSwapAmount</span> <span class="o">=</span> <span class="n">desiredTokenOutMin</span> <span class="o">-</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">desiredToken</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
            <span class="n">router</span><span class="p">.</span><span class="n">swapExactTokensForTokens</span><span class="p">(</span>
                <span class="n">ERC20</span><span class="p">(</span><span class="n">swapToken</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)),</span>
                <span class="n">desiredSwapAmount</span><span class="p">,</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span>
                <span class="n">block</span><span class="p">.</span><span class="n">timestamp</span>
            <span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>
      <h4 id="developer-response-sandy-24">
        
        
          <a href="#developer-response-sandy-24" class="anchor-heading" aria-labelledby="developer-response-sandy-24"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>I think there is some confusion over the intention of this code. I have added a comment above this condition to mitigate this in future in <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/27e04357e7dceb38ad9e65eef068363f98a192da">commit 27e04357e7dceb38ad9e65eef068363f98a192da</a></p>

<p>Essentially, the last swap needs to happen regardless of the prior condition. The condition sets a sensible expected amount out min for the last swap. As an example, if a user has ~$100 of liquidity for a USDC-DAI pool and wants to withdraw all in USDC, they might set <code class="language-plaintext highlighter-rouge">desiredTokenOutMin</code> to 96 USDC. After <code class="language-plaintext highlighter-rouge">_removeLiquidity</code> there might be ~ 49 USDC on the Zapper contract, so the minimum amount needed for the last swap (DAI-&gt;USDC) is 96 - 49 = 47 USDC. If the user specifies <code class="language-plaintext highlighter-rouge">desiredTokenOutMin</code> to be lower than 49 (amount already withdrawn), then the min amount out number remained the same. This has now been changed <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/c44e0a232f9c1c87f867d59bf2d195c585517c84">to default to zero in this case</a>, for consistency.</p>
      <h3 id="18-gas---reduce-number-of-swaps-engn33r">
        
        
          <a href="#18-gas---reduce-number-of-swaps-engn33r" class="anchor-heading" aria-labelledby="18-gas---reduce-number-of-swaps-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 18. Gas - Reduce number of swaps (engn33r)
        
        
      </h3>
    

<p>There are three steps in the swap and arb process. The steps are: 1. Perform the user swap with factory0 2. Perform arb with a swap in the opposite direction with optimalAmount on factory0 3. Continue the arb with a swap in the initial direction on factory1. The first two steps (swap and arb on the same factory liquidity pool) can be combined because the 2nd step is effectively reversing a part of the first step. Because the end goal is to remove a price differential between the Uniswap and SushiSwap pools, this can be achieved by splitting the initial user swap between the Uniswap and SushiSwap pools to optimize the overall exchange rate rather than by arbing a larger swap that happens in a single LP. The profit for OpenMevRouter can be taken from the improved exchange rate (returning the user tokens based on the exchange rate if the swap happened in only one LP) rather than taking profit from the arb.</p>
      <h4 id="proof-of-concept-25">
        
        
          <a href="#proof-of-concept-25" class="anchor-heading" aria-labelledby="proof-of-concept-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Consider the constant product diagram
<img src="../../assets/images/openmev/constant_product_swaps.jpg" alt="Constant Product Swaps" /></p>

<p>Point 1 shows the liquidity pool amounts before OpenMevRouter interaction, point 2 shows the amounts after the OpenMevRouter user swap, and point 3 shows the amounts after the first backrun of the arb process. These two steps can be combined to arrive from point 1 to point 3, skipping to need to swap to arrive at point 2. The math in OpenMevRouter.sol would need changing, but gas savings from removing one swap may be enough to reduce overall gas consumption.</p>
      <h4 id="impact-25">
        
        
          <a href="#impact-25" class="anchor-heading" aria-labelledby="impact-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-25">
        
        
          <a href="#recommendation-25" class="anchor-heading" aria-labelledby="recommendation-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove a swap by combining the user swap and the first step of the backrun that reverse the user swap by exchanging output token to input token.</p>
      <h4 id="developer-response-sandy-25">
        
        
          <a href="#developer-response-sandy-25" class="anchor-heading" aria-labelledby="developer-response-sandy-25"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Smart order routers are alternative solutions to the same MEV extraction and protection provided by this backrun solution. Indeed it is a project we are currently working on separately with an aggregation of more exchange pools. This project however, primarily services sushiswap pools by design.</p>
      <h3 id="19-gas---revert-if-zero-flashloan-profit-engn33r">
        
        
          <a href="#19-gas---revert-if-zero-flashloan-profit-engn33r" class="anchor-heading" aria-labelledby="19-gas---revert-if-zero-flashloan-profit-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 19. Gas - Revert if zero flashloan profit (engn33r)
        
        
      </h3>
    

<p>If there is no profit realized from the flashloan arb, the flashloan should revert to save remaining gas just like it would revert if there is loss of value.</p>
      <h4 id="proof-of-concept-26">
        
        
          <a href="#proof-of-concept-26" class="anchor-heading" aria-labelledby="proof-of-concept-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The revert logic for the kashi flashloan callback <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L966">is currently</a>:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">amountOver</span> <span class="o">&lt;</span> <span class="n">amountOwing</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientOutputAmount</span><span class="p">();</span>
</code></pre></div></div>

<p>Instead, the revert should also happen on the equality case:</p>
<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">amountOver</span> <span class="o">&lt;=</span> <span class="n">amountOwing</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientOutputAmount</span><span class="p">();</span>
</code></pre></div></div>

<p>The same improvement can be made in <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1042">the Aave flashloan callback</a>.</p>
      <h4 id="impact-26">
        
        
          <a href="#impact-26" class="anchor-heading" aria-labelledby="impact-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-26">
        
        
          <a href="#recommendation-26" class="anchor-heading" aria-labelledby="recommendation-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Revert on zero profit case.</p>
      <h4 id="developer-response-sandy-26">
        
        
          <a href="#developer-response-sandy-26" class="anchor-heading" aria-labelledby="developer-response-sandy-26"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/94d6eb07faaf08996aa3521218ace680576ba15e">Fixed</a>.</p>
      <h2 id="informational-findings">
        
        
          <a href="#informational-findings" class="anchor-heading" aria-labelledby="informational-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Informational Findings
        
        
      </h2>
    
      <h3 id="1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson">
        
        
          <a href="#1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson" class="anchor-heading" aria-labelledby="1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Informational - OpenMevRouter should inherit from IFlashBorrower and IOpenMevRouter (Jackson)
        
        
      </h3>
    

<p>OpenMevRouter should also inherit from IFlashBorrower and IOpenMevRouter aside from TwoStepOwnable.</p>
      <h4 id="impact-27">
        
        
          <a href="#impact-27" class="anchor-heading" aria-labelledby="impact-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Type safety.</p>
      <h4 id="developer-response-sandy-27">
        
        
          <a href="#developer-response-sandy-27" class="anchor-heading" aria-labelledby="developer-response-sandy-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/542747f58ae201c44a90aae2615c311326e42ff8">Fixed</a>.</p>
      <h3 id="2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson">
        
        
          <a href="#2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson" class="anchor-heading" aria-labelledby="2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Informational - The ETHERSCAN_API key is present in plaintext (Jackson)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">ETHERSCAN_API</code> is present in plaintext in test_Swaps.py</p>
      <h4 id="impact-28">
        
        
          <a href="#impact-28" class="anchor-heading" aria-labelledby="impact-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Malicious use of your Etherscan API key.</p>
      <h4 id="developer-response-sandy-28">
        
        
          <a href="#developer-response-sandy-28" class="anchor-heading" aria-labelledby="developer-response-sandy-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Fixed in <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/b9afaf51d69ff5d532acb10803ce1a08f638de14">this commit</a>.</p>
      <h3 id="3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson">
        
        
          <a href="#3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson" class="anchor-heading" aria-labelledby="3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Informational - SafeTransferLib does not match Solmate’s main branch (Jackson)
        
        
      </h3>
    

<p>The SafeTransferLib does not match Solmate’s latest implementation.  Consider whether an update would be useful or save gas.</p>
      <h4 id="impact-29">
        
        
          <a href="#impact-29" class="anchor-heading" aria-labelledby="impact-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Possible gas savings.</p>
      <h4 id="developer-response-sandy-29">
        
        
          <a href="#developer-response-sandy-29" class="anchor-heading" aria-labelledby="developer-response-sandy-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/3becfe2bc1f21d6aae09b6c1096e33cc1c5970cd">Fixed</a>.</p>
      <h3 id="4-informational---incorrect-comment-engn33r-jackson">
        
        
          <a href="#4-informational---incorrect-comment-engn33r-jackson" class="anchor-heading" aria-labelledby="4-informational---incorrect-comment-engn33r-jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Informational - Incorrect comment (engn33r, Jackson)
        
        
      </h3>
    

<p>A comment in OpenMevRouter.sol has an extra function argument that doesn’t exist in the code.</p>

<p>Elsewhere, in <code class="language-plaintext highlighter-rouge">addLiquidityETH()</code></p>
      <h4 id="proof-of-concept-27">
        
        
          <a href="#proof-of-concept-27" class="anchor-heading" aria-labelledby="proof-of-concept-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1001-L1002">The comment on line 1001</a> doesn’t match the code in line 1002.</p>
      <h4 id="impact-30">
        
        
          <a href="#impact-30" class="anchor-heading" aria-labelledby="impact-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-27">
        
        
          <a href="#recommendation-27" class="anchor-heading" aria-labelledby="recommendation-27"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Remove the extra function argument.</p>
      <h4 id="developer-response-sandy-30">
        
        
          <a href="#developer-response-sandy-30" class="anchor-heading" aria-labelledby="developer-response-sandy-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/781df0276ae79450ec9da09b39970d99b9c42af5">Fixed</a>.</p>
      <h3 id="5-informational---replace-magic-numbers-with-constants-engn33r">
        
        
          <a href="#5-informational---replace-magic-numbers-with-constants-engn33r" class="anchor-heading" aria-labelledby="5-informational---replace-magic-numbers-with-constants-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Informational - Replace magic numbers with constants (engn33r)
        
        
      </h3>
    

<p>Constant variables should be used in place of magic numbers to prevent typos. For one example, the magic number 1000 is found in multiple places in OpenMevRouter.sol and should be replaced with a constant. Using a constant also adds a description using the variable name to explain what this value is for. This will not change gas consumption.</p>
      <h4 id="proof-of-concept-28">
        
        
          <a href="#proof-of-concept-28" class="anchor-heading" aria-labelledby="proof-of-concept-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>There are many instances of the value 1000. Consider replacing this magic number with a constant internal variable named MINIMUM_LIQUIDITY <a href="https://github.com/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2Pair.sol#L15">like Uniswap does</a>:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L726">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L729">Second instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L57-L58">Third instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L136">Fourth instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L171">Fifth instance</a></li>
</ul>

<p>Other instances of magic numbers <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L416-427">are found in <code class="language-plaintext highlighter-rouge">calcCoeffs()</code></a>.</p>
      <h4 id="impact-31">
        
        
          <a href="#impact-31" class="anchor-heading" aria-labelledby="impact-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-28">
        
        
          <a href="#recommendation-28" class="anchor-heading" aria-labelledby="recommendation-28"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use constant variables instead of magic numbers</p>
      <h4 id="developer-response-sandy-31">
        
        
          <a href="#developer-response-sandy-31" class="anchor-heading" aria-labelledby="developer-response-sandy-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/9fdfb43c6f2d99056d9a95f8531391e907b85e3d"><code class="language-plaintext highlighter-rouge">MINIMUM_LIQUIDITY</code> has been used in a fix</a>.</p>

<p>Some of the other numbers fall straight out of an equation derived in separate documentation and do not suit constants for efficiency or understanding.</p>
      <h3 id="6-informational---typos-engn33r">
        
        
          <a href="#6-informational---typos-engn33r" class="anchor-heading" aria-labelledby="6-informational---typos-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Informational - Typos (engn33r)
        
        
      </h3>
    

<p><code class="language-plaintext highlighter-rouge">balanaceToDistribute</code> might be better named <code class="language-plaintext highlighter-rouge">balanceToDistribute</code>. <code class="language-plaintext highlighter-rouge">isBackrunable</code> might be better named <code class="language-plaintext highlighter-rouge">isBackrunnable</code>.</p>
      <h4 id="proof-of-concept-29">
        
        
          <a href="#proof-of-concept-29" class="anchor-heading" aria-labelledby="proof-of-concept-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1147">First typo</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L28">Second typo</a></li>
</ul>
      <h4 id="impact-32">
        
        
          <a href="#impact-32" class="anchor-heading" aria-labelledby="impact-32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-29">
        
        
          <a href="#recommendation-29" class="anchor-heading" aria-labelledby="recommendation-29"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Fix typos</p>
      <h4 id="developer-response-sandy-32">
        
        
          <a href="#developer-response-sandy-32" class="anchor-heading" aria-labelledby="developer-response-sandy-32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/6bd258b3cead1efd4d59e9e9c547b94951125be5">Fixed</a>.</p>
      <h3 id="7-informational---hard-coded-aave-token-list-engn33r">
        
        
          <a href="#7-informational---hard-coded-aave-token-list-engn33r" class="anchor-heading" aria-labelledby="7-informational---hard-coded-aave-token-list-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Informational - Hard coded Aave token list (engn33r)
        
        
      </h3>
    

<p>Aave can modify their list of supported tokens that support flashloans. The <code class="language-plaintext highlighter-rouge">aaveList()</code> function in OpenMevLibrary.sol stores a hard coded list of these tokens, meaning OpenMevRouter does not support a way of updating its internal list of tokens supporting Aave flashloans.</p>

<p>The list in the contract does match <a href="https://aave.github.io/aave-addresses/mainnet.json">the list of supported Aave tokens</a> at the time of this review.</p>
      <h4 id="proof-of-concept-30">
        
        
          <a href="#proof-of-concept-30" class="anchor-heading" aria-labelledby="proof-of-concept-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L343">The hard coded list of tokens</a> in OpenMevLibrary.sol.</p>
      <h4 id="impact-33">
        
        
          <a href="#impact-33" class="anchor-heading" aria-labelledby="impact-33"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-30">
        
        
          <a href="#recommendation-30" class="anchor-heading" aria-labelledby="recommendation-30"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Store Aave token addresses in a state variable that has a setter function with the onlyOwner modifier to enable changes to the Aave token list.</p>
      <h4 id="developer-response-sandy-33">
        
        
          <a href="#developer-response-sandy-33" class="anchor-heading" aria-labelledby="developer-response-sandy-33"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Fixed <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/4611ad165f2e7d937f656757f5780acd40424565">here</a> and <a href="https://github.com/manifoldfinance/OpenMevRouter/commit/133a105c0e184add3e950d5a5f7f28d16df9d060">here</a>.</p>
      <h3 id="8-informational---inconsistency-in-weth-transfers-engn33r">
        
        
          <a href="#8-informational---inconsistency-in-weth-transfers-engn33r" class="anchor-heading" aria-labelledby="8-informational---inconsistency-in-weth-transfers-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Informational - Inconsistency in WETH transfers (engn33r)
        
        
      </h3>
    

<p>There is one inconsistent instance of WETH transfer. Consider using a consistent approach for gas savings and code simplification.</p>
      <h4 id="proof-of-concept-31">
        
        
          <a href="#proof-of-concept-31" class="anchor-heading" aria-labelledby="proof-of-concept-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L226">The one instance of a WETH transfer</a> with <code class="language-plaintext highlighter-rouge">require(IWETH(weth).transfer(pair, amount));</code>.</p>

<p>All other instances use <code class="language-plaintext highlighter-rouge">IWETH(weth).deposit{ value: amount }();</code></p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L225">First instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L564">Second instance</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L679">Third instance</a></li>
</ul>
      <h4 id="impact-34">
        
        
          <a href="#impact-34" class="anchor-heading" aria-labelledby="impact-34"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-31">
        
        
          <a href="#recommendation-31" class="anchor-heading" aria-labelledby="recommendation-31"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use consistent WETH transfer approach.</p>
      <h4 id="developer-response-sandy-34">
        
        
          <a href="#developer-response-sandy-34" class="anchor-heading" aria-labelledby="developer-response-sandy-34"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/ee18037b1b1f6ecc4c3ba2f3e324cab3028d87ff">Fixed</a>.</p>
      <h3 id="9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r">
        
        
          <a href="#9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r" class="anchor-heading" aria-labelledby="9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Informational - safeApprove vulnerable to double withdraw (engn33r)
        
        
      </h3>
    

<p>Using <code class="language-plaintext highlighter-rouge">approve()</code> or <code class="language-plaintext highlighter-rouge">safeApprove()</code> adds <a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-">the risk of a double withdrawal</a>.</p>

<p>The same race condition <a href="https://eips.ethereum.org/EIPS/eip-2612#security-considerations">applies to <code class="language-plaintext highlighter-rouge">permit()</code></a>.</p>

<p>Furthermore, the <code class="language-plaintext highlighter-rouge">safeApprove()</code> function <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/57725120581e27ec469e1c7e497a4008aafff818/contracts/token/ERC20/utils/SafeERC20.sol#L39-L58">is deprecated per OpenZeppelin docs</a>.</p>
      <h4 id="proof-of-concept-32">
        
        
          <a href="#proof-of-concept-32" class="anchor-heading" aria-labelledby="proof-of-concept-32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L1043">One relevant <code class="language-plaintext highlighter-rouge">safeApprove()</code> call was found</a>.</p>

<p>Permit is used in several functions in OpenMevRouter.sol:</p>
<ul>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L327">First function</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L366">Second function</a></li>
  <li><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L428">Third function</a></li>
</ul>
      <h4 id="impact-35">
        
        
          <a href="#impact-35" class="anchor-heading" aria-labelledby="impact-35"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational. This has not been shown to be a notable problem on mainnet, but better solutions do exist.</p>
      <h4 id="recommendation-32">
        
        
          <a href="#recommendation-32" class="anchor-heading" aria-labelledby="recommendation-32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use <code class="language-plaintext highlighter-rouge">safeIncreaseAllowance()</code> or <code class="language-plaintext highlighter-rouge">safeDecreaseAllowance()</code> instead of <code class="language-plaintext highlighter-rouge">safeApprove()</code>.</p>
      <h4 id="developer-response-sandy-35">
        
        
          <a href="#developer-response-sandy-35" class="anchor-heading" aria-labelledby="developer-response-sandy-35"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Acknowledged.</p>
      <h3 id="10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r">
        
        
          <a href="#10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r" class="anchor-heading" aria-labelledby="10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Informational - Same frontrunning weaknesses as Uniswap/SushiSwap (engn33r)
        
        
      </h3>
    

<p>While the description of this protection is to prevent MEV extraction with a specific form of MEV, there is no protection for other forms of MEV. This is acknowledged by the devs in <a href="https://github.com/manifoldfinance/OpenMevRouter/wiki/V01-Router-Spec-Doc#front-running-and-transaction-reordering">project documentation</a>, with acknowledgement that Uniswap does not protect against this either. Attack vectors such as frontrunning or an uncle bandit attack can extract value from transactions that swap with OpenMevRouter.sol because only backrun arbitrage MEV protection is built into the OpenMevRouter design.</p>
      <h4 id="proof-of-concept-33">
        
        
          <a href="#proof-of-concept-33" class="anchor-heading" aria-labelledby="proof-of-concept-33"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/wiki/V01-Router-Spec-Doc#front-running-and-transaction-reordering">Project documentation explaining these attack vectors still remain</a>.</p>
      <h4 id="impact-36">
        
        
          <a href="#impact-36" class="anchor-heading" aria-labelledby="impact-36"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-33">
        
        
          <a href="#recommendation-33" class="anchor-heading" aria-labelledby="recommendation-33"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Clarify user documentation to make it clear that <code class="language-plaintext highlighter-rouge">amountOutMin</code> or a similarly named function argument is still an important slippage setting in OpenMevRouter.sol and OpenMevZapper.sol.</p>
      <h4 id="developer-response-sandy-36">
        
        
          <a href="#developer-response-sandy-36" class="anchor-heading" aria-labelledby="developer-response-sandy-36"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p>Acknowledged.</p>
      <h3 id="11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r">
        
        
          <a href="#11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r" class="anchor-heading" aria-labelledby="11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. Informational - Kashi flashloanable tokens assumed same as aave (engn33r)
        
        
      </h3>
    

<p>The list of tokens that can be flashloaned with Kashi is assumed to be the same as the list of tokens that can be flashloaned from Aave. If there is a token that can be flashloaned with Kashi, the <code class="language-plaintext highlighter-rouge">_backrunSwaps()</code> function will never perform a backrun with this token even though it may result in profit.</p>
      <h4 id="proof-of-concept-34">
        
        
          <a href="#proof-of-concept-34" class="anchor-heading" aria-labelledby="proof-of-concept-34"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The logic to backrun a swap happens if either there is sufficient token balance in the router that no flashloan is needed, or the token can be flashloaned from Aave. There is no separate list of Kashi-supported flashloanable tokens. <a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L882">Only a list of Aave flashloanable tokens exists</a>.</p>
      <h4 id="impact-37">
        
        
          <a href="#impact-37" class="anchor-heading" aria-labelledby="impact-37"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-34">
        
        
          <a href="#recommendation-34" class="anchor-heading" aria-labelledby="recommendation-34"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Add a list of Kashi flashloanable tokens to allow profitable backruns if Kashi supports more flashloanable tokens than Aave.</p>
      <h4 id="developer-response-sandy-37">
        
        
          <a href="#developer-response-sandy-37" class="anchor-heading" aria-labelledby="developer-response-sandy-37"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/7e6bc4652da20d00cc5c6fbb68860c4cc054678c">Fixed</a>.</p>
      <h3 id="12-informational----engn33r">
        
        
          <a href="#12-informational----engn33r" class="anchor-heading" aria-labelledby="12-informational----engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 12. Informational -  (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">add512x512()</code> additional function has a comment copied from <code class="language-plaintext highlighter-rouge">sub512x512()</code> which reads “Calculates the difference of two uint512”. It should instead read “Calculates the sum of two uint512”.</p>
      <h4 id="proof-of-concept-35">
        
        
          <a href="#proof-of-concept-35" class="anchor-heading" aria-labelledby="proof-of-concept-35"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/Uint512.sol#L67">Incorrect comment for <code class="language-plaintext highlighter-rouge">add512x512()</code></a></p>
      <h4 id="impact-38">
        
        
          <a href="#impact-38" class="anchor-heading" aria-labelledby="impact-38"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-35">
        
        
          <a href="#recommendation-35" class="anchor-heading" aria-labelledby="recommendation-35"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Fix the comment as described to properly describe function purpose.</p>
      <h4 id="developer-response-sandy-38">
        
        
          <a href="#developer-response-sandy-38" class="anchor-heading" aria-labelledby="developer-response-sandy-38"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer response (Sandy)
        
        
      </h4>
    

<p><a href="https://github.com/manifoldfinance/OpenMevRouter/commit/a17f696178fa655fbbf4e87c6a36a8d840a7a97a">Fixed</a>.</p>
      <h2 id="final-remarks">
        
        
          <a href="#final-remarks" class="anchor-heading" aria-labelledby="final-remarks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Final remarks
        
        
      </h2>
    
      <h3 id="engn33r">
        
        
          <a href="#engn33r" class="anchor-heading" aria-labelledby="engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> engn33r
        
        
      </h3>
    

<p>The custom logic around the backrun to capture MEV and the corresponding whitepaper with equation derivations is well thought out and implemented. The main points of concern are actually the modifications made to forked code from Uniswap and Beefy, as the high risk findings indicate. The gas savings optimizations applied to the OpenMevRouter contracts are above and beyond the level of most projects. I think this project can play an important role in the future of MEV and the solid code structure gives me confidence it can properly fill this role.</p>
      <h3 id="jackson">
        
        
          <a href="#jackson" class="anchor-heading" aria-labelledby="jackson"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Jackson
        
        
      </h3>
    

<p>This is one of those ideas that you think “why didn’t I think of that?”.  I’m excited for it to go into production and see what the effects will be for both users and holders of Sushi.  The number, type, and breadth of tests give me confidence in the correctness of the implementation.  My only concerns are around whether we missed something related to the intention of the implementation as most of the high and medium findings seem to suggest.</p>
      <h2 id="about-yacademy">
        
        
          <a href="#about-yacademy" class="anchor-heading" aria-labelledby="about-yacademy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> About yAcademy
        
        
      </h2>
    

<p>yAcademy is an ecosystem initiative started by Yearn Finance and its ecosystem partners to bootstrap sustainable and collaborative blockchain security reviews and to nurture aspiring security talent.  yAcademy includes a fellowship program and a residents program.  In the fellowship program, fellows perform a series of periodic security reviews and presentations during the program. Residents are past fellows who continue to gain experience by performing security reviews of contracts submitted to yAcademy for review (such as this contract).</p>
      <h2 id="appendix-and-faq">
        
        
          <a href="#appendix-and-faq" class="anchor-heading" aria-labelledby="appendix-and-faq"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Appendix and FAQ
        
        
      </h2>

        

        

        
        
          <hr>
          <footer>
            
              <p><a href="#top" id="back-to-top">Back to top</a></p>
            

            

            
              <div class="d-flex mt-2">
                
                
              </div>
            
          </footer>
        

      </div>
    </div>

    
      

      <div class="search-overlay"></div>
    
  </div>
  <link rel="image_src" href="https://yaudit.dev/assets/images/logo.png" />
</body>

  <script>
    var config = {}
;
    mermaid.initialize(config);
    window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
  </script>

</html>

