

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">


  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  

  
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script>
  

  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>
  <script defer data-domain="reports.yAudit.dev" src="https://plausible.io/js/script.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>03-2022-Ohm | yAudit Reports</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="03-2022-Ohm" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="OlympusGive yAcademy Report" />
<meta property="og:description" content="OlympusGive yAcademy Report" />
<link rel="canonical" href="http://localhost:4000/reports/03-2022-Ohm/" />
<meta property="og:url" content="http://localhost:4000/reports/03-2022-Ohm/" />
<meta property="og:site_name" content="yAudit Reports" />
<meta property="og:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/logo.png" />
<meta property="twitter:title" content="03-2022-Ohm" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"OlympusGive yAcademy Report","headline":"03-2022-Ohm","image":"http://localhost:4000/assets/images/logo.png","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/yaudit-logo.jpg"}},"url":"http://localhost:4000/reports/03-2022-Ohm/"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <a class="skip-to-main" href="#main-content">Skip to main content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
    <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE -->
<symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link">
  <title id="svg-external-link-title">(external link)</title>
  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line>
</symbol>

  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="/" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
      
        <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">yAudit Reports</a></li><li class="nav-list-item active"><a href="/reports/03-2022-Ohm/" class="nav-list-link active">03-2022-Ohm</a></li><li class="nav-list-item"><a href="/reports/04-2022-Ohm-Bond/" class="nav-list-link">04-2022-Ohm-Bond</a></li><li class="nav-list-item"><a href="/reports/04-2022-veYFI/" class="nav-list-link">04-2022-veYFI</a></li><li class="nav-list-item"><a href="/reports/05-2022-OpenMEVRouter/" class="nav-list-link">05-2022-OpenMEV</a></li><li class="nav-list-item"><a href="/reports/08-2022-Bunni/" class="nav-list-link">08-2022-Bunni</a></li><li class="nav-list-item"><a href="/reports/08-2022-Timeless-Yield-Daddy/" class="nav-list-link">08-2022-Timeless-Yield-Daddy</a></li><li class="nav-list-item"><a href="/reports/09-2022-yFu-NFT/" class="nav-list-link">09-2022-yFu-NFT</a></li><li class="nav-list-item"><a href="/reports/10-2022-NounsDAO-Token-Buyer/" class="nav-list-link">10-2022-NounsDAO-Token-Buyer</a></li><li class="nav-list-item"><a href="/reports/12-2022-Gro-Protocol/" class="nav-list-link">12-2022-Gro-Protocol</a></li><li class="nav-list-item external">
      <a href="https://yaudit.dev/" class="nav-list-link external">
        yAudit Website
        <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg>
      </a>
    </li></ul>
      
      
    </nav>

    
    
      <footer class="site-footer">
        <!-- This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. -->
      </footer>
    
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      

        

        <div class="search">
          <div class="search-input-wrap">
            <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search yAudit Reports" aria-label="Search yAudit Reports" autocomplete="off">
            <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      
      
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <h1 class="no_toc" id="yacademy-ohm-review">
        
        
          <a href="#yacademy-ohm-review" class="anchor-heading" aria-labelledby="yacademy-ohm-review"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> yAcademy Ohm review
        
        
      </h1>
    

<p><strong>Review Resources:</strong>
<a href="https://docs.google.com/document/d/1XIMptjXVTRstmuptVptcOQycYOEmceZTu1uu1zoeYJw/edit">Requirements Doc</a>
<a href="https://docs.google.com/document/d/1WvggImQRq7CH-Wpgjk0yszHUWdQWQ5N_MlzJPtnH_r0/edit">Support Doc</a></p>

<p><strong>Residents:</strong></p>
<ul>
  <li>NibblerExpress</li>
  <li>Sjkelleyjr</li>
  <li>Engn33r</li>
</ul>
      <h2 class="no_toc" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#review-summary" id="markdown-toc-review-summary">Review Summary</a></li>
  <li><a href="#scope" id="markdown-toc-scope">Scope</a></li>
  <li><a href="#code-evaluation-matrix" id="markdown-toc-code-evaluation-matrix">Code Evaluation Matrix</a></li>
  <li><a href="#findings-explanation" id="markdown-toc-findings-explanation">Findings Explanation</a></li>
  <li><a href="#high-findings" id="markdown-toc-high-findings">High Findings</a>    <ol>
      <li><a href="#1-stakingunstake-should-set-rebasing-bool-to-true-engn33r" id="markdown-toc-1-stakingunstake-should-set-rebasing-bool-to-true-engn33r">1. staking.unstake() should set rebasing bool to true (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept" id="markdown-toc-proof-of-concept">Proof of concept</a></li>
          <li><a href="#impact" id="markdown-toc-impact">Impact</a></li>
          <li><a href="#recommendation" id="markdown-toc-recommendation">Recommendation</a></li>
          <li><a href="#remediation-status" id="markdown-toc-remediation-status">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#2-sandwich-attack-risk-in-yieldstreamersol-engn33r" id="markdown-toc-2-sandwich-attack-risk-in-yieldstreamersol-engn33r">2. Sandwich attack risk in YieldStreamer.sol (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-1" id="markdown-toc-proof-of-concept-1">Proof of concept</a></li>
          <li><a href="#impact-1" id="markdown-toc-impact-1">Impact</a></li>
          <li><a href="#recommendation-1" id="markdown-toc-recommendation-1">Recommendation</a></li>
          <li><a href="#remediation-status-1" id="markdown-toc-remediation-status-1">Remediation Status</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#medium-findings" id="markdown-toc-medium-findings">Medium Findings</a>    <ol>
      <li><a href="#1-denial-of-service-in-upkeep-for-loop-in-yieldstreamersol-sjkelleyjr" id="markdown-toc-1-denial-of-service-in-upkeep-for-loop-in-yieldstreamersol-sjkelleyjr">1. Denial of service in upkeep “for” loop in YieldStreamer.sol (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-2" id="markdown-toc-proof-of-concept-2">Proof of concept</a></li>
          <li><a href="#impact-2" id="markdown-toc-impact-2">Impact</a></li>
          <li><a href="#recommendation-2" id="markdown-toc-recommendation-2">Recommendation</a></li>
          <li><a href="#remediation-status-2" id="markdown-toc-remediation-status-2">Remediation Status</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#low-findings" id="markdown-toc-low-findings">Low Findings</a>    <ol>
      <li><a href="#1-donatedto-and-depositsto-only-return-the-first-of-n-possible-donation-or-deposit-mappings-sjkelleyjr" id="markdown-toc-1-donatedto-and-depositsto-only-return-the-first-of-n-possible-donation-or-deposit-mappings-sjkelleyjr">1. <code class="language-plaintext highlighter-rouge">donatedTo</code> and <code class="language-plaintext highlighter-rouge">depositsTo</code> only return the first of N possible donation or deposit mappings (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-3" id="markdown-toc-proof-of-concept-3">Proof of concept</a></li>
          <li><a href="#impact-3" id="markdown-toc-impact-3">Impact</a></li>
          <li><a href="#recommendation-3" id="markdown-toc-recommendation-3">Recommendation</a></li>
          <li><a href="#remediation-status-3" id="markdown-toc-remediation-status-3">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#2-_redeemall-does-not-delete-recipientlookup-sjkelleyjr" id="markdown-toc-2-_redeemall-does-not-delete-recipientlookup-sjkelleyjr">2. <code class="language-plaintext highlighter-rouge">_redeemAll()</code> does not delete recipientLookup (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-4" id="markdown-toc-proof-of-concept-4">Proof of concept</a></li>
          <li><a href="#impact-4" id="markdown-toc-impact-4">Impact</a></li>
          <li><a href="#recommendation-4" id="markdown-toc-recommendation-4">Recommendation</a></li>
          <li><a href="#remediation-status-4" id="markdown-toc-remediation-status-4">Remediation Status</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#gas-savings-findings" id="markdown-toc-gas-savings-findings">Gas Savings Findings</a>    <ol>
      <li><a href="#1-declare-function-external-for-gas-savings-sjkelleyjr" id="markdown-toc-1-declare-function-external-for-gas-savings-sjkelleyjr">1. Declare function external for gas savings (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-5" id="markdown-toc-proof-of-concept-5">Proof of concept</a></li>
          <li><a href="#impact-5" id="markdown-toc-impact-5">Impact</a></li>
          <li><a href="#recommendation-5" id="markdown-toc-recommendation-5">Recommendation</a></li>
          <li><a href="#remediation-status-5" id="markdown-toc-remediation-status-5">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#2-use--for-gas-savings-sjkelleyjr" id="markdown-toc-2-use--for-gas-savings-sjkelleyjr">2. Use == for gas savings (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-6" id="markdown-toc-proof-of-concept-6">Proof of concept</a></li>
          <li><a href="#impact-6" id="markdown-toc-impact-6">Impact</a></li>
          <li><a href="#recommendation-6" id="markdown-toc-recommendation-6">Recommendation</a></li>
          <li><a href="#remediation-status-6" id="markdown-toc-remediation-status-6">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#3-simplify-math-for-gas-savings-engn33r" id="markdown-toc-3-simplify-math-for-gas-savings-engn33r">3. Simplify math for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-7" id="markdown-toc-proof-of-concept-7">Proof of concept</a></li>
          <li><a href="#impact-7" id="markdown-toc-impact-7">Impact</a></li>
          <li><a href="#recommendation-7" id="markdown-toc-recommendation-7">Recommendation</a></li>
          <li><a href="#remediation-status-7" id="markdown-toc-remediation-status-7">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#4-use-msgsender-for-gas-savings-engn33r" id="markdown-toc-4-use-msgsender-for-gas-savings-engn33r">4. Use msg.sender for gas savings (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-8" id="markdown-toc-proof-of-concept-8">Proof of concept</a></li>
          <li><a href="#impact-8" id="markdown-toc-impact-8">Impact</a></li>
          <li><a href="#recommendation-8" id="markdown-toc-recommendation-8">Recommendation</a></li>
          <li><a href="#remediation-status-8" id="markdown-toc-remediation-status-8">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#5-remove-functions-to-save-gas-on-deployment-engn33r" id="markdown-toc-5-remove-functions-to-save-gas-on-deployment-engn33r">5. Remove functions to save gas on deployment (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-9" id="markdown-toc-proof-of-concept-9">Proof of concept</a></li>
          <li><a href="#impact-9" id="markdown-toc-impact-9">Impact</a></li>
          <li><a href="#recommendation-9" id="markdown-toc-recommendation-9">Recommendation</a></li>
          <li><a href="#remediation-status-9" id="markdown-toc-remediation-status-9">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#6-gas-savings-using-unchecked-engn33r" id="markdown-toc-6-gas-savings-using-unchecked-engn33r">6. Gas savings using unchecked (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-10" id="markdown-toc-proof-of-concept-10">Proof of concept</a></li>
          <li><a href="#impact-10" id="markdown-toc-impact-10">Impact</a></li>
          <li><a href="#recommendation-10" id="markdown-toc-recommendation-10">Recommendation</a></li>
          <li><a href="#remediation-status-10" id="markdown-toc-remediation-status-10">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#7-gas-savings-with-memory-variable-engn33r" id="markdown-toc-7-gas-savings-with-memory-variable-engn33r">7. Gas savings with memory variable (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-11" id="markdown-toc-proof-of-concept-11">Proof of concept</a></li>
          <li><a href="#impact-11" id="markdown-toc-impact-11">Impact</a></li>
          <li><a href="#recommendation-11" id="markdown-toc-recommendation-11">Recommendation</a></li>
          <li><a href="#remediation-status-11" id="markdown-toc-remediation-status-11">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#8-redeemall-repeatedly-computes-index---1-nibblerexpress" id="markdown-toc-8-redeemall-repeatedly-computes-index---1-nibblerexpress">8. redeemAll repeatedly computes index - 1 (NibblerExpress)</a>        <ol>
          <li><a href="#proof-of-concept-12" id="markdown-toc-proof-of-concept-12">Proof of Concept</a></li>
          <li><a href="#impact-12" id="markdown-toc-impact-12">Impact</a></li>
          <li><a href="#recommendation-12" id="markdown-toc-recommendation-12">Recommendation</a></li>
          <li><a href="#remediation-status-12" id="markdown-toc-remediation-status-12">Remediation Status</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#informational-findings" id="markdown-toc-informational-findings">Informational Findings</a>    <ol>
      <li><a href="#1-miscellaneous-improvement-ideas-engn33r" id="markdown-toc-1-miscellaneous-improvement-ideas-engn33r">1. Miscellaneous Improvement Ideas (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-13" id="markdown-toc-proof-of-concept-13">Proof of concept</a></li>
          <li><a href="#impact-13" id="markdown-toc-impact-13">Impact</a></li>
          <li><a href="#recommendation-13" id="markdown-toc-recommendation-13">Recommendation</a></li>
          <li><a href="#remediation-status-13" id="markdown-toc-remediation-status-13">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#2-updateusermindaithreshold-assumes-dai-is-used-as-the-streamtoken-sjkelleyjr" id="markdown-toc-2-updateusermindaithreshold-assumes-dai-is-used-as-the-streamtoken-sjkelleyjr">2. updateUserMinDaiThreshold assumes Dai is used as the streamToken (sjkelleyjr)</a>        <ol>
          <li><a href="#proof-of-concept-14" id="markdown-toc-proof-of-concept-14">Proof of concept</a></li>
          <li><a href="#impact-14" id="markdown-toc-impact-14">Impact</a></li>
          <li><a href="#recommendation-14" id="markdown-toc-recommendation-14">Recommendation</a></li>
          <li><a href="#remediation-status-14" id="markdown-toc-remediation-status-14">Remediation Status</a></li>
        </ol>
      </li>
      <li><a href="#3-missing-calls-in-scriptsdeployalljs-engn33r" id="markdown-toc-3-missing-calls-in-scriptsdeployalljs-engn33r">3. Missing calls in scripts/deployAll.js (engn33r)</a>        <ol>
          <li><a href="#proof-of-concept-15" id="markdown-toc-proof-of-concept-15">Proof of concept</a></li>
          <li><a href="#impact-15" id="markdown-toc-impact-15">Impact</a></li>
          <li><a href="#recommendation-15" id="markdown-toc-recommendation-15">Recommendation</a></li>
          <li><a href="#remediation-status-15" id="markdown-toc-remediation-status-15">Remediation Status</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#final-remarks" id="markdown-toc-final-remarks">Final remarks</a>    <ol>
      <li><a href="#sjkelleyjr" id="markdown-toc-sjkelleyjr">sjkelleyjr</a></li>
      <li><a href="#engn33r" id="markdown-toc-engn33r">engn33r</a></li>
      <li><a href="#nibblerexpress" id="markdown-toc-nibblerexpress">NibblerExpress</a></li>
    </ol>
  </li>
  <li><a href="#about-yacademy" id="markdown-toc-about-yacademy">About yAcademy</a></li>
  <li><a href="#appendix-and-faq" id="markdown-toc-appendix-and-faq">Appendix and FAQ</a></li>
</ol>
      <h2 id="review-summary">
        
        
          <a href="#review-summary" class="anchor-heading" aria-labelledby="review-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Review Summary
        
        
      </h2>
    

<p><strong>Tyche/OlympusGive</strong></p>

<p>The purpose of Tyche/OlympusGive is to empower Ohm/sOHM/gOHM holders to use their OHM yield in different ways. 
This family of contracts aims to allow users to donate their yield to multiple users. The YieldStreamer contract allows sOHM or gOHM deposits, and the yield can be withdrawn in the form of a stream token (Dai is the default). In contract, the YieldDirector contract permits gOHM deposits and the gOHM rebases can be donated.</p>

<p>The main branch of the OlympusDAO <a href="https://github.com/OlympusDAO/olympus-contracts">Repo</a> was reviewed over 9 days, 3 of which were used to create an intial overview of the contract. The code review was performed between March 20 and March 28, 2022. The code was reviewed by 3 residents for a total of 43 hours (Sjkelleyjr: 17 hours, Engn33r: 16 hours, and NibblerExpress: 10 hours) man hours. The repository was under active development during the review, but the review was limited to one specific <a href="https://github.com/OlympusDAO/olympus-contracts/commit/f92425ff278b93cfc2a580299924417182da432a">commit</a>.</p>
      <h2 id="scope">
        
        
          <a href="#scope" class="anchor-heading" aria-labelledby="scope"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scope
        
        
      </h2>
    
<p><a href="https://github.com/OlympusDAO/olympus-contracts">Code Repo</a>
<a href="https://github.com/OlympusDAO/olympus-contracts/commit/f92425ff278b93cfc2a580299924417182da432a">Commit</a></p>

<p>The review was limited to the three following contracts:</p>
<ul>
  <li>YieldSplitter.sol</li>
  <li>YieldDirector.sol</li>
  <li>YieldStreamer.sol</li>
</ul>

<p>The focal point of the review was the following code modifications:</p>
<ul>
  <li>https://github.com/OlympusDAO/olympus-contracts/pull/208</li>
  <li>https://github.com/OlympusDAO/olympus-contracts/pull/186</li>
  <li>https://github.com/OlympusDAO/olympus-contracts/blob/main/contracts/types/YieldSplitter.sol</li>
</ul>

<p>The commit reviewed was f92425ff278b93cfc2a580299924417182da432a</p>

<p>After the findings were presented to the Ohm team, a review of mitigations was performed during April 5-9 based on the first three commit ot PR 288:
https://github.com/OlympusDAO/olympus-contracts/pull/288</p>

<p>The review was a time-limited review to provide rapid feedback on potential vulnerabilities.  The review was not a full audit.  The review did not explore all potential attack vectors or areas of vulnerability and may not have identified all potential issues.</p>

<p>yAcademy and the residents make no warranties regarding the security of the code and do not warrant that the code is free from defects.  yAcademy and the residents do not represent nor imply to third parties that the code has been audited nor that the code is free from defects. Olympus and third parties should use the code at their own risk.</p>
      <h2 id="code-evaluation-matrix">
        
        
          <a href="#code-evaluation-matrix" class="anchor-heading" aria-labelledby="code-evaluation-matrix"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code Evaluation Matrix
        
        
      </h2>
    

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Category</th>
      <th>Mark</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Access Control</td>
      <td>Good</td>
      <td>Modifiers such as onlyGovernor and isInvalidDeposit control conditional logic branches, while elsewhere if statements check whether the msg.sender is the depositor or recipient. Access controls are applied where needed.</td>
    </tr>
    <tr>
      <td>Mathematics</td>
      <td>Good</td>
      <td>Solidity 0.8.10 is used, which provides overflow and underflow protect. No unchecked code exists and no low-level bitwise operations are performed.</td>
    </tr>
    <tr>
      <td>Complexity</td>
      <td>Good</td>
      <td>No assembly is used and the code is clearly written and organized.</td>
    </tr>
    <tr>
      <td>Libraries</td>
      <td>Good</td>
      <td>The libraries used are from trustworthy sources. No external libraries from outside the project repository are imported.</td>
    </tr>
    <tr>
      <td>Decentralization</td>
      <td>Average</td>
      <td>The onlyGovernor modifier implies some level of centralization, although a multisig is expected to mitigate this.</td>
    </tr>
    <tr>
      <td>Code stability</td>
      <td>Average</td>
      <td>Changes were reviewed at a specific commit, additional code development occurred, but the scope was not expanded after the review was started. However, development was ongoing when the review was performed so the code was not frozen, which means deployed code may vary from what was reviewed.</td>
    </tr>
    <tr>
      <td>Documentation</td>
      <td>Average</td>
      <td>Documentation for the project exists and the code had natspec comments for nearly all functions. However, no documentation existed in the official Olympus DAO GitBook documentation and some NatSpec documentation could be made clearer with standardized terminology across contracts.</td>
    </tr>
    <tr>
      <td>Monitoring</td>
      <td>Average</td>
      <td>Events were added to most important functions that modified state variables, but not the yield withdraw or variable update functions in YieldStreamer.</td>
    </tr>
    <tr>
      <td>Testing and verification</td>
      <td>Low</td>
      <td>The findings indicate that the test coverage could be improved to better handle edge cases. Improved unit tests could enhance consistency and better check the value of all state variables after operations are performed.</td>
    </tr>
  </tbody>
</table></div>
      <h2 id="findings-explanation">
        
        
          <a href="#findings-explanation" class="anchor-heading" aria-labelledby="findings-explanation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Findings Explanation
        
        
      </h2>
    

<p>Findings are broken down into sections by their respective impact:</p>
<ul>
  <li>Critical, High, Medium, Low impact
    <ul>
      <li>These are findings that range from attacks that may cause loss of funds, impact control/ownership of the contracts, or cause any unintended consequences/actions that are outside the scope of the requirements</li>
    </ul>
  </li>
  <li>Gas savings
    <ul>
      <li>Findings that can improve the gas efficiency of the contracts</li>
    </ul>
  </li>
  <li>Informational
    <ul>
      <li>Findings including recommendations and best practices</li>
    </ul>
  </li>
</ul><hr />
      <h2 id="high-findings">
        
        
          <a href="#high-findings" class="anchor-heading" aria-labelledby="high-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> High Findings
        
        
      </h2>
    
      <h3 id="1-stakingunstake-should-set-rebasing-bool-to-true-engn33r">
        
        
          <a href="#1-stakingunstake-should-set-rebasing-bool-to-true-engn33r" class="anchor-heading" aria-labelledby="1-stakingunstake-should-set-rebasing-bool-to-true-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. staking.unstake() should set rebasing bool to true (engn33r)
        
        
      </h3>
    

<p>The YieldStreamer contract passes an incorrect parameter to <code class="language-plaintext highlighter-rouge">staking.unstake()</code>.</p>
      <h4 id="proof-of-concept">
        
        
          <a href="#proof-of-concept" class="anchor-heading" aria-labelledby="proof-of-concept"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The steps that the YieldStreamer functions take to withdraw yield to stream tokens occur in this order</p>
<ol>
  <li>Calculate yield in gOHM</li>
  <li>Unwrap gOHM to sOHM</li>
  <li>Unstake sOHM to OHM</li>
  <li>Convert OHM to stream token</li>
</ol>

<p>The problem is in step 3. The rebasing bool is set to false, which will cause the staking contract to take gOHM from msg.sender instead of taking sOHM as the YieldStreamer contract requires. The logic for the rebasing boolean in the staking contract is</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (_rebasing) {
    sOHM.safeTransferFrom(msg.sender, address(this), _amount);
    amount_ = amount_.add(bounty);
} else {
    gOHM.burn(msg.sender, _amount); // amount was given in gOHM terms
    amount_ = gOHM.balanceFrom(amount_).add(bounty); // convert amount to OHM terms &amp; add bounty
}
</code></pre></div></div>

<p>In order to convert sOHM to OHM in the <code class="language-plaintext highlighter-rouge">staking.unstake()</code> function, which is required in step 3 of the steps outlined above, the rebasing parameter must be set to true. Otherwise gOHM will be converted instead.
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/Staking.sol#L181</p>

<p>Currently the rebasing boolean value is set to false in two locations
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L246
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L322</p>
      <h4 id="impact">
        
        
          <a href="#impact" class="anchor-heading" aria-labelledby="impact"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High, currently gOHM will be subtracted from the YieldStreamer contract twice while sOHM will sit in YieldStreamer unused.</p>
      <h4 id="recommendation">
        
        
          <a href="#recommendation" class="anchor-heading" aria-labelledby="recommendation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Change the rebasing input parameter to true, not false</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>staking.unstake(address(this), totalOhmToSwap, false, true);
</code></pre></div></div>
      <h4 id="remediation-status">
        
        
          <a href="#remediation-status" class="anchor-heading" aria-labelledby="remediation-status"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>The functions relying on <code class="language-plaintext highlighter-rouge">staking.unstake()</code> have been changed so that this is no longer an issue. Notably, the complex <code class="language-plaintext highlighter-rouge">withdrawYieldInStreamTokens()</code> function has been removed. A new observation was that comments still exist in YieldStreamer.sol that reference withdrawYieldInStreamTokens even though the function has been removed. Only one instance of the <code class="language-plaintext highlighter-rouge">staking.unstake()</code> function call remains, in the <code class="language-plaintext highlighter-rouge">upkeep()</code> function, where the token conversion process has been simplified so that the original issue is no longer valid.</p>
      <h3 id="2-sandwich-attack-risk-in-yieldstreamersol-engn33r">
        
        
          <a href="#2-sandwich-attack-risk-in-yieldstreamersol-engn33r" class="anchor-heading" aria-labelledby="2-sandwich-attack-risk-in-yieldstreamersol-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Sandwich attack risk in YieldStreamer.sol (engn33r)
        
        
      </h3>
    

<p>YieldStreamer.sol needs to swap Ohm for the streaming token. To do this, the swapExactTokensForTokens function from Sushiswap is used. The swapExactTokensForTokens requires a amountOutMin value be set to reduce slippage and prevent sandwich attacks. In the YieldStreamer.sol contract, the amountOutMin value that is set is equivalent to not setting a minimum amountOutMin. This make the swap sandwichable. Even if a private relay like flashbots is used to mitigate the sandwich attack risk, <a href="https://medium.com/alchemy-api/unmasking-the-ethereum-uncle-bandit-a2b3eb694019">an uncle bandit attack</a> is still a risk to this operation.</p>
      <h4 id="proof-of-concept-1">
        
        
          <a href="#proof-of-concept-1" class="anchor-heading" aria-labelledby="proof-of-concept-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>This code is how the swap is performed in YieldStreamer.sol in two locations:
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L248-L255
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L324-L331</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uint256[] memory calculatedAmounts = sushiRouter.getAmountsOut(totalOhmToSwap, sushiRouterPath);
uint256[] memory amounts = sushiRouter.swapExactTokensForTokens(
    totalOhmToSwap,
    (calculatedAmounts[1] * (1000000 - maxSwapSlippagePercent)) / 1000000,
    sushiRouterPath,
    msg.sender,
    block.timestamp
);
</code></pre></div></div>

<p>The amountOutMin value is the output of <code class="language-plaintext highlighter-rouge">getAmountsOut(totalOhmToSwap, sushiRouterPath)</code> minus some slippage percent maxSwapSlippagePercent. Examining the code of the <code class="language-plaintext highlighter-rouge">swapExactTokensForTokens()</code> function, we can see how amountOutMin is used. There is a check to confirm the result of the exchange is greater than the amountOutMin
https://github.com/sushiswap/sushiswap/blob/56cedd0e06a6cf665083b3a662f9f77b80303ebe/contracts/uniswapv2/UniswapV2Router02.sol#L233</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amounts = UniswapV2Library.getAmountsOut(factory, amountIn, path);
require(amounts[amounts.length - 1] &gt;= amountOutMin, 'UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT');
</code></pre></div></div>

<p>But because the <code class="language-plaintext highlighter-rouge">swapExactTokensForTokens()</code> function is using the exact same <code class="language-plaintext highlighter-rouge">getAmountsOut()</code> function that was used in YieldStreamer.sol to calculate amountOutMin and is calculated in the same transaction, the result is that the two <code class="language-plaintext highlighter-rouge">getAmountsOut()</code> output values will always be equal. So the amountOutMin set in YieldStreamer.sol serves no purpose because it can never yield a result where the amountOutMin value reverts the swap, because amountOutMin is <code class="language-plaintext highlighter-rouge">getAmountsOut()</code> minus some slippage, which will always be less than or equal to <code class="language-plaintext highlighter-rouge">getAmountsOut()</code>. The current calculation to provide an amountOutMin value is a waste of gas.</p>

<p>Even in a scenario where a private relay is used, miners cannot guarantee that a block will not become an uncle block. If the block is uncled, the mempool data becomes public and an uncle bandit attack is possible.</p>
      <h4 id="impact-1">
        
        
          <a href="#impact-1" class="anchor-heading" aria-labelledby="impact-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>High, sandwich attack is expected if the liquidity pool has low liquidity relative to a flash loan or whale</p>
      <h4 id="recommendation-1">
        
        
          <a href="#recommendation-1" class="anchor-heading" aria-labelledby="recommendation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>A comment in the PR discussing the sandwich attack risk indicates that a private relay may be necessary
https://github.com/OlympusDAO/olympus-contracts/pull/186#discussion_r789334631</p>

<p>If no private relay is used, an external oracle should be used instead of relying on the DEX liquidity pool spot price. <a href="https://data.chain.link/ethereum/mainnet">Chainlink</a> has several OHM price feeds.
https://shouldiusespotpriceasmyoracle.com/</p>

<p>An additional improvement for the <code class="language-plaintext highlighter-rouge">withdrawYieldInStreamTokens()</code> function is to add a user-specified minAmountOut input parameter. Because a check exists in <code class="language-plaintext highlighter-rouge">withdrawYieldInStreamTokens()</code> requiring <code class="language-plaintext highlighter-rouge">recipientInfo[id_].recipientAddress == msg.sender</code>, the function caller is the intended recipient and therefore can be trusted to set a slippage value of their choice. To make this even easier for a user, a view function can be created that calculates this input amount to pass as the minAmountOut input parameter. This improvement would not work for <code class="language-plaintext highlighter-rouge">upkeep()</code> because it can be called by anyone and the caller cannot be trusted to set a safe slippage value.</p>
      <h4 id="remediation-status-1">
        
        
          <a href="#remediation-status-1" class="anchor-heading" aria-labelledby="remediation-status-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This issue has not been remediated at the time of report completion. An additional concern was added about the possibility of swaps that happen earlier in the activeDepositIds array receiving better swap rates than those later in the array.</p>
      <h2 id="medium-findings">
        
        
          <a href="#medium-findings" class="anchor-heading" aria-labelledby="medium-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Medium Findings
        
        
      </h2>
    
      <h3 id="1-denial-of-service-in-upkeep-for-loop-in-yieldstreamersol-sjkelleyjr">
        
        
          <a href="#1-denial-of-service-in-upkeep-for-loop-in-yieldstreamersol-sjkelleyjr" class="anchor-heading" aria-labelledby="1-denial-of-service-in-upkeep-for-loop-in-yieldstreamersol-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Denial of service in upkeep “for” loop in YieldStreamer.sol (sjkelleyjr)
        
        
      </h3>
    

<p>If <code class="language-plaintext highlighter-rouge">upkeep()</code> is not run frequently enough, or if the upkeep eligibility of many depositors synchronize, the two for loops in the <code class="language-plaintext highlighter-rouge">upkeep()</code> function may run out of gas, preventing anyone from running this function until (or if) Ethereum mainnet gas limits are increased. There is no backup function in YieldStreamer.sol that allows for upkeep to be run on individual positions, which would provide a solution if it is not possible to upkeep all eligible positions.</p>

<p>This function can be attacked by a user who wants to perform a denial of service. A user can create many deposits with a paymentInterval of 1 second. All of these payments will be upkeep eligible, increasing the amount of gas that the upkeep caller must spend. This attack can bring the gas usage of <code class="language-plaintext highlighter-rouge">upkeep()</code>  over the current 30,000,000 mainnet gas limit. The upkeep function is a critical piece of YieldStreamer.sol, and if it is unavailable the contract will cease to be useful, requiring individuals to withdraw their assets and the Ohm team to redeploy an upgraded contract without this weakness.</p>
      <h4 id="proof-of-concept-2">
        
        
          <a href="#proof-of-concept-2" class="anchor-heading" aria-labelledby="proof-of-concept-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Based on the current gas limit of 30 million, a malicious user Mallory could cause this denial of service with a few thousand deposits</p>
<ol>
  <li>Mallory calls <code class="language-plaintext highlighter-rouge">deposit()</code> in YieldStreamer.sol a few thousand times with small deposits that are equal to or greater than the value of minimumTokenThreshold. This causes the length of activeDepositIds to increase. When making these deposits, Mallory sets the paymentInterval to a very short amount of time and the userMinimumAmountThreshold to a very small value.</li>
  <li>Mallory, or any user, will call <code class="language-plaintext highlighter-rouge">upkeep()</code> at a later time. Because <code class="language-plaintext highlighter-rouge">_isUpkeepEligible(currentId)</code> will return true for all of Mallory’s deposits, which number in the thousands, the <code class="language-plaintext highlighter-rouge">upkeep()</code> function will revert when it runs out of gas. The <code class="language-plaintext highlighter-rouge">upkeep()</code> function will be unusable, meaning users will not receive their stream tokens on schedule. All users will need to withdraw their deposits to receive the stream tokens.</li>
</ol>
      <h4 id="impact-2">
        
        
          <a href="#impact-2" class="anchor-heading" aria-labelledby="impact-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Medium, contract out of gas causing denial of service</p>
      <h4 id="recommendation-2">
        
        
          <a href="#recommendation-2" class="anchor-heading" aria-labelledby="recommendation-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Add a function to upkeep individual deposits instead of only maintaining a single function to upkeep all deposits.</p>
      <h4 id="remediation-status-2">
        
        
          <a href="#remediation-status-2" class="anchor-heading" aria-labelledby="remediation-status-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This issue has not been remediated at the time of report completion. One recommendation for the <code class="language-plaintext highlighter-rouge">upkeep()</code> denial of service was to add a function to upkeep individual deposits, but if the <code class="language-plaintext highlighter-rouge">redeemYieldOnBehalfOf()</code> function is intended to serve this purpose, it needs to add the line <code class="language-plaintext highlighter-rouge">currentrecipientInfo.lastUpkeepTimestamp = uint128(block.timestamp);</code> so that this deposit is not looped through on the next <code class="language-plaintext highlighter-rouge">upkeep()</code> call.</p>
      <h2 id="low-findings">
        
        
          <a href="#low-findings" class="anchor-heading" aria-labelledby="low-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Low Findings
        
        
      </h2>
    
      <h3 id="1-donatedto-and-depositsto-only-return-the-first-of-n-possible-donation-or-deposit-mappings-sjkelleyjr">
        
        
          <a href="#1-donatedto-and-depositsto-only-return-the-first-of-n-possible-donation-or-deposit-mappings-sjkelleyjr" class="anchor-heading" aria-labelledby="1-donatedto-and-depositsto-only-return-the-first-of-n-possible-donation-or-deposit-mappings-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. <code class="language-plaintext highlighter-rouge">donatedTo</code> and <code class="language-plaintext highlighter-rouge">depositsTo</code> only return the first of N possible donation or deposit mappings (sjkelleyjr)
        
        
      </h3>
    

<p>There can be multiple depositInfo mappings for a given donor or multiple recipientLookup mappings for a given donor to recipient.</p>
      <h4 id="proof-of-concept-3">
        
        
          <a href="#proof-of-concept-3" class="anchor-heading" aria-labelledby="proof-of-concept-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>https://github.com/OlympusDAO/olympus-contracts/blob/main/contracts/peripheral/YieldDirector.sol#L195</p>

<p>https://github.com/OlympusDAO/olympus-contracts/blob/main/contracts/peripheral/YieldDirector.sol#L256</p>
      <h4 id="impact-3">
        
        
          <a href="#impact-3" class="anchor-heading" aria-labelledby="impact-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low, the view functions may return incorrect values.</p>
      <h4 id="recommendation-3">
        
        
          <a href="#recommendation-3" class="anchor-heading" aria-labelledby="recommendation-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Return a sum of the total mappings as is done in the other view functions, or ensure the same mapping between donor and recipient can only be created one time when <a href="https://github.com/OlympusDAO/olympus-contracts/blob/main/contracts/peripheral/YieldDirector.sol#L92">deposit</a> is called.</p>
      <h4 id="remediation-status-3">
        
        
          <a href="#remediation-status-3" class="anchor-heading" aria-labelledby="remediation-status-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="2-_redeemall-does-not-delete-recipientlookup-sjkelleyjr">
        
        
          <a href="#2-_redeemall-does-not-delete-recipientlookup-sjkelleyjr" class="anchor-heading" aria-labelledby="2-_redeemall-does-not-delete-recipientlookup-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. <code class="language-plaintext highlighter-rouge">_redeemAll()</code> does not delete recipientLookup (sjkelleyjr)
        
        
      </h3>
    

<p>In YieldDirector.sol, the two mappings recipientIds and recipientLookup allow for recipient -&gt; depositId and depositId -&gt; recipient lookups respectively. The two mappings must be modified at the same time and in the same way to maintain relevance. For example, in the <code class="language-plaintext highlighter-rouge">_redeem()</code> function, when the principalAmount of a deposit is zero, the function calls <code class="language-plaintext highlighter-rouge">receiptIds.pop();</code> and <code class="language-plaintext highlighter-rouge">delete recipientLookup[depositId_]</code> to remove this depositId from the mappings. But in the related <code class="language-plaintext highlighter-rouge">_redeemAll()</code> function, there is no deletion of the <code class="language-plaintext highlighter-rouge">recipientLookup[depositId_]</code> value. This can result in the recipientLookup mapping storing unnecessary data. This is mostly a gas savings issue, but the extra data in the array may lead to an edge case logic error, though none was identified.</p>
      <h4 id="proof-of-concept-4">
        
        
          <a href="#proof-of-concept-4" class="anchor-heading" aria-labelledby="proof-of-concept-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>In the <code class="language-plaintext highlighter-rouge">_redeem()</code> function, <code class="language-plaintext highlighter-rouge">receiptIds.pop();</code> and <code class="language-plaintext highlighter-rouge">delete recipientLookup[depositId_]</code> are called
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L429-L455</p>

<p>But in the similar <code class="language-plaintext highlighter-rouge">_redeemAll()</code> function, there is no <code class="language-plaintext highlighter-rouge">delete recipientLookup[depositId_];</code> call.
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L460-L488</p>
      <h4 id="impact-4">
        
        
          <a href="#impact-4" class="anchor-heading" aria-labelledby="impact-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Low, the recipientLookup mapping will still contain depositId -&gt; recipient mappings even if this is zero principal, but no direct security vulnerability from this data was found.</p>
      <h4 id="recommendation-4">
        
        
          <a href="#recommendation-4" class="anchor-heading" aria-labelledby="recommendation-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Modify the line of code that calls <code class="language-plaintext highlighter-rouge">receiptIds.pop();</code> in <code class="language-plaintext highlighter-rouge">_redeemAll()</code> to the following:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>delete recipientLookup[receiptIds[index - 1]];
receiptIds.pop();
</code></pre></div></div>
      <h4 id="remediation-status-4">
        
        
          <a href="#remediation-status-4" class="anchor-heading" aria-labelledby="remediation-status-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h2 id="gas-savings-findings">
        
        
          <a href="#gas-savings-findings" class="anchor-heading" aria-labelledby="gas-savings-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gas Savings Findings
        
        
      </h2>
    
      <h3 id="1-declare-function-external-for-gas-savings-sjkelleyjr">
        
        
          <a href="#1-declare-function-external-for-gas-savings-sjkelleyjr" class="anchor-heading" aria-labelledby="1-declare-function-external-for-gas-savings-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Declare function external for gas savings (sjkelleyjr)
        
        
      </h3>
    

<p>The totalRedeemableBalance function of YieldDirector.sol should be declared external, not public, for gas savings.</p>
      <h4 id="proof-of-concept-5">
        
        
          <a href="#proof-of-concept-5" class="anchor-heading" aria-labelledby="proof-of-concept-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L315</p>
      <h4 id="impact-5">
        
        
          <a href="#impact-5" class="anchor-heading" aria-labelledby="impact-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-5">
        
        
          <a href="#recommendation-5" class="anchor-heading" aria-labelledby="recommendation-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Declare totalRedeemableBalance as an external function, not a public function</p>
      <h4 id="remediation-status-5">
        
        
          <a href="#remediation-status-5" class="anchor-heading" aria-labelledby="remediation-status-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="2-use--for-gas-savings-sjkelleyjr">
        
        
          <a href="#2-use--for-gas-savings-sjkelleyjr" class="anchor-heading" aria-labelledby="2-use--for-gas-savings-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Use == for gas savings (sjkelleyjr)
        
        
      </h3>
    

<p>The three modifiers of YieldDirector.sol use a check for <code class="language-plaintext highlighter-rouge">amount &lt;= 0</code>, but the check can be changed to <code class="language-plaintext highlighter-rouge">amount == 0</code> for gas savings.</p>

<p>There’s another related gas optimization. the if/else statement in the <code class="language-plaintext highlighter-rouge">_withdraw()</code> function of YieldDirector.sol can replace ≥ with &lt; if the if/else clauses are switched around.
The same gas optimization can be used in the if/else statement of the <code class="language-plaintext highlighter-rouge">withdrawPrincipal()</code> function in YieldStreamer.sol.</p>
      <h4 id="proof-of-concept-6">
        
        
          <a href="#proof-of-concept-6" class="anchor-heading" aria-labelledby="proof-of-concept-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>&lt;= is used instead of == in three modifiers
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L71-L81</p>

<p>&gt;= can be simplified to &lt; by flipping the if/else clauses in two locations
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L415
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L163</p>

<p>An example of flipping the if/else clauses is shown. Here is the original code:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (amount_ &gt;= _toAgnostic(depositInfo[depositId_].principalAmount)) {
    amountWithdrawn = _withdrawAllPrincipal(depositId_, msg.sender);
} else {
    _withdrawPrincipal(depositId_, amount_, msg.sender);
    amountWithdrawn = amount_;
}
</code></pre></div></div>

<p>And here is the modified code with a minor gas savings. This specific gas savings may be negated if the <code class="language-plaintext highlighter-rouge">_withdrawAllPrincipal</code> clause is used most of the time:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (amount_ &lt; _toAgnostic(depositInfo[depositId_].principalAmount)) {
    _withdrawPrincipal(depositId_, amount_, msg.sender);
    amountWithdrawn = amount_;
} else {
    amountWithdrawn = _withdrawAllPrincipal(depositId_, msg.sender);
}
</code></pre></div></div>
      <h4 id="impact-6">
        
        
          <a href="#impact-6" class="anchor-heading" aria-labelledby="impact-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-6">
        
        
          <a href="#recommendation-6" class="anchor-heading" aria-labelledby="recommendation-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use ==, &lt;, or &gt; instead of ≤ or ≥ whenever possible for gas savings</p>
      <h4 id="remediation-status-6">
        
        
          <a href="#remediation-status-6" class="anchor-heading" aria-labelledby="remediation-status-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="3-simplify-math-for-gas-savings-engn33r">
        
        
          <a href="#3-simplify-math-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="3-simplify-math-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Simplify math for gas savings (engn33r)
        
        
      </h3>
    

<p>Line 128 and 129 of YieldSplitter.sol reads</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amountRedeemed = _getOutstandingYield(userDeposit.principalAmount, userDeposit.agnosticAmount);
userDeposit.agnosticAmount = _toAgnostic(userDeposit.principalAmount);
</code></pre></div></div>

<p>Instead of calling <code class="language-plaintext highlighter-rouge">_toAgnostic()</code>, this can be simplified to save gas with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amountRedeemed = _getOutstandingYield(userDeposit.principalAmount, userDeposit.agnosticAmount);
userDeposit.agnosticAmount = userDeposit.agnosticAmount - amountRedeemed;
</code></pre></div></div>
      <h4 id="proof-of-concept-7">
        
        
          <a href="#proof-of-concept-7" class="anchor-heading" aria-labelledby="proof-of-concept-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/types/YieldSplitter.sol#L129</p>
      <h4 id="impact-7">
        
        
          <a href="#impact-7" class="anchor-heading" aria-labelledby="impact-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-7">
        
        
          <a href="#recommendation-7" class="anchor-heading" aria-labelledby="recommendation-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Simplify math for gas savings</p>
      <h4 id="remediation-status-7">
        
        
          <a href="#remediation-status-7" class="anchor-heading" aria-labelledby="remediation-status-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="4-use-msgsender-for-gas-savings-engn33r">
        
        
          <a href="#4-use-msgsender-for-gas-savings-engn33r" class="anchor-heading" aria-labelledby="4-use-msgsender-for-gas-savings-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Use msg.sender for gas savings (engn33r)
        
        
      </h3>
    

<p>NOTE: engn33r is unsure whether this is a gas savings, but Paul thinks it is: https://github.com/OlympusDAO/olympus-contracts/pull/186#discussion_r816492541</p>

<p>The emit call in the <code class="language-plaintext highlighter-rouge">_increaseDeposit()</code> function of YieldDirector.sol should use msg.sender instead of depositInfo[depositId_].depositor. <code class="language-plaintext highlighter-rouge">_addToDeposit()</code> is called in <code class="language-plaintext highlighter-rouge">_increaseDeposit()</code>, and <code class="language-plaintext highlighter-rouge">_addToDeposit()</code> performs a check to confirm <code class="language-plaintext highlighter-rouge">depositInfo[id_].depositor == msg.sender</code>. This is already done in the <code class="language-plaintext highlighter-rouge">_withdraw()</code> function of YieldDirector.sol.</p>
      <h4 id="proof-of-concept-8">
        
        
          <a href="#proof-of-concept-8" class="anchor-heading" aria-labelledby="proof-of-concept-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L404</p>
      <h4 id="impact-8">
        
        
          <a href="#impact-8" class="anchor-heading" aria-labelledby="impact-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-8">
        
        
          <a href="#recommendation-8" class="anchor-heading" aria-labelledby="recommendation-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use msg.sender for gas savings</p>
      <h4 id="remediation-status-8">
        
        
          <a href="#remediation-status-8" class="anchor-heading" aria-labelledby="remediation-status-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="5-remove-functions-to-save-gas-on-deployment-engn33r">
        
        
          <a href="#5-remove-functions-to-save-gas-on-deployment-engn33r" class="anchor-heading" aria-labelledby="5-remove-functions-to-save-gas-on-deployment-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Remove functions to save gas on deployment (engn33r)
        
        
      </h3>
    

<p>The <code class="language-plaintext highlighter-rouge">_toAgnostic()</code> and <code class="language-plaintext highlighter-rouge">_fromAgnostic()</code> functions of YieldSplitter.sol duplicate the <code class="language-plaintext highlighter-rouge">balanceFrom()</code> and <code class="language-plaintext highlighter-rouge">balanceTo()</code> of gOHM.sol. Since the gOHM address is known to YieldStreamer.sol and YieldDirector.sol, the <code class="language-plaintext highlighter-rouge">_toAgnostic()</code> and <code class="language-plaintext highlighter-rouge">_fromAgnostic()</code> functions could be remove to reuse the gOHM functions. This is already done in <code class="language-plaintext highlighter-rouge">withdrawPrincipal()</code> of YieldStreamer.sol
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L163
Compare to the equivalent line in YieldDirector.sol
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L415</p>

<p>A similar function named <code class="language-plaintext highlighter-rouge">getPrincipalInGOHM()</code> in YieldStreamer.sol acts as a wrapper for gOHM.balanceTo(). It is unclear whether this function is necessary of if it can be removed. If it is necessary, it may be useful to add a complementary function <code class="language-plaintext highlighter-rouge">getAgnosticInSOHM()</code>.</p>

<p>Less new code = lower complexity + deployment gas savings</p>
      <h4 id="proof-of-concept-9">
        
        
          <a href="#proof-of-concept-9" class="anchor-heading" aria-labelledby="proof-of-concept-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>balanceTo and balanceFrom in gOHM.sol convert between sOHM and gOHM using the current index exchange rate
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/governance/gOHM.sol#L111-L127</p>

<p>The YieldSplitter.sol functions _fromAgnostic and _toAgnostic duplicate this functionality
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/types/YieldSplitter.sol#L170-L186</p>
      <h4 id="impact-9">
        
        
          <a href="#impact-9" class="anchor-heading" aria-labelledby="impact-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-9">
        
        
          <a href="#recommendation-9" class="anchor-heading" aria-labelledby="recommendation-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use existing functions instead of duplicating them</p>
      <h4 id="remediation-status-9">
        
        
          <a href="#remediation-status-9" class="anchor-heading" aria-labelledby="remediation-status-9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was acknowledged but not resolved, because there may be cases where the <code class="language-plaintext highlighter-rouge">_toAgnostic()</code> and <code class="language-plaintext highlighter-rouge">_fromAgnostic()</code> functions are useful in contracts that do not import the gOHM.sol contract. Gas findings are optional and do not pose a security concern.</p>
      <h3 id="6-gas-savings-using-unchecked-engn33r">
        
        
          <a href="#6-gas-savings-using-unchecked-engn33r" class="anchor-heading" aria-labelledby="6-gas-savings-using-unchecked-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Gas savings using unchecked (engn33r)
        
        
      </h3>
    

<p>We know <code class="language-plaintext highlighter-rouge">agnosticAmount &gt;= _toAgnostic(principal)</code> because agnosticAmount includes some yield from rebasing. This assumption can allow some math to use the “unchecked” clause for gas savings. One such place is <code class="language-plaintext highlighter-rouge">_getOutstandingYield</code> of YieldSplitter.sol.</p>
      <h4 id="proof-of-concept-10">
        
        
          <a href="#proof-of-concept-10" class="anchor-heading" aria-labelledby="proof-of-concept-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/types/YieldSplitter.sol#L167</p>
      <h4 id="impact-10">
        
        
          <a href="#impact-10" class="anchor-heading" aria-labelledby="impact-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-10">
        
        
          <a href="#recommendation-10" class="anchor-heading" aria-labelledby="recommendation-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Use unchecked where there is no overflow or underflow risk</p>
      <h4 id="remediation-status-10">
        
        
          <a href="#remediation-status-10" class="anchor-heading" aria-labelledby="remediation-status-10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation. It was suggested that comments explaining why each unchecked cannot overflow or undeflow may be useful documentation.</p>
      <h3 id="7-gas-savings-with-memory-variable-engn33r">
        
        
          <a href="#7-gas-savings-with-memory-variable-engn33r" class="anchor-heading" aria-labelledby="7-gas-savings-with-memory-variable-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Gas savings with memory variable (engn33r)
        
        
      </h3>
    

<p>Instead of looking up a state variable twice, a gas savings can be achieved by creating a local copy. This optimization was found in two locations.</p>
      <h4 id="proof-of-concept-11">
        
        
          <a href="#proof-of-concept-11" class="anchor-heading" aria-labelledby="proof-of-concept-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>The <code class="language-plaintext highlighter-rouge">_closeDeposit()</code> function in YieldSplitter.sol uses the value “depositInfo[id_].depositor” twice
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/types/YieldSplitter.sol#L144</p>

<p>The <code class="language-plaintext highlighter-rouge">_redeemAll()</code> in YieldDirector.sol function uses the value “depositInfo[receiptIds[index - 1]].depositor” twice
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L460</p>
      <h4 id="impact-11">
        
        
          <a href="#impact-11" class="anchor-heading" aria-labelledby="impact-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Gas savings</p>
      <h4 id="recommendation-11">
        
        
          <a href="#recommendation-11" class="anchor-heading" aria-labelledby="recommendation-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Store the value in a local memory variable to save gas on storage loads. Here is an example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>address depositorAddressToClose = depositInfo[id_].depositor;
if (depositorAddressToClose != depositorAddress) revert YieldSplitter_NotYourDeposit();
</code></pre></div></div>
      <h4 id="remediation-status-11">
        
        
          <a href="#remediation-status-11" class="anchor-heading" aria-labelledby="remediation-status-11"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="8-redeemall-repeatedly-computes-index---1-nibblerexpress">
        
        
          <a href="#8-redeemall-repeatedly-computes-index---1-nibblerexpress" class="anchor-heading" aria-labelledby="8-redeemall-repeatedly-computes-index---1-nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. redeemAll repeatedly computes index - 1 (NibblerExpress)
        
        
      </h3>
    
<p>index - 1 is computed six times in the redeemAll function. Gas could be saved by computing it once and storing in memory.</p>
      <h4 id="proof-of-concept-12">
        
        
          <a href="#proof-of-concept-12" class="anchor-heading" aria-labelledby="proof-of-concept-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of Concept
        
        
      </h4>
    
<p>See lines 471-480 of Yield Director: https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldDirector.sol#L471</p>
      <h4 id="impact-12">
        
        
          <a href="#impact-12" class="anchor-heading" aria-labelledby="impact-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    
<p>Gas savings</p>
      <h4 id="recommendation-12">
        
        
          <a href="#recommendation-12" class="anchor-heading" aria-labelledby="recommendation-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    
<p>One option is to compute and store index - 1 and use that value rather than recomputing index - 1 repeatedly. The alternate option would be to start the loop at length - 1 and check that index &gt;= 0.</p>
      <h4 id="remediation-status-12">
        
        
          <a href="#remediation-status-12" class="anchor-heading" aria-labelledby="remediation-status-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h2 id="informational-findings">
        
        
          <a href="#informational-findings" class="anchor-heading" aria-labelledby="informational-findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Informational Findings
        
        
      </h2>
    
      <h3 id="1-miscellaneous-improvement-ideas-engn33r">
        
        
          <a href="#1-miscellaneous-improvement-ideas-engn33r" class="anchor-heading" aria-labelledby="1-miscellaneous-improvement-ideas-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Miscellaneous Improvement Ideas (engn33r)
        
        
      </h3>
    

<p>There is significant overlap between YieldDirector.sol and YieldStreamer.sol, but similar functions are implemented differently. Standardizing as much as possible would be ideal for the long term management of the code.</p>

<p>Seperately, constant variables should be used in place of magic numbers to prevent typos. The magic number 1e6 is found in multiple places in YieldStreamer.sol and should be replaced with a constant.</p>
      <h4 id="proof-of-concept-13">
        
        
          <a href="#proof-of-concept-13" class="anchor-heading" aria-labelledby="proof-of-concept-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Examples of overlap between YieldDirector.sol and YieldStreamer.sol include:</p>
<ul>
  <li>YieldDirector.sol has modifiers isInvalidDeposit, isInvalidUpdate, and isInvalidWithdrawal, but YieldStreamer.sol only checks the boolean value depositDisabled, withdrawDisabled, or upkeepDisabled. YieldStreamer.sol may benefit from the same modifiers used in YieldDirector.sol.</li>
  <li>Functions like <code class="language-plaintext highlighter-rouge">desposit()</code> and <code class="language-plaintext highlighter-rouge">addToDeposit()</code> perform almost identical actions but have different names for input parameters and different natspec comments. These could be standardized better across the two contracts.</li>
</ul>

<p>Examples of magic numbers that should be converted to constant variables are found in several places:
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L436
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L445
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L251
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L318
https://github.com/OlympusDAO/olympus-contracts/blob/f92425ff278b93cfc2a580299924417182da432a/contracts/peripheral/YieldStreamer.sol#L327</p>
      <h4 id="impact-13">
        
        
          <a href="#impact-13" class="anchor-heading" aria-labelledby="impact-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    
<p>Informational</p>
      <h4 id="recommendation-13">
        
        
          <a href="#recommendation-13" class="anchor-heading" aria-labelledby="recommendation-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<ol>
  <li>Reuse code as much as possible between YieldDirector.sol and YieldStreamer.sol to reduce overall complexity</li>
  <li>Replace magic numbers with constant variables to prevent typos in numeric calculations</li>
</ol>
      <h4 id="remediation-status-13">
        
        
          <a href="#remediation-status-13" class="anchor-heading" aria-labelledby="remediation-status-13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="2-updateusermindaithreshold-assumes-dai-is-used-as-the-streamtoken-sjkelleyjr">
        
        
          <a href="#2-updateusermindaithreshold-assumes-dai-is-used-as-the-streamtoken-sjkelleyjr" class="anchor-heading" aria-labelledby="2-updateusermindaithreshold-assumes-dai-is-used-as-the-streamtoken-sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. updateUserMinDaiThreshold assumes Dai is used as the streamToken (sjkelleyjr)
        
        
      </h3>
    
      <h4 id="proof-of-concept-14">
        
        
          <a href="#proof-of-concept-14" class="anchor-heading" aria-labelledby="proof-of-concept-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    
<p>https://github.com/OlympusDAO/olympus-contracts/blob/main/contracts/peripheral/YieldStreamer.sol#L280</p>
      <h4 id="impact-14">
        
        
          <a href="#impact-14" class="anchor-heading" aria-labelledby="impact-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    
<p>None, readability improvement.</p>
      <h4 id="recommendation-14">
        
        
          <a href="#recommendation-14" class="anchor-heading" aria-labelledby="recommendation-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    
<p>Rename the function to updateUserMinStreamTokenThreshold.</p>
      <h4 id="remediation-status-14">
        
        
          <a href="#remediation-status-14" class="anchor-heading" aria-labelledby="remediation-status-14"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was successfully resolved using the provided recommendation.</p>
      <h3 id="3-missing-calls-in-scriptsdeployalljs-engn33r">
        
        
          <a href="#3-missing-calls-in-scriptsdeployalljs-engn33r" class="anchor-heading" aria-labelledby="3-missing-calls-in-scriptsdeployalljs-engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Missing calls in scripts/deployAll.js (engn33r)
        
        
      </h3>
    

<p>The deployAll.js script currently fails because the timelock is disabled, which leads to the calls to <code class="language-plaintext highlighter-rouge">olympusTreasury.queueTimelock()</code> failing.</p>

<p>The deployAll.js script is missing calls to deploy YieldStreamer.sol and YieldSplitter.sol.</p>
      <h4 id="proof-of-concept-15">
        
        
          <a href="#proof-of-concept-15" class="anchor-heading" aria-labelledby="proof-of-concept-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proof of concept
        
        
      </h4>
    

<p>Start ganache and run <code class="language-plaintext highlighter-rouge">npx hardhat run --network localhost scripts/deployAll.js</code> . Observe the error message stating <code class="language-plaintext highlighter-rouge">revert Timelock is disabled, use enable</code>.</p>

<p>To fix, add the line <code class="language-plaintext highlighter-rouge">await olympusTreasury.initialize();</code> before the calls to <code class="language-plaintext highlighter-rouge">olympusTreasury.queueTimelock()</code> and observe the above hardhat work.</p>
      <h4 id="impact-15">
        
        
          <a href="#impact-15" class="anchor-heading" aria-labelledby="impact-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Impact
        
        
      </h4>
    

<p>Informational</p>
      <h4 id="recommendation-15">
        
        
          <a href="#recommendation-15" class="anchor-heading" aria-labelledby="recommendation-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Recommendation
        
        
      </h4>
    

<p>Update the deployAll.js script</p>
      <h4 id="remediation-status-15">
        
        
          <a href="#remediation-status-15" class="anchor-heading" aria-labelledby="remediation-status-15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remediation Status
        
        
      </h4>
    

<p>This finding was not resolved at the time of report completion, but does not pose any security concerns.</p>
      <h2 id="final-remarks">
        
        
          <a href="#final-remarks" class="anchor-heading" aria-labelledby="final-remarks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Final remarks
        
        
      </h2>
    
      <h3 id="sjkelleyjr">
        
        
          <a href="#sjkelleyjr" class="anchor-heading" aria-labelledby="sjkelleyjr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> sjkelleyjr
        
        
      </h3>
    
<p>In general the code doesn’t appear to contain any critical vulnerabilities that would result in the loss of user funds.  My primary concern is around the high gas usage of the <code class="language-plaintext highlighter-rouge">upkeep</code> function and the easy with which a nefarious user could DDOS this function.</p>
      <h3 id="engn33r">
        
        
          <a href="#engn33r" class="anchor-heading" aria-labelledby="engn33r"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> engn33r
        
        
      </h3>
    

<p>Overall the code looks quite solid. I was expecting to see a mixup between gOHM and sOHM conversion somewhere, but the math appears to be handled properly. The gas usage of the upkeep function, where one user pays for the gas of many user’s deposits, could be problematic because the user calling <code class="language-plaintext highlighter-rouge">upkeep</code> cannot control these other deposits. Additionally, there is one comment that streamToken may include tokens other than Dai. The code currently may not handle all edge cases for deflationary or fee-on-transfer stream tokens, which could lead to problems if they are allowed as streamTokens.</p>
      <h3 id="nibblerexpress">
        
        
          <a href="#nibblerexpress" class="anchor-heading" aria-labelledby="nibblerexpress"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> NibblerExpress
        
        
      </h3>
    
<p>I spent a bunch of my time running through the deposit and withdraw logic looking for attacks and manipulations, but I did not find much there.  The code appeared to be well written with the vulnerabilities tending to show up in the interactions with other Olympus/Ohm contracts or external contracts.  A more methodical approach to testing with a focus on ensuring that all states are correct after external interactions would be helpful.</p>
      <h2 id="about-yacademy">
        
        
          <a href="#about-yacademy" class="anchor-heading" aria-labelledby="about-yacademy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> About yAcademy
        
        
      </h2>
    
<p>yAcademy is an ecosystem initiative started by Yearn Finance and its ecosystem partners to bootstrap sustainable and collaborative blockchain security reviews and to nurture aspiring security talent.  yAcademy includes a fellowship program and a residents program.  In the fellowship program, fellows perform a series of periodic security reviews and presentations during the program.   Residents are past fellows who continue to gain experience by performing security reviews of contracts submitted to yAcademy for review (such as this contract).</p>
      <h2 id="appendix-and-faq">
        
        
          <a href="#appendix-and-faq" class="anchor-heading" aria-labelledby="appendix-and-faq"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Appendix and FAQ
        
        
      </h2>

        

        

        
        
          <hr>
          <footer>
            
              <p><a href="#top" id="back-to-top">Back to top</a></p>
            

            

            
              <div class="d-flex mt-2">
                
                
              </div>
            
          </footer>
        

      </div>
    </div>

    
      

      <div class="search-overlay"></div>
    
  </div>
  <link rel="image_src" href="https://yaudit.dev/assets/images/logo.png" />
</body>

  <script>
    var config = {}
;
    mermaid.initialize(config);
    window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
  </script>

</html>

